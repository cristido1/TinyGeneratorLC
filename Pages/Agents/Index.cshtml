@page
@model TinyGenerator.Pages.Agents.IndexModel
@{
    ViewData["Title"] = "Agents";
}

<div class="page-wrapper">
    <div class="d-flex mb-2 align-items-center toolbar-row">
        <input id="globalFilter" class="form-control form-control-sm" style="max-width:220px;" placeholder="Cerca..." />
        <div class="ms-auto d-flex gap-1">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Colonne visibili">
                    <i class="bi bi-layout-three-columns"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="agentsGridColVisMenu" style="min-width: 180px;"></ul>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">Refresh</button>
            <a class="btn btn-sm btn-primary" asp-page="./Create">Nuovo</a>
        </div>
    </div>

    <div id="agentsGrid" class="ag-theme-alpine" style="height: calc(100vh - 180px); width: 100%;"></div>
</div>

<!-- Story Generation Modal -->
<div class="modal fade" id="storyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Story</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="GenerateStory" id="storyForm">
                <div class="modal-body">
                    <input type="hidden" name="AgentId" id="modalAgentId" />
                    <div class="mb-3">
                        <label for="storyThemeInput" class="form-label">Story Theme</label>
                        <textarea class="form-control" id="storyThemeInput" name="StoryTheme" rows="3" placeholder="Describe the story theme..." required></textarea>
                        <div class="form-text">What should the story be about?</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Story</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        window.__agents_data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Agents));
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rowData = window.__agents_data || [];

            const columnDefs = [
                { headerName: 'Name', field: 'Name', flex: 1 },
                { headerName: 'Role', field: 'Role', width: 120 },
                { headerName: 'Model', field: 'ModelName', flex: 1, cellRenderer: p => p.value || p.data.ModelId || '' },
                { headerName: 'Temp', field: 'Temperature', width: 80, cellRenderer: p => p.value != null ? p.value.toFixed(2) : '-' },
                { headerName: 'TopP', field: 'TopP', width: 80, cellRenderer: p => p.value != null ? p.value.toFixed(2) : '-' },
                { headerName: 'Voice', field: 'VoiceName', width: 120, cellRenderer: p => p.value || p.data.VoiceId || '' },
                { headerName: 'Skills', field: 'Skills', flex: 1 },
                { headerName: 'JSON Format', field: 'JsonResponseFormat', width: 120, cellRenderer: p => p.value || '-' },
                {
                    headerName: 'Actions', colId: 'actions', width: 260, suppressColumnsToolPanel: true, pinned: 'right',
                    cellRenderer: params => {
                        const id = params.data.Id;
                        const name = params.data.Name;
                        const role = (params.data.Role || '').toLowerCase();
                        let generateBtn = '';
                        if (role === 'writer') {
                            generateBtn = `<button type="button" class="btn btn-sm btn-outline-success me-1 generate-story-btn" data-agent-id="${id}" data-agent-name="${escapeAttr(name)}"><i class="bi bi-pencil-square"></i></button>`;
                        }
                        return `
                            <a class="btn btn-sm btn-outline-primary me-1" href="/Agents/Edit?id=${id}">Edit</a>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-1 clone-btn" data-id="${id}">Duplica</button>
                            ${generateBtn}
                            <button type="button" class="btn btn-sm btn-outline-danger delete-btn" data-id="${id}">Delete</button>
                        `;
                    }
                }
            ];

            AgGridHelper.init('agentsGrid', columnDefs, rowData, {
                storageKey: 'agGrid_agents_colVis',
                pageSize: 25
            });

            // Quick filter
            document.getElementById('globalFilter')?.addEventListener('input', e => {
                window.agentsGridApi?.setQuickFilter(e.target.value);
            });

            // Grid click handlers
            document.getElementById('agentsGrid').addEventListener('click', e => {
                const cloneBtn = e.target.closest('.clone-btn');
                if (cloneBtn) {
                    const id = cloneBtn.dataset.id;
                    postAction('Clone', { id: id });
                }

                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (confirm('Are you sure you want to delete this agent?')) {
                        postAction('Delete', { id: id });
                    }
                }

                const generateBtn = e.target.closest('.generate-story-btn');
                if (generateBtn) {
                    const agentId = generateBtn.dataset.agentId;
                    const agentName = generateBtn.dataset.agentName;
                    document.getElementById('modalAgentId').value = agentId;
                    document.querySelector('#storyModal .modal-title').textContent = `Generate Story - ${agentName}`;
                    new bootstrap.Modal(document.getElementById('storyModal')).show();
                }
            });

            // Restore last theme from localStorage
            const STORAGE_KEY = 'lastStoryTheme';
            const storyThemeInput = document.getElementById('storyThemeInput');
            const lastTheme = localStorage.getItem(STORAGE_KEY);
            if (lastTheme && storyThemeInput) {
                storyThemeInput.value = lastTheme;
            }

            // Save theme on form submit
            const storyForm = document.getElementById('storyForm');
            if (storyForm) {
                storyForm.addEventListener('submit', () => {
                    const theme = storyThemeInput ? storyThemeInput.value.trim() : '';
                    if (theme) {
                        localStorage.setItem(STORAGE_KEY, theme);
                    }
                });
            }

            function postAction(handler, data) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `?handler=${handler}`;
                for (const key in data) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = data[key];
                    form.appendChild(input);
                }
                const token = document.querySelector('input[name=__RequestVerificationToken]');
                if (token) {
                    const tokenInput = document.createElement('input');
                    tokenInput.type = 'hidden';
                    tokenInput.name = '__RequestVerificationToken';
                    tokenInput.value = token.value;
                    form.appendChild(tokenInput);
                }
                document.body.appendChild(form);
                form.submit();
            }

            function escapeHtml(text) {
                if (!text) return '';
                return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"})[m]);
            }
            function escapeAttr(text) {
                return escapeHtml(text).replace(/'/g, '&#39;');
            }
        });
    </script>
}
