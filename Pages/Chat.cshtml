@page "{model?}"
@model ChatModel
@{
    ViewData["Title"] = "Chat AI";
}

<style>
    .chat-compact-container {
        padding: 12px 0;
        font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .chat-compact-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }

    .chat-card-compact {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 6px rgba(0,0,0,0.04);
    }

    .chat-messages-compact {
        height: 60vh;
        min-height: 300px;
        max-height: 70vh;
        overflow-y: auto;
        padding: 12px;
        background: #fafafa;
    }

    .msg {
        margin-bottom: 8px;
        padding: 8px 10px;
        border-radius: 10px;
        max-width: 75%;
        line-height: 1.35;
        font-size: 0.95rem;
        word-wrap: break-word;
    }

    .msg.user {
        background: #3b82f6;
        color: #fff;
        margin-left: auto;
    }

    .msg.assistant {
        background: #fff;
        border: 1px solid #e6e6e6;
        color: #222;
        margin-right: auto;
    }

    .msg.tool {
        background: #fff7ed;
        color: #57421a;
        border-left: 3px solid #f59e0b;
    }

    .msg-role {
        font-weight: 600;
        font-size: 0.75rem;
        opacity: 0.8;
        margin-bottom: 6px;
    }

    .chat-footer-compact {
        border-top: 1px solid #eee;
        padding: 8px;
        background: #fff;
    }

    .form-control.compact {
        padding: 6px 8px;
        font-size: 0.95rem;
    }

    .btn-sm-compact {
        padding: 6px 10px;
        font-size: 0.9rem;
    }

    .model-select-inline {
        margin-left: auto;
    }

    .small-info {
        font-size: 0.85rem;
        color: #6c757d;
        margin-left: 8px;
    }

    @@media (max-width: 767px) {
        .chat-messages-compact { height: 50vh; }
    }
</style>

<div class="chat-compact-container">
    <div class="container">
        <div class="chat-compact-header">
            <h5 class="mb-0">üí¨ Chat AI</h5>

            <form method="get" id="modelForm" class="model-select-inline d-flex align-items-center">
                <select class="form-select form-select-sm me-2" id="modelSelect" name="model" onchange="document.getElementById('modelForm').submit();">
                    <option value="">-- Seleziona Modello --</option>
                    @if (Model?.AvailableModels != null)
                    {
                        @foreach (var m in Model.AvailableModels)
                        {
                            if (m.Name == Model.SelectedModel)
                            {
                                <option value="@m.Name" selected>@m.Name</option>
                            }
                            else
                            {
                                <option value="@m.Name">@m.Name</option>
                            }
                        }
                    }
                </select>
                @if (!string.IsNullOrEmpty(Model?.SelectedModel) && Model?.SelectedModelInfo != null)
                {
                    <div class="small-info">@Model.SelectedModelInfo.Provider ‚Ä¢ @Model.SelectedModelInfo.MaxContext tokens</div>
                }
            </form>
        </div>

        <div class="chat-card-compact">
            <div class="chat-messages-compact" id="chatMessages">
                @if (Model?.ConversationHistory != null && Model.ConversationHistory.Any())
                {
                    @foreach (var msg in Model.ConversationHistory)
                    {
                        <div class="d-flex @(msg.Role == "user" ? "justify-content-end" : "justify-content-start")">
                            <div class="msg @msg.Role.ToLower()">
                                <div class="msg-role">
                                    @if (msg.Role == "user") { <span>üë§ Tu</span> }
                                    else if (msg.Role == "assistant") { <span>ü§ñ @Model.SelectedModel</span> }
                                    else if (msg.Role == "tool") { <span>üîß Tool</span> }
                                </div>
                                <div style="white-space: pre-wrap;">@msg.Content</div>
                            </div>
                        </div>
                    }
                }
                else if (!string.IsNullOrEmpty(Model?.SelectedModel))
                {
                    <div class="text-center py-4 text-muted">Nessun messaggio. Inizia la conversazione!</div>
                }
                else
                {
                    <div class="text-center py-4 text-muted">Seleziona un modello per iniziare.</div>
                }
            </div>

            @if (!string.IsNullOrEmpty(Model?.SelectedModel))
            {
                <div class="chat-footer-compact d-flex align-items-center">
                    <form method="post" asp-page-handler="SendMessage" asp-route-model="@Model.SelectedModel" class="w-100 d-flex gap-2">
                        @Html.AntiForgeryToken()
                        <input type="text" class="form-control compact" name="message" placeholder="Scrivi un messaggio..." required autocomplete="off" />
                        <button class="btn btn-primary btn-sm-compact" type="submit">Invia</button>
                        <button type="button" id="clearChatBtn" class="btn btn-outline-danger btn-sm-compact">üóëÔ∏è</button>
                    </form>
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger ms-2 mb-0">
                            <strong>‚ùå</strong> @TempData["Error"]
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();

    const clearBtn = document.getElementById('clearChatBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            const model = '@Model?.SelectedModel';
            if (confirm('Sei sicuro di voler cancellare tutta la cronologia della conversazione?')) {
                window.location.href = '/Chat/ClearChat?model=' + encodeURIComponent(model) + '&returnUrl=' + encodeURIComponent(window.location.pathname + window.location.search);
            }
        });
    }

    updateMessageCount();
});

function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

function updateMessageCount() {
    const messages = document.querySelectorAll('.msg');
    const countEl = document.getElementById('messageCount');
    if (countEl) { countEl.textContent = messages.length; }
}
</script>

