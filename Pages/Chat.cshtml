@page "{model?}"
@model ChatModel
@{
    ViewData["Title"] = "Chat AI";
}

<style>
    /* Animated gradient background */
    body {
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    .chat-page-container {
        min-height: 100vh;
        background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
        padding: 2rem 0;
    }

    @@keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* Inner container with clean white background */
    .chat-inner {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Modern typography */
    .chat-title {
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1.5rem;
    }

    /* Info sidebar */
    .info-sidebar {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 1.5rem;
        height: fit-content;
    }

    .info-sidebar h5 {
        color: #495057;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }

    .info-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }

    .info-item strong {
        color: #667eea;
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Model selector */
    .form-select {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem;
        font-size: 1rem;
        transition: border-color 0.2s;
        background: white;
    }

    .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }

    /* Chat messages area */
    .chat-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 1.5rem;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .chat-messages {
        background: #fafafa;
        padding: 1.5rem;
        height: 500px;
        overflow-y: auto;
    }

    .message {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 12px;
        max-width: 75%;
        word-wrap: break-word;
        line-height: 1.5;
    }

    .message.user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        text-align: left;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .message.assistant {
        background: white;
        color: #212529;
        margin-right: auto;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .message.tool {
        background: #fff3cd;
        color: #856404;
        font-size: 0.85rem;
        border-left: 4px solid #ffc107;
        margin: 0.5rem auto;
        max-width: 85%;
    }

    .message-role {
        font-weight: 600;
        font-size: 0.75rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.8;
    }

    /* Input area */
    .chat-footer {
        background: white;
        border-top: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
    }

    .chat-input-group {
        display: flex;
        gap: 0.5rem;
    }

    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: border-color 0.2s;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-danger {
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
    }

    /* Scrollbar styling */
    .chat-messages::-webkit-scrollbar {
        width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: #f1f3f5;
        border-radius: 4px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 4px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #adb5bd;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
</style>

<div class="chat-page-container">
    <div class="container">
        <div class="chat-inner">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3">
                    <div class="info-sidebar">
                        <h5>üîß Selezione Modello</h5>
                        <form method="get" id="modelForm">
                            <div class="mb-3">
                                <select class="form-select" id="modelSelect" name="model" onchange="document.getElementById('modelForm').submit();">
                                    <option value="">-- Seleziona Modello --</option>
                                    @if (Model?.AvailableModels != null)
                                    {
                                        @foreach (var m in Model.AvailableModels)
                                        {
                                            if (m.Name == Model.SelectedModel)
                                            {
                                                <option value="@m.Name" selected>@m.Name</option>
                                            }
                                            else
                                            {
                                                <option value="@m.Name">@m.Name</option>
                                            }
                                        }
                                    }
                                </select>
                            </div>
                        </form>

                        @if (!string.IsNullOrEmpty(Model?.SelectedModel) && Model?.SelectedModelInfo != null)
                        {
                            <h5 class="mt-4">‚ÑπÔ∏è Informazioni</h5>
                            <div class="info-item">
                                <strong>Provider</strong>
                                @Model.SelectedModelInfo.Provider
                            </div>
                            <div class="info-item">
                                <strong>Endpoint</strong>
                                @(string.IsNullOrEmpty(Model.SelectedModelInfo.Endpoint) ? "Default" : Model.SelectedModelInfo.Endpoint)
                            </div>
                            <div class="info-item">
                                <strong>Context</strong>
                                @Model.SelectedModelInfo.MaxContext tokens
                            </div>
                            <div class="info-item">
                                <strong>Messaggi</strong>
                                <span id="messageCount">@(Model.ConversationHistory?.Count ?? 0)</span>
                            </div>
                            
                            <button type="button" class="btn btn-danger btn-sm w-100 mt-3" id="clearChatBtn">
                                üóëÔ∏è Cancella Storia
                            </button>
                        }
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="col-md-9">
                    <div class="chat-card">
                        <div class="chat-header">
                            @if (string.IsNullOrEmpty(Model?.SelectedModel))
                            {
                                <span>‚è≥ In attesa della selezione del modello</span>
                            }
                            else
                            {
                                <span>üí¨ Chat con @Model.SelectedModel</span>
                            }
                        </div>

                        <div class="chat-messages" id="chatMessages">
                            @if (Model?.ConversationHistory != null && Model.ConversationHistory.Any())
                            {
                                @foreach (var msg in Model.ConversationHistory)
                                {
                                    <div class="d-flex @(msg.Role == "user" ? "justify-content-end" : "justify-content-start")">
                                        <div class="message @msg.Role.ToLower()">
                                            <div class="message-role">
                                                @if (msg.Role == "user")
                                                {
                                                    <span>üë§ Tu</span>
                                                }
                                                else if (msg.Role == "assistant")
                                                {
                                                    <span>ü§ñ @Model.SelectedModel</span>
                                                }
                                                else if (msg.Role == "tool")
                                                {
                                                    <span>üîß Tool</span>
                                                }
                                            </div>
                                            <div style="white-space: pre-wrap;">@msg.Content</div>
                                        </div>
                                    </div>
                                }
                            }
                            else if (!string.IsNullOrEmpty(Model?.SelectedModel))
                            {
                                <div class="empty-state">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                    <p>Nessun messaggio. Inizia la conversazione!</p>
                                </div>
                            }
                        </div>

                        @if (!string.IsNullOrEmpty(Model?.SelectedModel))
                        {
                            <div class="chat-footer">
                                <form method="post" asp-page-handler="SendMessage" asp-route-model="@Model.SelectedModel">
                                    @Html.AntiForgeryToken()
                                    <div class="chat-input-group">
                                        <input type="text" class="form-control" name="message" 
                                               placeholder="Scrivi un messaggio..." required autocomplete="off" />
                                        <button class="btn btn-primary" type="submit">
                                            Invia
                                        </button>
                                    </div>
                                </form>
                                @if (TempData["Error"] != null)
                                {
                                    <div class="alert alert-danger mt-2 mb-0">
                                        <strong>‚ùå Errore:</strong> @TempData["Error"]
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-scroll to bottom on page load
    scrollToBottom();

    // Clear chat button
    const clearBtn = document.getElementById('clearChatBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            const model = '@Model?.SelectedModel';
            if (confirm('Sei sicuro di voler cancellare tutta la cronologia della conversazione?')) {
                window.location.href = '/Chat/ClearChat?model=' + encodeURIComponent(model) + '&returnUrl=' + encodeURIComponent(window.location.pathname + window.location.search);
            }
        });
    }
    
    // Update message count
    updateMessageCount();
});

function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

function updateMessageCount() {
    const messages = document.querySelectorAll('.message');
    const countEl = document.getElementById('messageCount');
    if (countEl) {
        countEl.textContent = messages.length;
    }
}
</script>
