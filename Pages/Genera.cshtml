@page
@model GeneraModel
@{
    ViewData["Title"] = "Genera storia";
}

<h1>Genera una storia lunga</h1>

<div class="note-card" style="max-width:900px; margin-bottom:18px">
    <form id="genForm">
        @Html.AntiForgeryToken()
        <div style="margin-bottom:10px">
            <label for="Prompt" class="note-title">Inserisci il prompt della storia</label>
            <input class="keep-input" type="text" id="Prompt" name="Prompt" value="@Model.Prompt" required />
        </div>
        <div id="genError" role="alert" style="color:#b00020; margin-bottom:8px; display:none"></div>

        <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px">
            <div style="display:flex; align-items:center; gap:8px;">
                <label for="Writer" class="note-title" style="margin:0">Scegli writer</label>
                <select id="Writer" name="Writer" class="keep-input" style="width:220px; padding:8px">
                    <option value="All">Tutti (A, B, C)</option>
                    <option value="A">Writer A (Planner)</option>
                    <option value="B">Writer B (FreePlanner)</option>
                    <option value="C">Writer C (Single-shot)</option>
                </select>
            </div>

            <div style="margin-left:auto">
                <button type="button" id="startBtn" class="action-btn primary" style="font-weight:600; padding:8px 14px">Avvia generazione</button>
            </div>
        </div>
    </form>
</div>

<hr />
<h2>Stato generazione (live):</h2>
<div id="statusArea">
    <pre id="statusPre">Pronto.</pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/%40microsoft/signalr@7.0.11/dist/browser/signalr.min.js"></script>
<script>
    const startBtn = document.getElementById('startBtn');
    const statusPre = document.getElementById('statusPre');
    let pollInterval = null;
    let connection = null;

    // helper: fetch and render history for a genId
    async function loadHistory(id) {
        try {
            const p = await fetch(`?handler=progress&id=${encodeURIComponent(id)}`);
            if (!p.ok) return;
            const js = await p.json();
            statusPre.textContent = js.messages.join('\n');
            if (js.completed) {
                statusPre.textContent += '\n\nâœ… Completato.';
                if (js.result) statusPre.textContent += '\n\nRisultato finale (estratto):\n' + js.result.substring(0,1000);
            }
        } catch (e) { console.error(e); }
    }

    // open a SignalR connection and join a group for genId
    async function connectSignalRAndJoin(genId) {
        try {
            if (!window.signalR) {
                console.warn('SignalR not available');
                return;
            }
            connection = new signalR.HubConnectionBuilder().withUrl('/progressHub').withAutomaticReconnect().build();

            connection.on('ProgressAppended', (id, message) => {
                if (id !== genId) return;
                // append message
                statusPre.textContent += (statusPre.textContent ? '\n' : '') + message;
            });
            connection.on('ProgressCompleted', (id, finalResult) => {
                if (id !== genId) return;
                statusPre.textContent += '\n\nâœ… Completato.';
                if (finalResult) statusPre.textContent += '\n\nRisultato finale (estratto):\n' + (finalResult.substring ? finalResult.substring(0,1000) : finalResult);
            });

            await connection.start();
            await connection.invoke('JoinGroup', genId);
        } catch (e) { console.error('SignalR connect error', e); }
    }

    startBtn.addEventListener('click', async () => {
        const prompt = document.getElementById('Prompt').value;
        const genError = document.getElementById('genError');
        if (!prompt || prompt.trim().length === 0) {
            if (genError) {
                genError.textContent = 'Inserisci il prompt';
                genError.style.display = 'block';
            }
            document.getElementById('Prompt').focus();
            return;
        } else if (genError) {
            genError.textContent = '';
            genError.style.display = 'none';
        }

        statusPre.textContent = 'ðŸŸ¡ Avvio...';
    // send start request (include antiforgery token automatically by using the form)
    const form = document.getElementById('genForm');
    const fd = new FormData(form);
    const res = await fetch('?handler=start', { method: 'POST', body: fd });
        if (!res.ok) {
            const text = await res.text();
            statusPre.textContent = 'Errore avvio: ' + text;
            return;
        }
        const data = await res.json();
        const id = data.id;
        // persist last gen id so user can come back to page and reconnect
        try { localStorage.setItem('lastGenId', id); } catch { }
        statusPre.textContent = 'ðŸŸ¢ Generazione avviata. id: ' + id + '\n\n';
        // load history and start SignalR for live updates
        await loadHistory(id);
        await connectSignalRAndJoin(id);
    });

    // on page load, if there's a lastGenId in localStorage, reattach to it (so the page is persistent)
    (async () => {
        try {
            const existing = localStorage.getItem('lastGenId');
            if (existing) {
                statusPre.textContent = 'ðŸ”„ Ricollegamento alla generazione ' + existing + '...\n\n';
                await loadHistory(existing);
                await connectSignalRAndJoin(existing);
            }
        } catch (e) { console.error(e); }
    })();
    // hide error when user edits prompt
    const promptInput = document.getElementById('Prompt');
    if (promptInput) {
        promptInput.addEventListener('input', () => {
            const genError = document.getElementById('genError');
            if (genError) { genError.textContent = ''; genError.style.display = 'none'; }
        });
    }
</script>