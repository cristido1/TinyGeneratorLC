@page
@model TinyGenerator.Pages.IndexModel
@{
    ViewData["Title"] = "TinyGenerator";
}

<style>
    .kpi-card {
        background: #f8f9fa;
        border: 2px solid #343a40;
        border-radius: 12px;
        padding: 1.5rem;
        color: #212529;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .kpi-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1.1;
        color: #212529;
    }
    .kpi-label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #6c757d;
    }
    .kpi-icon {
        font-size: 2rem;
        color: #6c757d;
    }
    .ranking-table {
        background: #f8f9fa;
        border: 2px solid #343a40;
        border-radius: 12px;
        overflow: hidden;
    }
    .ranking-table th {
        background: #e9ecef;
        color: #495057;
        font-weight: 500;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border: none;
    }
    .ranking-table td {
        background: #f8f9fa;
        color: #212529;
        border-color: #dee2e6;
        vertical-align: middle;
    }
    .ranking-table tbody tr:hover td {
        background: #e9ecef;
    }
    .rank-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        font-weight: 600;
        font-size: 0.85rem;
    }
    .rank-1 { background: #ffd700; color: #000; }
    .rank-2 { background: #c0c0c0; color: #000; }
    .rank-3 { background: #cd7f32; color: #fff; }
    .rank-other { background: #f1f3f5; color: #495057; }
    .score-badge {
        background: #e9ecef;
        border: 1px solid #adb5bd;
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        font-weight: 600;
        color: #212529;
    }
    .section-title {
        color: #495057;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #343a40;
    }
</style>

<div class="container-fluid px-4">
    <!-- KPI Cards Row -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="kpi-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="kpi-value">@Model.TotalStories</div>
                        <div class="kpi-label mt-1">Storie Totali</div>
                    </div>
                    <i class="bi bi-journal-text kpi-icon"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card medium">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="kpi-value">@Model.EnabledModels<span style="font-size: 1.2rem; opacity: 0.6;">/@(Model.EnabledModels + Model.DisabledModels)</span></div>
                        <div class="kpi-label mt-1">Modelli Attivi</div>
                    </div>
                    <i class="bi bi-cpu kpi-icon"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card light">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="kpi-value">@Model.DisabledModels</div>
                        <div class="kpi-label mt-1">Modelli Disabilitati</div>
                    </div>
                    <i class="bi bi-pause-circle kpi-icon"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="kpi-value">@Model.AudioMasterGeneratedCount</div>
                        <div class="kpi-label mt-1">Audio Master Ready</div>
                    </div>
                    <i class="bi bi-music-note-beamed kpi-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Rankings Row -->
    <div class="row g-4">
        <!-- Top Writers -->
        <div class="col-lg-6">
            <div class="section-title">
                <i class="bi bi-trophy me-2"></i>Classifica Scrittori (per valutazione media)
            </div>
            <div class="ranking-table">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Agente</th>
                            <th>Modello</th>
                            <th class="text-center">Storie</th>
                            <th class="text-end">Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.TopWriters.Any())
                        {
                            var rank = 0;
                            foreach (var writer in Model.TopWriters)
                            {
                                rank++;
                                var rankClass = rank switch { 1 => "rank-1", 2 => "rank-2", 3 => "rank-3", _ => "rank-other" };
                                <tr>
                                    <td><span class="rank-badge @rankClass">@rank</span></td>
                                    <td>@writer.AgentName</td>
                                    <td><small class="text-muted">@writer.ModelName</small></td>
                                    <td class="text-center">@writer.StoryCount</td>
                                    <td class="text-end"><span class="score-badge">@((writer.AvgScore * 100.0 / 40.0).ToString("F1"))</span></td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="5" class="text-center text-muted py-3">Nessun dato disponibile</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top Stories -->
        <div class="col-lg-6">
            <div class="section-title">
                <i class="bi bi-star me-2"></i>Top 10 Storie (per valutazione)
            </div>
            <div class="ranking-table">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Prompt</th>
                            <th>Modello</th>
                            <th class="text-end">Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.TopStories.Any())
                        {
                            var rank = 0;
                            foreach (var story in Model.TopStories)
                            {
                                rank++;
                                var rankClass = rank switch { 1 => "rank-1", 2 => "rank-2", 3 => "rank-3", _ => "rank-other" };
                                        <tr>
                                            <td><span class="rank-badge @rankClass">@rank</span></td>
                                            <td>
                                                @if (story.GeneratedMixedAudio)
                                                {
                                                    <button type="button" class="btn btn-sm btn-link p-0 me-2 play-final-mix-btn" data-story-id="@story.Id" title="Play final mix"><i class="bi bi-play-circle-fill" style="color:#0d6efd;font-size:1.25rem;"></i></button>
                                                }
                                                <a href="/Stories/Details/@story.Id" class="text-decoration-none" style="color: #9cf;">
                                                    @story.Title
                                                </a>
                                            </td>
                                            <td><small class="text-muted">@story.Agent</small></td>
                                            <td class="text-end"><span class="score-badge">@((story.AvgEvalScore * 100.0 / 40.0).ToString("F1")) /100</span></td>
                                        </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="4" class="text-center text-muted py-3">Nessun dato disponibile</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal per riprodurre final mix dalla home -->
<div class="modal fade" id="finalMixModal" tabindex="-1" aria-labelledby="finalMixModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="finalMixModalLabel">Riproduci Final Mix</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <audio id="homeFinalMixAudio" controls preload="none" style="width:100%;">
                    Il tuo browser non supporta l'audio.
                </audio>
                <div id="finalMixInfo" class="mt-2 text-muted small"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function(){
        document.addEventListener('click', function(e){
            var btn = e.target.closest && e.target.closest('.play-final-mix-btn');
            if (!btn) return;
            var storyId = btn.getAttribute('data-story-id');
            if (!storyId) return;
            e.preventDefault();
            var audio = document.getElementById('homeFinalMixAudio');
            var info = document.getElementById('finalMixInfo');
            audio.pause();
            audio.src = '/Stories/Index?handler=FinalMixAudio&id=' + encodeURIComponent(storyId);
            audio.load();
            info.textContent = 'Caricamento...';
            var modalEl = document.getElementById('finalMixModal');
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
            audio.onloadedmetadata = function(){
                info.textContent = 'Durata: ' + Math.floor((audio.duration||0)/60) + 'm ' + Math.round((audio.duration||0)%60) + 's';
                audio.play().catch(()=>{});
            };
            audio.onerror = function(){ info.textContent = 'Impossibile caricare l\'audio.'; };
            modalEl.addEventListener('hidden.bs.modal', function(){ audio.pause(); audio.removeAttribute('src'); audio.load(); info.textContent=''; }, { once: true });
        });
    })();
</script>
