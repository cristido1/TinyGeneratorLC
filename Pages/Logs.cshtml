@page
@model TinyGenerator.Pages.LogsModel
@{
    ViewData["Title"] = "Logs";
}

<div class="d-flex align-items-center mb-3">
    <h3 class="me-auto">Log applicazione</h3>
    <form method="post" asp-page-handler="Clear" onsubmit="return confirm('Sei sicuro di cancellare tutti i log? Questa azione Ã¨ irreversibile.');">
        <button type="submit" class="btn btn-sm btn-danger">Cancella tutti i log</button>
    </form>
    
</div>

<form method="get" class="mb-2 d-flex gap-2 align-items-center">
    <label class="form-check-label"><input type="checkbox" id="onlyErrors" name="onlyErrors" value="true" class="form-check-input me-1" />Mostra solo errori</label>
    <label class="ms-2">Livello:</label>
    <select name="level" class="form-select form-select-sm" style="width:140px;">
        <option value="">(qualsiasi)</option>
        <option>Trace</option>
        <option>Debug</option>
        <option>Information</option>
        <option>Warning</option>
        <option>Error</option>
        <option>Critical</option>
    </select>
    <label class="ms-2">Categoria:</label>
    <input name="category" type="text" class="form-control form-control-sm" style="width:180px;" placeholder="Filtra per categoria" />
    <label class="ms-2">Pagina:</label>
    <input type="number" name="page" min="1" value="@Model.CurrentPage" class="form-control form-control-sm" style="width:80px;" />
    <label class="ms-2">Per pagina:</label>
    <select id="pageSize" name="pageSize" class="form-select form-select-sm" style="width:100px;">
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="500">500</option>
    </select>
    <button type="submit" class="btn btn-sm btn-primary ms-2">Applica</button>
    <div class="ms-auto text-muted">Totale righe: @Model.TotalCount</div>
</form>

<div class="table-responsive" style="overflow-x:auto;">
    <table class="table table-sm table-hover" style="min-width:900px;">
        <thead>
            <tr>
                <th>#</th>
                <th>Timestamp (UTC)</th>
                <th>Livello</th>
                <th>Categoria</th>
                <th>Messaggio</th>
                <th>Exception</th>
            </tr>
        </thead>
        <tbody>
        @if (Model.Logs.Count == 0)
        {
            <tr><td colspan="6" class="text-muted">Nessun log trovato.</td></tr>
        }
        else
        {
            foreach (var l in Model.Logs)
            {
                var isError = string.Equals(l.Level, "Error", System.StringComparison.OrdinalIgnoreCase) || !string.IsNullOrWhiteSpace(l.Exception);
                <tr class="@(isError ? "log-error-row" : "")">
                    <td>@l.Id</td>
                    <td>@l.Ts</td>
                    <td>@l.Level</td>
                    <td>@l.Category</td>
                    <td><pre style="white-space:pre-wrap; margin:0;">@l.Message</pre></td>    
                </tr>
                <tr col="6">
                    <td><small>@l.Exception</small></td>
                </tr>
            }
        }
        </tbody>
    </table>
</div>

<nav aria-label="Logs pagination" class="mt-2">
    <ul class="pagination pagination-sm">
        <li class="page-item @(Model.CurrentPage<=1?"disabled":"")">
            <a class="page-link" href="?page=@(Model.CurrentPage-1)&pageSize=@Model.PageSize@(Model.OnlyErrors?"&onlyErrors=true":"")">Previous</a>
        </li>
        <li class="page-item disabled"><span class="page-link">Pagina @Model.CurrentPage / @Model.TotalPages</span></li>
        <li class="page-item @(Model.CurrentPage>=Model.TotalPages?"disabled":"")">
            <a class="page-link" href="?page=@(Model.CurrentPage+1)&pageSize=@Model.PageSize@(Model.OnlyErrors?"&onlyErrors=true":"")">Next</a>
        </li>
    </ul>
</nav>

<script>
    // initialize controls
    try {
        document.getElementById('pageSize').value = '@Model.PageSize';
        document.getElementById('onlyErrors').checked = @Model.OnlyErrors.ToString().ToLower();
        // ensure page input has a minimum of 1
        var pageInput = document.querySelector('input[name="page"]');
        if (pageInput) { if (!pageInput.value) pageInput.value = '@Model.CurrentPage'; }
        // restore category and level values from query if present
        try { var lvl = new URLSearchParams(location.search).get('level'); if (lvl) document.querySelector('select[name="level"]').value = lvl; } catch(e){}
        try { var cat = new URLSearchParams(location.search).get('category'); if (cat) document.querySelector('input[name="category"]').value = cat; } catch(e){}
    } catch(e) { console.error(e); }
</script>
