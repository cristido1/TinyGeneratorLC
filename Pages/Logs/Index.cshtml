@page
@model TinyGenerator.Pages.Logs.LogsModel
@{
    ViewData["Title"] = "Logs";
    ViewData["PageDescription"] = "Visualizza e gestisci i log dell'applicazione";
}
<!-- Hidden buttons for JS handlers -->
<button type="button" id="btnExportSelected" style="display:none;" disabled></button>
<button type="button" id="btnClearAllLogs" style="display:none;"></button>

<div id="selectedThreadInfo" class="alert alert-info d-none">
    Selezionato: <strong>ThreadId <span id="selectedThreadIdDisplay"></span></strong>
    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="btnClearSelection">Deseleziona</button>
</div>

<form id="filterForm" class="row g-2 align-items-center mb-3">
    <div class="col-auto form-check">
        <input class="form-check-input" type="checkbox" id="onlyResultCheckbox" />
        <label class="form-check-label" for="onlyResultCheckbox">Solo log con result</label>
    </div>
    <div class="col-auto form-check">
        <input class="form-check-input" type="checkbox" id="onlyModelCheckbox" checked />
        <label class="form-check-label" for="onlyModelCheckbox">Solo request/response</label>
    </div>
</form>

@if (!string.IsNullOrEmpty(Model.StatusMessage))
{
    <div class="alert alert-info">@Model.StatusMessage</div>
}

<table id="logsTable" class="table table-bordered table-sm table-pastel table-compact datatable">
    <thead>
        <tr>
            <!-- details-control column (official DataTables row details style) -->
            <th style="width:38px;"></th>
            <th>Timestamp</th>
            <th>Level</th>
            <th>Source</th>
            <th>Result</th>
            <th>Fail Reason</th>
            <th>Operazione</th>
            <th>ThreadId</th>
            <th>StoryId</th>
            <th>AgentName</th>
            <th>Message</th>
            <th>Azioni</th>
        </tr>
    </thead>
    <tbody>
    @foreach (var log in Model.LogEntries)
    {
            var src = (log.Source ?? string.Empty).ToLowerInvariant();
            var msg = (log.Message ?? string.Empty).ToLowerInvariant();
            var chat = (log.ChatText ?? string.Empty).ToLowerInvariant();
            bool isModelSource = src.Contains("ollama") || src.Contains("openai") || src.Contains("model") || src.Contains("llm") || src.Contains("ai") || src.Contains("llama");
            bool isRequest = false;
            bool isResponse = false;
            if (isModelSource)
            {
                if (msg.Contains("request") || msg.Contains("prompt") || msg.Contains("sending") || msg.Contains("calling") || chat.Contains("prompt") ) isRequest = true;
                if (msg.Contains("response") || msg.Contains("result") || msg.Contains("choices") || msg.Contains("output") || chat.Contains("response") || chat.Contains("output")) isResponse = true;
            }

            var rowClass = "";
            if (isRequest) rowClass = "log-model-request";
            else if (isResponse) rowClass = "log-model-response";

        <tr class="@rowClass" data-id="@log.Id"
            data-source="@log.Source"
            data-ts="@log.Ts" 
            data-threadid="@(log.ThreadId ?? 0)" 
            data-storyid="@(log.StoryId.HasValue ? log.StoryId.Value.ToString() : string.Empty)"
            data-threadscope="@log.ThreadScope"
            data-analized="@log.Analized"
            data-agentname="@log.AgentName" 
            data-state="@log.State" 
            data-context="@log.Context" 
            data-exception="@log.Exception">
            <td class="details-control text-center" title="Mostra dettagli"><button class="btn btn-sm btn-outline-secondary" type="button">+</button></td>
            <td class="timestamp">@log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
            <td class="level">@log.Level</td>
            <td class="source">
                @if(log.Source == "ModelResponse"){
                    <span class="badge bg-warning"><i class="bi bi-chevron-left"></i> Response</span>
                } else if(log.Source == "ModelRequest"){
                    <span class="badge bg-success">Request <i class="bi bi-chevron-right"></i></span>
                } else{
                    <span>@log.Source</span>
                }
            </td>
            <td class="result">
                @if (!string.IsNullOrWhiteSpace(log.Result))
                {
                    var resUpper = log.Result.Trim().ToUpperInvariant();
                    var badgeClass = resUpper == "SUCCESS" ? "bg-success" : (resUpper == "FAILED" ? "bg-warning text-dark" : "bg-secondary");
                    <span class="badge @badgeClass">@resUpper</span>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </td>
            <td class="failreason">@(!string.IsNullOrWhiteSpace(log.ResultFailReason) ? log.ResultFailReason : "-")</td>
            <td class="operation">@(!string.IsNullOrWhiteSpace(log.ThreadScope) ? log.ThreadScope : "-")</td>
            <td class="threadid">@(log.ThreadId.HasValue && log.ThreadId.Value > 0 ? log.ThreadId.Value.ToString() : "-")</td>
            <td class="storyid">@(log.StoryId.HasValue && log.StoryId.Value > 0 ? log.StoryId.Value.ToString() : "-")</td>
            <td class="agentname">@(!string.IsNullOrWhiteSpace(log.AgentName) ? log.AgentName : "-")</td>
            <td class="message"><span class="text-muted">Premi + per caricare il messaggio</span></td>
            <td class="actions" style="white-space:nowrap;">
                <button type="button" class="btn btn-sm btn-outline-secondary btn-analyze me-1">Analizza</button>
                @if (log.Analized)
                {
                    <a class="btn btn-sm btn-outline-primary" asp-page="/Logs/Analysis" asp-route-threadId="@(log.ThreadId ?? 0)">Vedi analisi</a>
                }
            </td>
        </tr>
    }
    </tbody>
</table>

<form id="analyzeForm" method="post" asp-page-handler="Analyze" class="d-none">
    <input type="hidden" name="threadId" />
    <input type="hidden" name="threadScope" />
</form>

<form id="analyzeAllForm" method="post" asp-page-handler="AnalyzeMissing" class="d-none"></form>

<form id="clearLogsForm" method="post" asp-page-handler="ClearAllLogs" class="d-none">
</form>

@section Styles {
    <link rel="stylesheet" href="~/css/datatable-pastel-compact.css" />
    <style>
        /* Highlight model requests (pastel green) and responses (pastel yellow) */
        .log-model-request {
            background-color: #e9f7ec !important; /* pastel green */
        }
        .log-model-request td {
            background-color: transparent !important;
        }
        .log-model-request td.message {
            background-color: rgba(34,139,34,0.06) !important;
            border-left: 4px solid rgba(34,139,34,0.14);
        }

        .log-model-response {
            background-color: #fffbe6 !important; /* pastel yellow */
        }
        .log-model-response td {
            background-color: transparent !important;
        }
        .log-model-response td.message {
            background-color: rgba(255,193,7,0.06) !important;
            border-left: 4px solid rgba(255,193,7,0.14);
        }

        /* Slightly bolder text for message cells containing model payloads */
        .log-model-request td.message, .log-model-response td.message {
            font-weight: 500;
        }

        .log-content-highlight {
            background: #ffe599;
            border-radius: 2px;
            padding: 0 2px;
            font-weight: 600;
        }
    </style>
}

@section Scripts {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" />
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
    <style>
        .log-row-selected {
            background-color: #e7f3ff !important;
            border-left: 3px solid #0d6efd;
        }
        .log-row-selectable {
            cursor: pointer;
        }
    </style>
    <script>
        $(function () {
            var selectedThreadId = null;
            var onlyModelCheckbox = $('#onlyModelCheckbox');
            var table = $('#logsTable').DataTable({
                order: [[1, 'desc']], // timestamp column is now index 1 (0 = details control)
                pageLength: 25,
                responsive: false, // using explicit row().child for details
                columnDefs: [
                    { orderable: false, targets: 0 }, // details control column not sortable
                    { responsivePriority: 1, targets: 1 }, // Timestamp always visible
                    { responsivePriority: 2, targets: 2 }, // Level always visible
                    { responsivePriority: 3, targets: 4 }, // Result
                    { responsivePriority: 4, targets: 5 }, // Fail Reason
                    { responsivePriority: 5, targets: 6 }, // Operation
                    { responsivePriority: 6, targets: 7 }, // ThreadId
                    { responsivePriority: 7, targets: 8 }, // StoryId
                    { responsivePriority: 8, targets: 9 }, // AgentName
                    { responsivePriority: 9, targets: 10 }, // Message
                    { responsivePriority: 10, targets: 3 }, // Source
                    { orderable: false, targets: 11 }      // Actions
                ],
                dom: "<'row'<'col-sm-6'B><'col-sm-6'f>>" +
                     "rt" +
                     "<'row'<'col-sm-6'i><'col-sm-6'p>>",
                buttons: [
                    {
                        text: 'Chat Log',
                        className: 'btn btn-light btn-sm',
                        action: function(e, dt, node, config) {
                            window.location.href = '/ChatLog/Index';
                        }
                    },
                    {
                        text: 'Export Selected',
                        className: 'btn btn-light btn-sm',
                        action: function(e, dt, node, config) {
                            $('#btnExportSelected').click();
                        },
                        init: function(dt, node, config) {
                            $(node).prop('disabled', !selectedThreadId);
                        }
                    },
                    {
                        text: 'Export All',
                        className: 'btn btn-light btn-sm',
                        action: function(e, dt, node, config) {
                            window.location.href = '?handler=Export';
                        }
                    },
                    {
                        text: 'Clear All',
                        className: 'btn btn-light btn-sm',
                        action: function(e, dt, node, config) {
                            $('#btnClearAllLogs').click();
                        }
                    },
                    {
                        text: 'Analyze',
                        className: 'btn btn-light btn-sm',
                        action: function(e, dt, node, config) {
                            $('<form method="post" action="?handler=AnalyzeMissing"><input type="hidden" name="__RequestVerificationToken" value="' + $('input[name=__RequestVerificationToken]').val() + '" /></form>').appendTo('body').submit();
                        }
                    },
                    {
                        extend: 'colvis',
                        text: 'Columns',
                        className: 'btn btn-light btn-sm'
                    }
                ],
                stateSave: true,
                stateSaveName: 'DataTables_logs',
                stateDuration: -1
            });

            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                if (!onlyModelCheckbox.prop('checked')) return true;
                var row = table.row(dataIndex).node();
                if (!row) return true;
                var source = row.getAttribute('data-source');
                return source === 'ModelResponse' || source === 'ModelRequest';
            });
            table.draw();

            // Build details HTML for a row - message is fetched lazily from server
            function decodeEscapes(s) {
                if (!s) return '';
                // Convert common escaped sequences \r\n, \n, \r, \t
                var out = s.replace(/\\r\\n/g, '\n').replace(/\\n/g, '\n').replace(/\\r/g, '\n').replace(/\\t/g, '\t');
                // Decode unicode sequences like \u00E8
                out = out.replace(/\\u([0-9a-fA-F]{4})/g, function(match, grp) { return String.fromCharCode(parseInt(grp, 16)); });
                // Decode hex escapes like \xE8
                out = out.replace(/\\x([0-9a-fA-F]{2})/g, function(match, grp) { return String.fromCharCode(parseInt(grp, 16)); });
                return out;
            }

            // escape for safe HTML insertion (we keep newlines intact inside <pre>)
            function htmlEscape(str) {
                if (!str) return '';
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }

            function formatLogDetailsFromMessage(message) {
                var decoded = decodeEscapes(message || '');
                var safe = htmlEscape(decoded);
                safe = safe.replace(/\bcontent\b/gi, function(match) {
                    return '<span class="log-content-highlight">' + match + '</span>';
                });
                var html = '<div style="padding:8px 12px;font-size:0.95rem;color:#222;background:#f8f9fa;border-radius:4px;">';
                html += '<pre style="white-space:pre-wrap;word-break:break-word;background:#fff;border:1px solid #ddd;padding:8px;margin:0;border-radius:3px;max-height:420px;overflow:auto;">' + safe + '</pre>';
                html += '</div>';
                return html;
            }

            // Use the official DataTables row().child API for details collapse/expand
            $('#logsTable tbody').on('click', 'td.details-control button', function () {
                var btn = $(this);
                var tr = btn.closest('tr');
                var row = table.row(tr);
                var logId = tr.data('id');

                if (row.child.isShown()) {
                    // Close
                    row.child.hide();
                    tr.removeClass('shown');
                    btn.text('+');
                } else {
                    // Open: fetch message lazily from server
                    btn.prop('disabled', true);
                    $.ajax({
                        url: '?handler=Message&id=' + encodeURIComponent(logId),
                        method: 'GET',
                        success: function (data) {
                            var msg = (data && data.message) ? data.message : '';
                            row.child(formatLogDetailsFromMessage(msg)).show();
                            tr.addClass('shown');
                            btn.text('−');
                        },
                        error: function () {
                            row.child(formatLogDetailsFromMessage('Impossibile caricare il messaggio')).show();
                            tr.addClass('shown');
                            btn.text('−');
                        },
                        complete: function () { btn.prop('disabled', false); }
                    });
                }
            });

            $('#logsTable').on('click', '.btn-analyze', function (evt) {
                evt.preventDefault();
                evt.stopPropagation();
                var tr = $(this).closest('tr');
                var threadId = tr.data('threadid');
                var scope = tr.data('threadscope');
                var form = $('#analyzeForm');
                form.find('input[name="threadId"]').val(threadId);
                form.find('input[name="threadScope"]').val(scope);
                form.trigger('submit');
            });

            // Filter by presence of Result badge
            $('#onlyResultCheckbox').on('change', function() {
                if (this.checked) {
                    table.column('.result').search('.+', true, false).draw();
                } else {
                    table.column('.result').search('').draw();
                }
            });
            // Filter by model request/response sources
            onlyModelCheckbox.on('change', function() {
                table.draw();
            });


            $('#btnClearAllLogs').on('click', function() {
                if (confirm('Sei sicuro di voler cancellare TUTTI i log e le relative analisi? Questa operazione è irreversibile.')) {
                    $('#clearLogsForm').trigger('submit');
                }
            });

            // Row selection for ThreadId filtering
            $('#logsTable tbody').on('click', 'tr', function(evt) {
                // Ignore clicks on buttons and details control
                if ($(evt.target).closest('button, .btn').length > 0) return;
                if ($(evt.target).closest('.details-control').length > 0) return;
                
                var tr = $(this);
                var threadId = tr.data('threadid');
                
                if (!threadId || threadId === 0) {
                    return;
                }
                
                // Deselect all rows
                $('#logsTable tbody tr').removeClass('log-row-selected');
                
                // Select this row
                tr.addClass('log-row-selected');
                selectedThreadId = threadId;
                
                // Update UI
                $('#selectedThreadIdDisplay').text(threadId);
                $('#selectedThreadInfo').removeClass('d-none');
                $('#btnExportSelected').prop('disabled', false);
            });

            $('#btnClearSelection').on('click', function() {
                $('#logsTable tbody tr').removeClass('log-row-selected');
                selectedThreadId = null;
                $('#selectedThreadInfo').addClass('d-none');
                $('#btnExportSelected').prop('disabled', true);
            });

            $('#btnExportSelected').on('click', function() {
                if (selectedThreadId) {
                    window.location.href = '?handler=Export&threadId=' + selectedThreadId;
                }
            });

            // Add selectable class to rows
            $('#logsTable tbody tr').addClass('log-row-selectable');
        });
    </script>
}

