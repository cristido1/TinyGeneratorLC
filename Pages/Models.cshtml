@page
@model TinyGenerator.Pages.ModelsModel
@{
    ViewData["Title"] = "Models";
}

<div class="page-wrapper">
    <div class="d-flex mb-2 align-items-center toolbar-row">
        <input id="globalFilter" class="form-control form-control-sm" style="max-width:220px;" placeholder="Cerca..." />
        <select id="groupSelect" class="form-select form-select-sm ms-2" style="max-width:180px;">
            @foreach(var g in Model.TestGroups ?? new System.Collections.Generic.List<string>())
            {
                <option value="@g">@g</option>
            }
        </select>
        <label class="form-check form-check-inline ms-2 mb-0">
            <input id="showDisabledCheckbox" class="form-check-input" type="checkbox" @(Model.ShowDisabled ? "checked" : "") />
            <span class="form-check-label small">Mostra disabilitati</span>
        </label>
        <div class="ms-auto d-flex gap-1 flex-wrap">
            <button id="runGroupBtn" class="btn btn-sm btn-outline-success" title="Run Group"><i class="bi bi-play-fill"></i> Group</button>
            <button id="runAllBtn" class="btn btn-sm btn-outline-primary" title="Run All"><i class="bi bi-collection-play"></i> All</button>
            <button id="purgeBtn" class="btn btn-sm btn-outline-warning" title="Purge Disabled"><i class="bi bi-trash3"></i> Purge</button>
            <button id="refreshCtxBtn" class="btn btn-sm btn-outline-secondary" title="Refresh Contexts"><i class="bi bi-arrow-repeat"></i> Ctx</button>
            <button id="discoverBtn" class="btn btn-sm btn-outline-info" title="Discover Ollama"><i class="bi bi-search"></i> Discover</button>
            <button id="recalcBtn" class="btn btn-sm btn-outline-secondary" title="Recalc Scores"><i class="bi bi-calculator"></i> Recalc</button>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Colonne visibili">
                    <i class="bi bi-layout-three-columns"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="modelsGridColVisMenu" style="min-width: 180px;"></ul>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">Refresh</button>
            <a class="btn btn-sm btn-primary" href="/Models/Edit">Nuovo</a>
        </div>
    </div>

    <div id="modelsGrid" class="ag-theme-alpine" style="height: calc(100vh - 180px); width: 100%;"></div>
</div>

@section Scripts {
    <script>
        window.__models_data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Models));
        window.__test_groups = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TestGroups ?? new System.Collections.Generic.List<string>()));
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rowData = window.__models_data || [];
            const testGroups = window.__test_groups || [];

            function renderScore(val, hasResults) {
                if (!hasResults) return '-';
                return val > 0 ? val.toFixed(1) : '0';
            }

            function providerBadge(provider) {
                if (!provider) return '<span class="badge bg-secondary">-</span>';
                const p = provider.toLowerCase();
                if (p === 'ollama') return '<span class="badge bg-success">ollama</span>';
                if (p === 'openai') return '<span class="badge bg-warning text-dark">openai</span>';
                return `<span class="badge bg-secondary">${escapeHtml(provider)}</span>`;
            }

            const columnDefs = [
                { headerName: 'Name', field: 'Name', flex: 2, wrapText: true, autoHeight: true, cellClass: 'text-wrap' },
                { headerName: 'Provider', field: 'Provider', width: 100, cellRenderer: p => providerBadge(p.value) },
                { headerName: 'Note', field: 'Note', flex: 1 },
                { headerName: 'Local', field: 'IsLocal', width: 70, cellRenderer: p => p.value ? 'Yes' : 'No' },
                { headerName: 'MaxCtx', field: 'MaxContext', width: 90, type: 'numericColumn' },
                { headerName: 'CtxToUse', field: 'ContextToUse', width: 95, type: 'numericColumn' },
                { headerName: 'Total', field: 'TotalScore', width: 70, type: 'numericColumn', cellRenderer: p => renderScore(p.value, p.data.TestDurationSeconds > 0) },
                { headerName: 'Base', field: 'BaseScore', width: 70, type: 'numericColumn', cellRenderer: p => renderScore(p.value, p.data.TestDurationSeconds > 0) },
                { headerName: 'TextEval', field: 'TextEvalScore', width: 80, type: 'numericColumn', cellRenderer: p => renderScore(p.value, p.data.TestDurationSeconds > 0) },
                { headerName: 'Writer', field: 'WriterScore', width: 70, type: 'numericColumn', cellRenderer: p => renderScore(p.value, p.data.TestDurationSeconds > 0) },
                { headerName: 'TTS', field: 'TtsScore', width: 60, type: 'numericColumn', cellRenderer: p => renderScore(p.value, p.data.TestDurationSeconds > 0) },
                { headerName: 'Music', field: 'MusicScore', width: 70, type: 'numericColumn', cellRenderer: p => renderScore(p.value, p.data.TestDurationSeconds > 0) },
                { headerName: 'FX', field: 'FxScore', width: 60, type: 'numericColumn', cellRenderer: p => renderScore(p.value, p.data.TestDurationSeconds > 0) },
                { headerName: 'Ambient', field: 'AmbientScore', width: 80, type: 'numericColumn', cellRenderer: p => renderScore(p.value, p.data.TestDurationSeconds > 0) },
                { headerName: 'NoTools', field: 'NoTools', width: 80, cellRenderer: p => p.value ? '' : '' },
                { headerName: 'Duration', field: 'TestDurationSeconds', width: 90, type: 'numericColumn', cellRenderer: p => p.value ? p.value.toFixed(2) : '-' },
                { headerName: 'Cost In', field: 'CostInPerToken', width: 85, type: 'numericColumn', cellRenderer: p => (p.value || 0).toFixed(5) },
                { headerName: 'Cost Out', field: 'CostOutPerToken', width: 90, type: 'numericColumn', cellRenderer: p => (p.value || 0).toFixed(5) },
                {
                    headerName: 'Actions', colId: 'actions', width: 200, suppressColumnsToolPanel: true, pinned: 'right',
                    cellRenderer: params => {
                        const name = params.data.Name;
                        const encodedName = encodeURIComponent(name);
                        let groupItems = testGroups.map(g => 
                            `<li><a class="dropdown-item run-model-group" href="#" data-model="${escapeAttr(name)}" data-group="${escapeAttr(g)}">${escapeHtml(g)}</a></li>`
                        ).join('');
                        return `
                            <div class="btn-group" role="group">
                                <a class="btn btn-sm btn-outline-secondary" href="/Models/Edit?name=${encodedName}">Edit</a>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">Run</button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="/Chat?model=${encodedName}"> Chat</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item run-model-all" href="#" data-model="${escapeAttr(name)}">All tests</a></li>
                                        ${groupItems}
                                    </ul>
                                </div>
                            </div>`;
                    }
                }
            ];

            // Master-detail for test results
            const detailCellRendererParams = {
                detailGridOptions: {
                    columnDefs: [
                        { headerName: 'Group', field: 'group', flex: 1 },
                        { headerName: 'Passed', field: 'passed', width: 80 },
                        { headerName: 'Failed', field: 'failed', width: 80 },
                        { headerName: 'Score', field: 'score', width: 80 },
                        { headerName: 'Duration', field: 'duration', width: 100 }
                    ],
                    defaultColDef: { sortable: true, resizable: true }
                },
                getDetailRowData: params => {
                    const modelName = params.data.Name;
                    fetch(`/api/test-automation/model/${encodeURIComponent(modelName)}/groups`)
                        .then(r => r.json())
                        .then(data => params.successCallback(data || []))
                        .catch(() => params.successCallback([]));
                }
            };

            AgGridHelper.init('modelsGrid', columnDefs, rowData, {
                storageKey: 'agGrid_models_colVis',
                pageSize: 50,
                masterDetail: true,
                detailCellRendererParams: detailCellRendererParams,
                detailRowAutoHeight: true
            });

            // Quick filter
            document.getElementById('globalFilter')?.addEventListener('input', e => {
                window.modelsGridApi?.setQuickFilter(e.target.value);
            });

            // Show disabled toggle
            document.getElementById('showDisabledCheckbox')?.addEventListener('change', e => {
                const url = new URL(window.location.href);
                url.searchParams.set('showDisabled', e.target.checked);
                window.location.href = url.toString();
            });

            // Toolbar buttons
            document.getElementById('runGroupBtn')?.addEventListener('click', () => {
                const grp = document.getElementById('groupSelect')?.value;
                if (!grp) { alert('Seleziona un gruppo'); return; }
                postAction('RunGroup', { groupName: grp });
            });

            document.getElementById('runAllBtn')?.addEventListener('click', () => {
                if (!confirm('Run all tests?')) return;
                postAction('RunAll', {});
            });

            document.getElementById('purgeBtn')?.addEventListener('click', () => {
                if (!confirm('Purge disabled Ollama models?')) return;
                postAction('PurgeDisabledOllama', {});
            });

            document.getElementById('refreshCtxBtn')?.addEventListener('click', () => {
                postAction('RefreshContexts', {});
            });

            document.getElementById('discoverBtn')?.addEventListener('click', () => {
                postAction('DiscoverOllama', {});
            });

            document.getElementById('recalcBtn')?.addEventListener('click', () => {
                postAction('RecalculateScores', {});
            });

            // Grid click handlers for dropdown items
            document.getElementById('modelsGrid').addEventListener('click', e => {
                const runAllLink = e.target.closest('.run-model-all');
                if (runAllLink) {
                    e.preventDefault();
                    const model = runAllLink.dataset.model;
                    postAction('RunModelAll', { modelName: model });
                }

                const runGroupLink = e.target.closest('.run-model-group');
                if (runGroupLink) {
                    e.preventDefault();
                    const model = runGroupLink.dataset.model;
                    const group = runGroupLink.dataset.group;
                    postAction('RunModelGroup', { modelName: model, groupName: group });
                }
            });

            function postAction(handler, data) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `?handler=${handler}`;
                for (const key in data) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = data[key];
                    form.appendChild(input);
                }
                const token = document.querySelector('input[name=__RequestVerificationToken]');
                if (token) {
                    const tokenInput = document.createElement('input');
                    tokenInput.type = 'hidden';
                    tokenInput.name = '__RequestVerificationToken';
                    tokenInput.value = token.value;
                    form.appendChild(tokenInput);
                }
                document.body.appendChild(form);
                form.submit();
            }

            function escapeHtml(text) {
                if (!text) return '';
                return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"})[m]);
            }
            function escapeAttr(text) {
                return escapeHtml(text).replace(/'/g, '&#39;');
            }
        });
    </script>
}
