@page
@model TinyGenerator.Pages.OllamaMonitorModel
@{
    ViewData["Title"] = "Ollama Monitor";
    ViewData["PageDescription"] = "Monitora i modelli Ollama in esecuzione";
}

<div class="d-flex align-items-center mb-2">
    <div class="me-2">
        <form method="get" class="d-flex" style="gap:.5rem;">
            <input name="search" value="" class="form-control form-control-sm" placeholder="Cerca..." />
            <button type="submit" class="btn btn-sm btn-outline-primary">Cerca</button>
        </form>
    </div>
    <div class="ms-auto d-flex align-items-center" style="gap:.5rem;">
        <button id="refreshBtn" class="btn btn-sm btn-primary">Aggiorna</button>
        <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="colsMenu" data-bs-toggle="dropdown">Colonne</button>
            <ul class="dropdown-menu" aria-labelledby="colsMenu"></ul>
        </div>
    </div>
</div>

<div class="border p-2 rounded">
    <table class="table table-sm mb-0">
        <thead>
            <tr>
                <th data-col="name">Name</th>
                <th data-col="id">Id</th>
                <th data-col="size">Size</th>
                <th data-col="processor">Processor</th>
                <th data-col="context">Context</th>
                <th data-col="until">Until</th>
                <th data-col="actions">Actions</th>
                <th data-col="lastPrompt">Last prompt (preview)</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Models != null && Model.Models.Count > 0)
            {
                foreach (var m in Model.Models)
                {
                    <tr>
                        <td data-col="name">@m.Name</td>
                        <td data-col="id">@m.Id</td>
                        <td data-col="size">@m.Size</td>
                        <td data-col="processor">@m.Processor</td>
                        <td data-col="context">@m.Context</td>
                        <td data-col="until">@((DateTime.TryParse(m.Until, out var dt)) ? dt.ToString("dd/MM/yyyy HH:mm") : (!string.IsNullOrWhiteSpace(m.Until) ? m.Until : "-"))</td>
                        <td data-col="actions">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-secondary dropdown-toggle" data-bs-toggle="dropdown">Azioni</button>
                                <div class="dropdown-menu p-2">
                                    <div class="input-group input-group-sm mb-2">
                                        <input type="number" min="512" step="512" value="8192" class="form-control context-input" data-model="@m.Name" style="width:120px;" />
                                        <button class="btn btn-sm btn-outline-primary start-with-context" data-model="@m.Name">Start</button>
                                    </div>
                                    <a href="#" class="dropdown-item preview-link" data-model="@m.Name">Preview prompt</a>
                                </div>
                            </div>
                        </td>
                        <td data-col="lastPrompt"><button class="btn btn-sm btn-link preview-btn" data-model="@m.Name">Preview</button></td>
                    </tr>
                }
            }
            else
            {
                <tr><td colspan="8">No models running</td></tr>
            }
        </tbody>
    </table>
</div>

<div id="pager" class="mt-2"></div>

<div class="border p-2 rounded mt-3">
    <h6 class="mb-2">Llama.cpp status</h6>
    <div class="small text-muted mb-2">Endpoint: @Model.LlamaStatus.Endpoint</div>
    <div class="mb-2">
        <span class="badge @(Model.LlamaStatus.IsRunning ? "bg-success" : "bg-secondary")">
            @(Model.LlamaStatus.IsRunning ? "Running" : "Not running")
        </span>
        @if (!string.IsNullOrWhiteSpace(Model.LlamaStatus.Error))
        {
            <span class="ms-2 text-danger">Error: @Model.LlamaStatus.Error</span>
        }
    </div>
    <div class="mb-2">
        <button id="killLlamaBtn" class="btn btn-sm btn-outline-danger">Kill llama.cpp</button>
    </div>
    @if (Model.LlamaStatus.Models.Count > 0)
    {
        <div class="small">
            <strong>Models:</strong> @string.Join(", ", Model.LlamaStatus.Models)
        </div>
    }
    else
    {
        <div class="small text-muted">No model info available.</div>
    }
</div>

<script src="/js/shared/list-ui.js"></script>
<script>
    // Minimal wiring: preview and start actions for server-side rendered rows
    async function fetchAllModelsJson() {
        try {
            const res = await fetch('/OllamaMonitor?handler=Models');
            if (!res.ok) return [];
            return await res.json();
        } catch (e) { console.error(e); return []; }
    }

    async function showPromptForModel(modelName) {
        const models = await fetchAllModelsJson();
        const m = models.find(x => x.name === modelName);
        const p = m ? (m.lastPrompt || '') : '';
        showInfo('Prompt Preview', p || 'No prompt recorded');
    }

    document.getElementById('refreshBtn').addEventListener('click', async () => {
        // simple refresh: reload the page to let server re-render
        location.reload();
    });

    const killBtn = document.getElementById('killLlamaBtn');
    if (killBtn) {
        killBtn.addEventListener('click', async () => {
            const confirmed = (typeof showConfirm === 'function')
                ? await showConfirm('Kill llama.cpp', 'Stop llama-server.exe?')
                : confirm('Stop llama-server.exe?');
            if (!confirmed) return;
            try {
                killBtn.disabled = true;
                const res = await fetch('/OllamaMonitor?handler=KillLlama', { method: 'POST' });
                const j = await res.json();
                const msg = j.output || (j.success ? 'Stopped' : 'Failed');
                if (j.success) {
                    if (typeof showSuccess === 'function') showSuccess('Completed', msg);
                    else alert(msg);
                } else {
                    if (typeof showError === 'function') showError('Error', msg);
                    else alert(msg);
                }
            } catch (err) {
                const fallbackMsg = 'Error stopping llama.cpp: ' + err;
                if (typeof showError === 'function') showError('Error', fallbackMsg);
                else alert(fallbackMsg);
            } finally {
                killBtn.disabled = false;
            }
        });
    }

    document.querySelectorAll('.preview-btn, .preview-link').forEach(b => {
        b.addEventListener('click', async e => {
            e.preventDefault();
            const model = e.currentTarget.getAttribute('data-model');
            await showPromptForModel(model);
        });
    });

    document.querySelectorAll('.start-with-context').forEach(btn => {
        btn.addEventListener('click', async e => {
            const model = btn.getAttribute('data-model');
            const tr = btn.closest('tr');
            const input = tr.querySelector('.context-input');
            const contextVal = parseInt(input.value) || 8192;
            const confirmed = await showConfirm('Start Model', `Start model ${model} with context ${contextVal}? This may use significant resources.`);
            if (!confirmed) return;
            try {
                btn.disabled = true; btn.innerText = 'Starting...';
                const res = await fetch('/OllamaMonitor?handler=StartWithContext', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: model, context: contextVal })
                });
                const j = await res.json();
                showSuccess('Completed', 'Start command completed. Output:\n' + (j.runOutput || j.stopOutput || JSON.stringify(j)));
            } catch (err) {
                showError('Error', 'Error starting model: ' + err);
            } finally { btn.disabled = false; btn.innerText = 'Start'; }
        });
    });
</script>
