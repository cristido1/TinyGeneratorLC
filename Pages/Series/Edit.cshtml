@page
@model TinyGenerator.Pages.Series.EditModel
@{
    ViewData["Title"] = Model.IsEditMode ? "Modifica Serie" : "Crea Serie";
    var activeTab = Model.ActiveTab ?? "series";
}

<div class="alert alert-info">
    <strong>Struttura Serie:</strong> I campi sono divisi in due categorie:
    <ul class="mb-0 mt-2">
        <li><strong>Filtraggio/Catalogo:</strong> brevi, per cercare e classificare (Titolo, Genere, Periodo, Tono, Target, Lingua)</li>
        <li><strong>Generazione Episodi:</strong> testuali e strutturati, passati al writer AI (Ambientazione Base, Premessa, Arco Narrativo, Stile, Regole, Note AI)</li>
    </ul>
    <p class="mt-2 mb-0"><em>I personaggi principali possono essere gestiti nella sezione dedicata piu sotto.</em></p>
</div>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}
@if (TempData["StatusMessage"] != null)
{
    <div class="alert alert-success">@TempData["StatusMessage"]</div>
}

<ul class="nav nav-tabs" id="seriesTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "series" ? "active" : "")" id="tab-series-btn" data-bs-toggle="tab" data-bs-target="#tab-series" type="button" role="tab" aria-controls="tab-series" aria-selected="@(activeTab == "series")">Serie</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "characters" ? "active" : "")" id="tab-characters-btn" data-bs-toggle="tab" data-bs-target="#tab-characters" type="button" role="tab" aria-controls="tab-characters" aria-selected="@(activeTab == "characters")" @(Model.IsEditMode ? "" : "disabled")>Personaggi</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "episodes" ? "active" : "")" id="tab-episodes-btn" data-bs-toggle="tab" data-bs-target="#tab-episodes" type="button" role="tab" aria-controls="tab-episodes" aria-selected="@(activeTab == "episodes")" @(Model.IsEditMode ? "" : "disabled")>Episodi</button>
    </li>
</ul>

<div class="tab-content pt-3" id="seriesTabsContent">
    <div class="tab-pane fade @(activeTab == "series" ? "show active" : "")" id="tab-series" role="tabpanel" aria-labelledby="tab-series-btn">
        <form method="post">
            <input type="hidden" asp-for="SeriesItem.Id" />
            <div asp-validation-summary="All" class="text-danger"></div>
            
            <!-- SEZIONE 1: CAMPI DI FILTRAGGIO / CATALOGO -->
            <h4 class="mt-4 mb-3 text-primary">Campi di Filtraggio / Catalogo</h4>
            
            <div class="row mb-3">
                <div class="col-md-12">
                    <label asp-for="SeriesItem.Titolo" class="form-label">
                        Titolo <span class="text-danger">*</span>
                        <small class="text-muted">(es. "Frontiera di Cenere", "Il Sale e il Ferro")</small>
                    </label>
                    <input asp-for="SeriesItem.Titolo" class="form-control" maxlength="200" required />
                    <span asp-validation-for="SeriesItem.Titolo" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label asp-for="SeriesItem.Genere" class="form-label">
                        Genere
                        <small class="text-muted">(es. Fantascienza, Storico, Fantasy)</small>
                    </label>
                    <input asp-for="SeriesItem.Genere" class="form-control" maxlength="100" />
                    <span asp-validation-for="SeriesItem.Genere" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="SeriesItem.Sottogenere" class="form-label">
                        Sottogenere
                        <small class="text-muted">(es. Militare, Dramma, Space Opera)</small>
                    </label>
                    <input asp-for="SeriesItem.Sottogenere" class="form-control" maxlength="100" />
                    <span asp-validation-for="SeriesItem.Sottogenere" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="SeriesItem.PeriodoNarrativo" class="form-label">
                        Periodo Narrativo
                        <small class="text-muted">(es. Futuro lontano, Medioevo, Et� moderna)</small>
                    </label>
                    <input asp-for="SeriesItem.PeriodoNarrativo" class="form-control" maxlength="100" />
                    <span asp-validation-for="SeriesItem.PeriodoNarrativo" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label asp-for="SeriesItem.TonoBase" class="form-label">
                        Tono Base
                        <small class="text-muted">(es. Cupo, Realistico, Avventuroso)</small>
                    </label>
                    <input asp-for="SeriesItem.TonoBase" class="form-control" maxlength="100" />
                    <span asp-validation-for="SeriesItem.TonoBase" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="SeriesItem.Target" class="form-label">
                        Target
                        <small class="text-muted">(es. Adulto, Young Adult)</small>
                    </label>
                    <input asp-for="SeriesItem.Target" class="form-control" maxlength="50" />
                    <span asp-validation-for="SeriesItem.Target" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="SeriesItem.Lingua" class="form-label">
                        Lingua
                        <small class="text-muted">(es. Italiano, English)</small>
                    </label>
                    <input asp-for="SeriesItem.Lingua" class="form-control" maxlength="50" value="Italiano" />
                    <span asp-validation-for="SeriesItem.Lingua" class="text-danger"></span>
                </div>
            </div>

            <!-- SEZIONE 2: CAMPI PER GENERAZIONE EPISODI -->
            <h4 class="mt-5 mb-3 text-success">Campi per Generazione Episodi (Prompt Writer)</h4>
            <p class="text-muted mb-3">Questi campi vengono passati al writer AI per generare ogni episodio. Devono essere stabili e non cambiare tra episodi.</p>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label asp-for="SeriesItem.AmbientazioneBase" class="form-label">
                        Ambientazione Base
                        <small class="text-muted d-block">Contiene SOLO elementi stabili del mondo (periodo, tecnologia, societ�, politica). NON inserire personaggi o eventi specifici.</small>
                    </label>
                    <textarea asp-for="SeriesItem.AmbientazioneBase" class="form-control font-monospace" rows="8" 
                              placeholder="Esempio:&#10;Periodo: anno 3050&#10;Umanit�:&#10;- Civilt� interstellare attiva&#10;- Motore FTL disponibile da circa 100 anni&#10;Tecnologia:&#10;- Viaggi FTL affidabili ma costosi&#10;- Armi avanzate con limiti fisici credibili"></textarea>
                    <span asp-validation-for="SeriesItem.AmbientazioneBase" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label asp-for="SeriesItem.ImagesStyle" class="form-label">
                        Images Style
                        <small class="text-muted d-block">Stringa opzionale che verrà passata al generatore di immagini come prefisso del prompt (es. "fotografico, luce cinematografica, realistico").</small>
                    </label>
                    <input asp-for="SeriesItem.ImagesStyle" class="form-control" />
                    <span asp-validation-for="SeriesItem.ImagesStyle" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label asp-for="SeriesItem.PremessaSerie" class="form-label">
                        Premessa Serie
                        <small class="text-muted d-block">Il concetto centrale della serie, la sua "filosofia" di base.</small>
                    </label>
                    <textarea asp-for="SeriesItem.PremessaSerie" class="form-control" rows="3"
                              placeholder="Esempio: L'umanit� ha conquistato le stelle ma ha perso l'illusione di essere invincibile. Ogni espansione porta nuovi conflitti e dilemmi morali."></textarea>
                    <span asp-validation-for="SeriesItem.PremessaSerie" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label asp-for="SeriesItem.ArcoNarrativoSerie" class="form-label">
                        Arco Narrativo Serie
                        <small class="text-muted d-block">La direzione complessiva della storia attraverso tutti gli episodi.</small>
                    </label>
                    <textarea asp-for="SeriesItem.ArcoNarrativoSerie" class="form-control" rows="3"
                              placeholder="Esempio: Dal periodo di espansione fiduciosa alla scoperta di una minaccia sistemica che mette in crisi la sopravvivenza della civilt� umana."></textarea>
                    <span asp-validation-for="SeriesItem.ArcoNarrativoSerie" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label asp-for="SeriesItem.StileScrittura" class="form-label">
                        Stile Scrittura
                        <small class="text-muted d-block">Indicazioni su tono narrativo, ritmo, dialoghi, descrizioni.</small>
                    </label>
                    <textarea asp-for="SeriesItem.StileScrittura" class="form-control" rows="3"
                              placeholder="Esempio: Tecnico ma leggibile, dialoghi asciutti, attenzione alla vita di bordo, niente eroismi gratuiti."></textarea>
                    <span asp-validation-for="SeriesItem.StileScrittura" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label asp-for="SeriesItem.RegoleNarrative" class="form-label">
                        Regole Narrative
                        <small class="text-muted d-block">Vincoli e limiti per mantenere coerenza (es. "niente tecnologia magica", "ogni decisione ha conseguenze").</small>
                    </label>
                    <textarea asp-for="SeriesItem.RegoleNarrative" class="form-control" rows="4"
                              placeholder="Esempio:&#10;- Niente tecnologia magica&#10;- Ogni decisione ha conseguenze&#10;- Niente distruzione gratuita di pianeti abitati"></textarea>
                    <span asp-validation-for="SeriesItem.RegoleNarrative" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label asp-for="SeriesItem.SerieFinalGoal" class="form-label">
                        Final Goal della Serie
                        <small class="text-muted d-block">Obiettivo finale/risoluzione attesa dell'arco complessivo della serie.</small>
                    </label>
                    <textarea asp-for="SeriesItem.SerieFinalGoal" class="form-control" rows="2"
                              placeholder="Esempio: La flotta trova un modo sostenibile di coesistere con la minaccia, pagando un prezzo morale."></textarea>
                    <span asp-validation-for="SeriesItem.SerieFinalGoal" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label asp-for="SeriesItem.NoteAI" class="form-label">
                        Note AI (Campo Jolly)
                        <small class="text-muted d-block">Istruzioni temporanee o sperimentali per il writer AI.</small>
                    </label>
                    <textarea asp-for="SeriesItem.NoteAI" class="form-control" rows="2"
                              placeholder="Esempio: Privilegiare tensione psicologica rispetto all'azione continua."></textarea>
                    <span asp-validation-for="SeriesItem.NoteAI" class="text-danger"></span>
                </div>
            </div>

            <!-- SEZIONE 3: PIANIFICAZIONE (STRATEGICO/TATTICO) -->
            <h4 class="mt-5 mb-3 text-warning">Pianificazione (Planner)</h4>
            <p class="text-muted mb-3">Metodo strategico (planner_method) per la serie e grammatica tattica (tipo_planning) di default per gli episodi.</p>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label asp-for="SeriesItem.PlannerMethodId" class="form-label">
                        Planner Method (Strategico)
                        <small class="text-muted d-block">Definisce il framework globale della serie (es. Save the Cat, Hero Journey).</small>
                    </label>
                    <select asp-for="SeriesItem.PlannerMethodId" class="form-select">
                        <option value="">-- Nessuno --</option>
                        @foreach (var m in Model.PlannerMethods)
                        {
                            <option value="@m.Id">@m.Code@(string.IsNullOrWhiteSpace(m.Description) ? "" : " - " + m.Description)</option>
                        }
                    </select>
                    <span asp-validation-for="SeriesItem.PlannerMethodId" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="SeriesItem.DefaultTipoPlanningId" class="form-label">
                        Tipo Planning di default (Tattico)
                        <small class="text-muted d-block">Grammatica degli stati (AZIONE/STASI/ERRORE/EFFETTO) usata se l'episodio non sovrascrive.</small>
                    </label>
                    <select asp-for="SeriesItem.DefaultTipoPlanningId" class="form-select">
                        <option value="">-- Nessuno --</option>
                        @foreach (var t in Model.TipoPlannings)
                        {
                            <option value="@t.Id">@t.Nome (@t.Codice)</option>
                        }
                    </select>
                    <span asp-validation-for="SeriesItem.DefaultTipoPlanningId" class="text-danger"></span>
                </div>
            </div>
                <div class="row mb-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Default narrative profile</label>
                        <select class="form-select" asp-for="SeriesItem.DefaultNarrativeProfileId">
                            <option value="">(none)</option>
                            @foreach (var p in Model.NarrativeProfiles)
                            {
                                <option value="@p.Id">@p.Name</option>
                            }
                        </select>
                        <div class="form-text">Used by the state-driven Narrative Engine when starting a new story for this series.</div>
                    </div>
                </div>

            <!-- SEZIONE 3: METADATI -->
            <h4 class="mt-5 mb-3 text-secondary">Metadati</h4>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label asp-for="SeriesItem.EpisodiGenerati" class="form-label">Episodi Generati</label>
                    <input asp-for="SeriesItem.EpisodiGenerati" type="number" class="form-control" min="0" />
                    <span asp-validation-for="SeriesItem.EpisodiGenerati" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="SeriesItem.DataInserimento" class="form-label">Data Inserimento</label>
                    <input asp-for="SeriesItem.DataInserimento" type="datetime-local" class="form-control" />
                    <span asp-validation-for="SeriesItem.DataInserimento" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3">
                <button type="submit" class="btn btn-primary btn-lg">Salva Serie</button>
                <a class="btn btn-secondary btn-lg" asp-page="./Index">Annulla</a>
            </div>
        </form>
    </div>

    <div class="tab-pane fade @(activeTab == "characters" ? "show active" : "")" id="tab-characters" role="tabpanel" aria-labelledby="tab-characters-btn">
        @if (Model.IsEditMode)
        {
            <h4 class="mb-2 text-primary">Personaggi Serie</h4>
            <p class="text-muted mb-2">Gestisci i personaggi ricorrenti della serie.</p>
            <div asp-validation-summary="All" class="text-danger"></div>

            <div class="card p-2 mb-3">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-1">
                    <div>
                        <div class="fw-semibold">Assegnazione automatica voci</div>
                        <div class="text-muted small">Usa solo voci non narratore, abbina per genere e evita duplicati nella serie.</div>
                    </div>
                    <div class="d-flex gap-1">
                        <form method="post" asp-page-handler="GenerateCharacterImages">
                            <input type="hidden" name="seriesId" value="@Model.SeriesItem.Id" />
                            <button type="submit" class="btn btn-sm btn-outline-secondary" onclick="return confirm('Generare le immagini mancanti dei personaggi?');">Genera immagini personaggi</button>
                        </form>
                        <form method="post" asp-page-handler="AssignCharacterVoices">
                            <input type="hidden" name="seriesId" value="@Model.SeriesItem.Id" />
                            <button type="submit" class="btn btn-sm btn-outline-secondary" onclick="return confirm('Assegnare automaticamente le voci ai personaggi senza voce?');">Assegna voci automaticamente</button>
                        </form>
                    </div>
                </div>
            </div>

            <form method="post" asp-page-handler="AddCharacter" enctype="multipart/form-data" class="card p-2 mb-3">
                <input type="hidden" name="CharacterInput.SerieId" value="@Model.SeriesItem.Id" />
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Nome</label>
                        <input name="CharacterInput.Name" class="form-control" maxlength="200" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Genere</label>
                        <select name="CharacterInput.Gender" class="form-select" required>
                            <option value="male">male</option>
                            <option value="female">female</option>
                            <option value="alien">alien</option>
                            <option value="robot">robot</option>
                            <option value="other" selected>other</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">Voce TTS</label>
                        <div class="input-group">
                            <select name="CharacterInput.VoiceId" class="form-select voice-select-add" data-voices='@System.Text.Json.JsonSerializer.Serialize(Model.Voices.Select(v => new { v.Id, v.TemplateWav }))'>
                                <option value="">-</option>
                                @foreach (var v in Model.Voices)
                                {
                                    var label = string.IsNullOrWhiteSpace(v.Name) ? v.VoiceId : $"{v.Name} ({v.VoiceId})";
                                    <option value="@v.Id">@label</option>
                                }
                            </select>
                            <button type="button" class="btn btn-outline-secondary play-voice-btn-add" title="Ascolta esempio voce" disabled>
                                <i class="bi bi-play-fill"></i>
                            </button>
                        </div>
                        <audio class="voice-preview-audio-add d-none"></audio>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Descrizione</label>
                        <textarea name="CharacterInput.Description" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Aspetto (prompt immagine)</label>
                        <textarea name="CharacterInput.Aspect" class="form-control" rows="2" placeholder="Se compilato, viene usato per generare l'immagine al posto della descrizione."></textarea>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Eta</label>
                        <input name="CharacterInput.Eta" class="form-control" maxlength="50" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Formazione</label>
                        <input name="CharacterInput.Formazione" class="form-control" maxlength="200" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Specializzazione</label>
                        <input name="CharacterInput.Specializzazione" class="form-control" maxlength="200" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Profilo</label>
                        <textarea name="CharacterInput.Profilo" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Conflitto Interno</label>
                        <textarea name="CharacterInput.ConflittoInterno" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Episodio In</label>
                        <input name="CharacterInput.EpisodeIn" type="number" class="form-control" min="0" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Episodio Out</label>
                        <input name="CharacterInput.EpisodeOut" type="number" class="form-control" min="0" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Immagine</label>
                        <input type="file" name="CharacterImage" class="form-control" accept=".jpg,.jpeg,.png,.gif,.webp" />
                    </div>
                </div>
                <div class="mt-2">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Aggiungi Personaggio</button>
                </div>
            </form>

            @if (Model.SeriesCharacters.Any())
            {
                @foreach (var c in Model.SeriesCharacters)
                {
                    var vd = new Microsoft.AspNetCore.Mvc.ViewFeatures.ViewDataDictionary(ViewData);
                    vd["Voices"] = Model.Voices;
                    @await Html.PartialAsync("_SeriesCharacter", c, vd)
                }
            }
            else
            {
                <div class="text-muted">Nessun personaggio presente.</div>
            }
        }
        else
        {
            <div class="alert alert-warning">Salva la serie per aggiungere personaggi.</div>
        }
    </div>

    <div class="tab-pane fade @(activeTab == "episodes" ? "show active" : "")" id="tab-episodes" role="tabpanel" aria-labelledby="tab-episodes-btn">
        @if (Model.IsEditMode)
        {
            <h4 class="mb-3 text-primary">Episodi Serie</h4>
            <p class="text-muted">Gestisci gli episodi della serie con titolo e trama.</p>
            <div asp-validation-summary="All" class="text-danger"></div>

            <form method="post" asp-page-handler="AddEpisode" class="card p-3 mb-4">
                <input type="hidden" name="EpisodeInput.SerieId" value="@Model.SeriesItem.Id" />
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">Numero</label>
                        <input name="EpisodeInput.Number" type="number" class="form-control" min="1" required />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Titolo</label>
                        <input name="EpisodeInput.Title" class="form-control" maxlength="200" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Initial phase</label>
                        <select name="EpisodeInput.InitialPhase" class="form-select">
                            <option value="">(vuoto)</option>
                            <option value="AZIONE">azione</option>
                            <option value="STASI">stasi</option>
                            <option value="ERRORE">errore</option>
                            <option value="EFFETTO">effetto</option>
                        </select>
                        <div class="form-text">Valori ammessi: azione, stasi, errore, effetto</div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tipo Planning (override)</label>
                        <select name="EpisodeInput.TipoPlanningId" class="form-select">
                            <option value="">(usa default serie)</option>
                            @foreach (var t in Model.TipoPlannings)
                            {
                                <option value="@t.Id">@t.Nome (@t.Codice)</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Start situation</label>
                        <textarea name="EpisodeInput.StartSituation" class="form-control" rows="2" placeholder="Situazione iniziale dell'episodio"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Episode goal</label>
                        <textarea name="EpisodeInput.EpisodeGoal" class="form-control" rows="2" placeholder="Obiettivo dell'episodio"></textarea>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Trama</label>
                        <textarea name="EpisodeInput.Trama" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-outline-primary">Aggiungi Episodio</button>
                </div>
            </form>

            @if (Model.SeriesEpisodes.Any())
            {
                @foreach (var e in Model.SeriesEpisodes)
                {
                    <form method="post" asp-page-handler="UpdateEpisode" class="card mb-3 p-3">
                        <input type="hidden" name="EpisodeInput.Id" value="@e.Id" />
                        <input type="hidden" name="EpisodeInput.SerieId" value="@e.SerieId" />
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label class="form-label">Numero</label>
                                <input name="EpisodeInput.Number" type="number" class="form-control" min="1" value="@e.Number" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Titolo</label>
                                <input name="EpisodeInput.Title" class="form-control" maxlength="200" value="@e.Title" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Initial phase</label>
                                <select name="EpisodeInput.InitialPhase" class="form-select">
                                    <option value="" selected="@((string.IsNullOrWhiteSpace(e.InitialPhase)) ? "selected" : null)">(vuoto)</option>
                                    <option value="AZIONE" selected="@((e.InitialPhase != null && e.InitialPhase.Equals("AZIONE", StringComparison.OrdinalIgnoreCase)) ? "selected" : null)">azione</option>
                                    <option value="STASI" selected="@((e.InitialPhase != null && e.InitialPhase.Equals("STASI", StringComparison.OrdinalIgnoreCase)) ? "selected" : null)">stasi</option>
                                    <option value="ERRORE" selected="@((e.InitialPhase != null && e.InitialPhase.Equals("ERRORE", StringComparison.OrdinalIgnoreCase)) ? "selected" : null)">errore</option>
                                    <option value="EFFETTO" selected="@((e.InitialPhase != null && e.InitialPhase.Equals("EFFETTO", StringComparison.OrdinalIgnoreCase)) ? "selected" : null)">effetto</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tipo Planning (override)</label>
                                <select name="EpisodeInput.TipoPlanningId" class="form-select">
                                    <option value="">(usa default serie)</option>
                                    @foreach (var t in Model.TipoPlannings)
                                    {
                                        <option value="@t.Id" selected="@((e.TipoPlanningId == t.Id) ? "selected" : null)">@t.Nome (@t.Codice)</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Start situation</label>
                                <textarea name="EpisodeInput.StartSituation" class="form-control" rows="2">@e.StartSituation</textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Episode goal</label>
                                <textarea name="EpisodeInput.EpisodeGoal" class="form-control" rows="2">@e.EpisodeGoal</textarea>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Trama</label>
                                <textarea name="EpisodeInput.Trama" class="form-control" rows="2">@e.Trama</textarea>
                            </div>
                        </div>
                        <div class="mt-3 d-flex gap-2">
                            <button type="submit" class="btn btn-outline-primary">Aggiorna</button>
                            <button type="submit" class="btn btn-outline-danger"
                                    formaction="?handler=DeleteEpisode&id=@e.Id&seriesId=@e.SerieId" formmethod="post"
                                    onclick="return confirm('Vuoi eliminare questo episodio?');">
                                Elimina
                            </button>
                        </div>
                    </form>
                }
            }
            else
            {
                <div class="text-muted">Nessun episodio presente.</div>
            }
        }
        else
        {
            <div class="alert alert-warning">Salva la serie per aggiungere episodi.</div>
        }
    </div>
</div>

<div class="modal fade" id="seriesImageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Immagine</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
            <div class="modal-body overflow-auto">
                <img id="seriesImageModalImg" src="" alt="Immagine personaggio" style="max-width:none; height:auto; display:block;" />
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            var tabs = document.querySelectorAll('#seriesTabs [data-bs-toggle="tab"]');
            if (!tabs.length) return;

            function activateTab(btn) {
                var target = btn.getAttribute('data-bs-target');
                if (!target) return;
                tabs.forEach(function (t) {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                });
                var panes = document.querySelectorAll('#seriesTabsContent .tab-pane');
                panes.forEach(function (p) {
                    p.classList.remove('show', 'active');
                });
                btn.classList.add('active');
                btn.setAttribute('aria-selected', 'true');
                var pane = document.querySelector(target);
                if (pane) pane.classList.add('show', 'active');
            }

            tabs.forEach(function (btn) {
                btn.addEventListener('click', function (evt) {
                    if (btn.hasAttribute('disabled')) return;
                    evt.preventDefault();
                    activateTab(btn);
                });
            });
        })();
    </script>

    <script>        // Voice preview play buttons
        (function () {
            // Handler for add character form
            var addSelect = document.querySelector('.voice-select-add');
            var addPlayBtn = document.querySelector('.play-voice-btn-add');
            var addAudio = document.querySelector('.voice-preview-audio-add');
            
            if (addSelect && addPlayBtn && addAudio) {
                var voicesData = {};
                try {
                    var dataStr = addSelect.getAttribute('data-voices');
                    if (dataStr) {
                        var arr = JSON.parse(dataStr);
                        arr.forEach(function(v) { voicesData[v.Id] = v.TemplateWav; });
                    }
                } catch (e) { console.error('Failed to parse voices data', e); }
                
                addSelect.addEventListener('change', function() {
                    var voiceId = addSelect.value;
                    var hasTemplate = voiceId && voicesData[voiceId];
                    addPlayBtn.disabled = !hasTemplate;
                });
                
                addPlayBtn.addEventListener('click', function() {
                    var voiceId = addSelect.value;
                    if (!voiceId || !voicesData[voiceId]) return;
                    var filename = voicesData[voiceId];
                    var url = '/data_voices_samples/' + encodeURIComponent(filename);
                    addAudio.src = url;
                    addAudio.play().catch(function(e) { alert('Errore riproduzione: ' + e.message); });
                });
            }
            
            // Handler for edit character forms
            document.addEventListener('click', function(e) {
                var btn = e.target.closest('.play-voice-btn-edit');
                if (!btn) return;
                
                var container = btn.closest('.col-md-3');
                if (!container) return;
                
                var select = container.querySelector('.voice-select-edit');
                var audio = container.querySelector('.voice-preview-audio-edit');
                if (!select || !audio) return;
                
                var voiceId = select.value;
                if (!voiceId) return;
                
                var voicesData = {};
                try {
                    var dataStr = select.getAttribute('data-voices');
                    if (dataStr) {
                        var arr = JSON.parse(dataStr);
                        arr.forEach(function(v) { voicesData[v.Id] = v.TemplateWav; });
                    }
                } catch (err) { console.error('Failed to parse voices data', err); return; }
                
                if (!voicesData[voiceId]) {
                    alert('Nessun campione audio disponibile per questa voce');
                    return;
                }
                
                var filename = voicesData[voiceId];
                var url = '/data_voices_samples/' + encodeURIComponent(filename);
                audio.src = url;
                audio.play().catch(function(err) { alert('Errore riproduzione: ' + err.message); });
            });
        })();
    </script>

    <script>        (function () {
            var modalEl = document.getElementById('seriesImageModal');
            var imgEl = document.getElementById('seriesImageModalImg');
            if (!modalEl || !imgEl) return;

            modalEl.addEventListener('show.bs.modal', function (event) {
                var trigger = event.relatedTarget;
                if (!trigger) return;
                var fullSrc = trigger.getAttribute('data-fullsrc');
                if (!fullSrc) return;
                imgEl.src = fullSrc;
            });

            modalEl.addEventListener('hidden.bs.modal', function () {
                imgEl.removeAttribute('src');
            });
        })();
    </script>

    <script>
        (function () {
            // Intercept form submits for character AJAX save
            document.addEventListener('submit', function (e) {
                var form = e.target;
                if (!form || !form.classList || !form.classList.contains('character-ajax-form')) return;
                e.preventDefault();
                var submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;

                var fd = new FormData(form);
                var url = form.getAttribute('action') || '?handler=UpdateCharacterAjax';

                fetch(url, {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: fd
                }).then(function (r) { if (submitBtn) submitBtn.disabled = false; return r.json(); })
                .then(function (data) {
                    if (!data) return;
                    if (!data.success) {
                        alert(data.message || 'Errore salvataggio');
                        return;
                    }
                    var ch = data.character;
                    var card = document.querySelector('#character-card-' + ch.id);
                    if (!card) return;
                    // update some visible fields
                    var nameInput = card.querySelector('input[name="CharacterInput.Name"]'); if (nameInput) nameInput.value = ch.name || '';
                    var desc = card.querySelector('textarea[name="CharacterInput.Description"]'); if (desc) desc.value = ch.description || '';
                    var aspect = card.querySelector('textarea[name="CharacterInput.Aspect"]'); if (aspect) aspect.value = ch.aspect || '';
                    // update image if changed
                    if (ch.image) {
                        var imgBtn = card.querySelector('button[data-fullsrc]');
                        if (imgBtn) {
                            imgBtn.setAttribute('data-fullsrc', ch.image);
                            var img = imgBtn.querySelector('img'); if (img) img.src = ch.image;
                        }
                    }
                })
                .catch(function (err) { if (submitBtn) submitBtn.disabled = false; alert('Errore: ' + (err && err.message ? err.message : err)); });
            });

            // Generate image via AJAX
            document.addEventListener('click', function (e) {
                var btn = e.target.closest && e.target.closest('.generate-image-ajax');
                if (!btn) return;
                var seriesId = btn.getAttribute('data-series-id');
                var charId = btn.getAttribute('data-character-id');
                if (!seriesId || !charId) return;
                if (!confirm('Generare/rigenerare l\'immagine di questo personaggio?')) return;
                btn.disabled = true;

                var tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
                var token = tokenEl ? tokenEl.value : '';
                var fd = new FormData();
                fd.append('seriesId', seriesId);
                fd.append('characterId', charId);
                if (token) fd.append('__RequestVerificationToken', token);

                fetch('?handler=GenerateCharacterImageAjax', { method: 'POST', credentials: 'same-origin', body: fd })
                    .then(function (r) { btn.disabled = false; return r.json(); })
                    .then(function (data) {
                        if (!data) return;
                        if (!data.success) {
                            alert(data.message || 'Errore avvio generazione');
                            return;
                        }
                        alert('Generazione avviata (runId: ' + (data.runId || '') + ')');
                    })
                    .catch(function (err) { btn.disabled = false; alert('Errore: ' + (err && err.message ? err.message : err)); });
            });
        })();
    </script>

    <script>
        (function () {
            document.addEventListener('click', function (e) {
                var btn = e.target.closest && e.target.closest('.character-refresh');
                if (!btn) return;
                var charId = btn.getAttribute('data-character-id');
                if (!charId) return;
                btn.disabled = true;
                fetch('?handler=CharacterJson&id=' + encodeURIComponent(charId), { credentials: 'same-origin' })
                    .then(function (r) { btn.disabled = false; if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                    .then(function (data) {
                        if (!data || !data.success) throw new Error('Invalid response');
                        var ch = data.character;
                        var card = document.querySelector('#character-card-' + ch.id);
                        if (!card) return;
                        var setIf = function (sel, val) { var el = card.querySelector(sel); if (el) el.value = val || ''; };
                        setIf('input[name="CharacterInput.Name"]', ch.name);
                        setIf('textarea[name="CharacterInput.Description"]', ch.description);
                        setIf('textarea[name="CharacterInput.Aspect"]', ch.aspect);
                        setIf('input[name="CharacterInput.Eta"]', ch.eta);
                        setIf('input[name="CharacterInput.Formazione"]', ch.formazione);
                        setIf('input[name="CharacterInput.Specializzazione"]', ch.specializzazione);
                        setIf('textarea[name="CharacterInput.Profilo"]', ch.profilo);
                        setIf('textarea[name="CharacterInput.ConflittoInterno"]', ch.conflittoInterno);

                        var imgBtn = card.querySelector('button[data-fullsrc]');
                        if (imgBtn) {
                            var imgSrc = ch.image || '';
                            if (imgSrc && !imgSrc.startsWith('/')) imgSrc = '/series-assets/' + ch.serieId + '/characters/' + encodeURIComponent(imgSrc);
                            imgBtn.setAttribute('data-fullsrc', imgSrc);
                            var img = imgBtn.querySelector('img');
                            if (img) img.src = imgSrc;
                        }
                    })
                    .catch(function (err) {
                        btn.disabled = false;
                        alert('Refresh fallita: ' + (err && err.message ? err.message : err));
                    });
            });
        })();
    </script>
}
