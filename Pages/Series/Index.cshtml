@page
@model TinyGenerator.Pages.Series.IndexModel
@{
    ViewData["Title"] = "Serie TV / Racconti";
    ViewData["PageDescription"] = "Gestisci le serie e i racconti generati";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-theme-alpine.css">

<div class="page-wrapper">
    <div class="d-flex mb-3 align-items-center toolbar-row gap-2">
        <a class="btn btn-sm btn-success" asp-page="./Edit"><i class="bi bi-plus-lg"></i> Crea Serie</a>
        <input id="filterInput" type="text" class="form-control form-control-sm" placeholder="Cerca..." style="max-width: 250px;" />
        <div class="ms-auto d-flex gap-1">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Colonne visibili">
                    <i class="bi bi-layout-three-columns"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="colVisMenu" style="min-width: 180px;"></ul>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
        </div>
    </div>

    <div id="seriesGrid" class="ag-theme-alpine" style="width: 100%;"></div>
    <div id="seriesDetail" class="mt-3"></div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/dist/ag-grid-community.min.js"></script>
    <script>
        const seriesData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SeriesList));

        // Actions cell renderer
        class ActionsCellRenderer {
            init(params) {
                this.eGui = document.createElement('div');
                this.eGui.innerHTML = `
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/Series/Edit?id=${params.data.Id}"><i class="bi bi-pencil"></i> Modifica</a></li>
                            <li><a class="dropdown-item" href="#" data-action="detail"><i class="bi bi-info-circle"></i> Dettaglio</a></li>
                            <li><a class="dropdown-item text-danger" href="/Series/Delete?id=${params.data.Id}"><i class="bi bi-trash"></i> Elimina</a></li>
                        </ul>
                    </div>
                `;

                const detailLink = this.eGui.querySelector('[data-action="detail"]');
                if (detailLink) {
                    detailLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        renderSeriesDetail(params.data);
                    });
                }
            }
            getGui() {
                return this.eGui;
            }
        }

        // Detail toggle renderer (emulates master/detail in community bundle)
        function DetailToggleRenderer(params) {
            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.alignItems = 'flex-start';

            const toggle = document.createElement('span');
            toggle.innerText = '▶';
            toggle.style.cursor = 'pointer';
            toggle.style.marginRight = '8px';

            const detail = document.createElement('div');
            detail.style.display = 'none';
            detail.style.padding = '8px 12px';
            detail.style.background = '#f8f9fa';
            detail.style.borderLeft = '4px solid #dee2e6';
            detail.style.marginTop = '8px';

            const data = params.data || {};
            const labelMap = {
                AmbientazioneBase: 'Ambientazione Base',
                PremessaSerie: 'Premessa Serie',
                ArcoNarrativoSerie: 'Arco Narrativo Serie',
                StileScrittura: 'Stile Scrittura',
                RegoleNarrative: 'Regole Narrative',
                NoteAI: 'Note AI'
            };

            let html = '<div style="display: grid; gap:8px;">';
            Object.keys(labelMap).forEach(key => {
                const val = data[key] || '';
                html += `<div><strong>${labelMap[key]}:</strong><div style="white-space:pre-wrap;">${val ? val : '<em style=\"color:#adb5bd\">Non specificato</em>'}</div></div>`;
            });
            html += '</div>';

            detail.innerHTML = html;

            toggle.addEventListener('click', () => {
                const open = detail.style.display === 'block';
                detail.style.display = open ? 'none' : 'block';
                toggle.innerText = open ? '▶' : '▼';
                try { params.api.resetRowHeights(); } catch (e) { }
            });

            container.appendChild(toggle);
            container.appendChild(detail);
            return container;
        }

        // Render the detail panel below the grid (non-enterprise alternative)
        function renderSeriesDetail(data) {
            const panel = document.getElementById('seriesDetail');
            if (!panel) return;

            const labelMap = {
                AmbientazioneBase: 'Ambientazione Base',
                PremessaSerie: 'Premessa Serie',
                ArcoNarrativoSerie: 'Arco Narrativo Serie',
                StileScrittura: 'Stile Scrittura',
                RegoleNarrative: 'Regole Narrative',
                NoteAI: 'Note AI',
                EpisodiGenerati: 'Episodi Generati',
                DataInserimento: 'Data Inserimento',
                Lingua: 'Lingua'
            };

            const colDefs = gridOptions.columnDefs || [];
            const visibleFields = new Set(colDefs.map(c => c.field).filter(Boolean));

            const keys = Object.keys(data).filter(k => !visibleFields.has(k) && k !== 'Timestamp');

            if (keys.length === 0) {
                panel.innerHTML = '<div class="p-3 text-center text-muted"><em>Nessun dato aggiuntivo disponibile per questa serie</em></div>';
                return;
            }

            let html = '<div class="row g-3">';
            keys.forEach(key => {
                let value = data[key];
                if (value === null || value === undefined || value === '') value = '<em class="text-muted">Non specificato</em>';
                if (key === 'DataInserimento' && data[key]) {
                    try {
                        const d = new Date(data[key]);
                        value = d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' +
                                d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    } catch (e) {}
                }

                html += `
                    <div class="col-12 col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title mb-2">${labelMap[key] || key}</h6>
                                <p class="card-text" style="white-space: pre-wrap;">${value}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            panel.innerHTML = html;
            panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Date formatter
        function dateFormatter(params) {
            if (!params.value) return "-";
            const date = new Date(params.value);
            return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' +
                   date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        }

        // Column visibility storage
        const storageKey = 'series_cols_visibility_ag_v1';
        const savedCols = localStorage.getItem(storageKey);
        let columnVisibility = savedCols ? JSON.parse(savedCols) : {};

        function saveColumnVisibility() {
            const state = gridOptions.columnApi.getColumnState();
            const visibility = {};
            state.forEach(col => {
                visibility[col.colId] = !col.hide;
            });
            localStorage.setItem(storageKey, JSON.stringify(visibility));
            columnVisibility = visibility;
        }

        function getColumnVisibility(field) {
            return columnVisibility.hasOwnProperty(field) ? columnVisibility[field] : true;
        }

        const gridOptions = {
            columnDefs: [
                {
                    headerName: '',
                    field: 'detailToggle',
                    width: 48,
                    cellRenderer: DetailToggleRenderer,
                    sortable: false,
                    filter: false,
                    resizable: false
                },
                { 
                    headerName: "Titolo", 
                    field: "Titolo", 
                    flex: 2,
                    cellRenderer: 'agGroupCellRenderer',
                    hide: !getColumnVisibility("Titolo")
                },
                { 
                    headerName: "Genere", 
                    field: "Genere", 
                    flex: 1,
                    valueFormatter: params => params.value || "-",
                    hide: !getColumnVisibility("Genere")
                },
                { 
                    headerName: "Sottogenere", 
                    field: "Sottogenere",
                    flex: 1,
                    valueFormatter: params => params.value || "-",
                    hide: !getColumnVisibility("Sottogenere")
                },
                { 
                    headerName: "Periodo", 
                    field: "PeriodoNarrativo",
                    flex: 1,
                    valueFormatter: params => params.value || "-",
                    hide: !getColumnVisibility("PeriodoNarrativo")
                },
                { 
                    headerName: "Tono", 
                    field: "TonoBase",
                    flex: 1,
                    valueFormatter: params => params.value || "-",
                    hide: !getColumnVisibility("TonoBase")
                },
                { 
                    headerName: "Target", 
                    field: "Target",
                    flex: 1,
                    valueFormatter: params => params.value || "-",
                    hide: !getColumnVisibility("Target")
                },
                { 
                    headerName: "Lingua", 
                    field: "Lingua",
                    flex: 1,
                    valueFormatter: params => params.value || "-",
                    hide: !getColumnVisibility("Lingua")
                },
                { 
                    headerName: "Episodi", 
                    field: "EpisodiGenerati",
                    width: 100,
                    hide: !getColumnVisibility("EpisodiGenerati")
                },
                { 
                    headerName: "Data Inserimento", 
                    field: "DataInserimento",
                    width: 170,
                    valueFormatter: dateFormatter,
                    hide: !getColumnVisibility("DataInserimento")
                },
                { 
                    headerName: "Azioni", 
                    field: "Id",
                    width: 100,
                    cellRenderer: ActionsCellRenderer,
                    sortable: false,
                    filter: false
                }
            ],
            defaultColDef: {
                sortable: true,
                filter: true,
                resizable: true
            },
            rowData: seriesData,
            // masterDetail (enterprise) removed - using non-enterprise detail panel below the grid
            pagination: true,
            paginationPageSize: 25,
            paginationPageSizeSelector: [10, 25, 50, 100],
            domLayout: 'autoHeight',
            onColumnVisible: saveColumnVisibility,
            onColumnMoved: saveColumnVisibility,
            onGridReady: function(params) {
                // Restore column state
                if (savedCols) {
                    const state = params.columnApi.getColumnState();
                    state.forEach(col => {
                        if (columnVisibility.hasOwnProperty(col.colId)) {
                            col.hide = !columnVisibility[col.colId];
                        }
                    });
                    params.columnApi.applyColumnState({ state: state });
                }

                // Build column visibility menu
                buildColumnVisibilityMenu(params.api, params.columnApi);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const gridDiv = document.querySelector('#seriesGrid');
            const gridApi = agGrid.createGrid(gridDiv, gridOptions);

            // Global filter
            const filterInput = document.getElementById("filterInput");
            if (filterInput) {
                filterInput.addEventListener("input", function() {
                    gridApi.setGridOption('quickFilterText', this.value);
                });
            }
        });

        function buildColumnVisibilityMenu(gridApi, columnApi) {
            const colVisMenu = document.getElementById("colVisMenu");
            if (!colVisMenu) return;

            colVisMenu.innerHTML = '';
            const columns = columnApi.getColumns();
            
            columns.forEach(col => {
                const colDef = col.getColDef();
                if (colDef.headerName && colDef.field && colDef.field !== 'Id') {
                    const li = document.createElement("li");
                    const label = document.createElement("label");
                    label.className = "dropdown-item";
                    label.style.cursor = "pointer";
                    
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.className = "form-check-input me-2";
                    checkbox.checked = col.isVisible();
                    
                    checkbox.addEventListener("change", function(e) {
                        e.stopPropagation();
                        columnApi.setColumnVisible(col.getColId(), this.checked);
                        saveColumnVisibility();
                    });
                    
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(colDef.headerName));
                    
                    label.addEventListener("click", function(e) {
                        if (e.target !== checkbox) {
                            e.preventDefault();
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                    
                    li.appendChild(label);
                    colVisMenu.appendChild(li);
                }
            });
        }
    </script>

    <style>
        .ag-theme-alpine {
            --ag-header-background-color: #f8f9fa;
            --ag-odd-row-background-color: #f8f9fa;
            --ag-row-hover-color: #e9ecef;
        }
        
        /* Fix dropdown overflow */
        .ag-root-wrapper {
            overflow: visible !important;
        }
        
        .ag-body-viewport {
            overflow-x: auto !important;
            overflow-y: auto !important;
        }
        
        .ag-center-cols-viewport,
        .ag-center-cols-container {
            overflow: visible !important;
        }
        
        .ag-row {
            z-index: 0;
        }
        
        .ag-row:hover {
            z-index: 1;
        }
        
        .ag-cell {
            overflow: visible !important;
        }
        
        /* Ensure dropdown menu is above grid */
        .dropdown-menu {
            z-index: 1050 !important;
        }
    </style>
}
