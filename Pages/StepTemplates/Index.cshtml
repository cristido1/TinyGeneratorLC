@page
@model TinyGenerator.Pages.StepTemplates.IndexModel
@{
    ViewData["Title"] = "Step Templates";
    ViewData["PageDescription"] = "Gestisci i template multi-step per la generazione delle storie";
}

<div class="page-wrapper">
    <div class="d-flex mb-2 align-items-center toolbar-row">
        <input id="globalFilter" class="form-control form-control-sm" style="max-width:220px;" placeholder="Cerca..." />
        <div class="ms-auto d-flex gap-1">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Colonne visibili">
                    <i class="bi bi-layout-three-columns"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="stepTemplatesGridColVisMenu" style="min-width: 180px;"></ul>
            </div>
            <button id="refreshBtn" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">Refresh</button>
            <button class="btn btn-sm btn-primary" onclick="openCreateModal()">Nuovo</button>
        </div>
    </div>

    <div id="stepTemplatesGrid" class="ag-theme-alpine" style="height: calc(100vh - 180px); width: 100%;"></div>
</div>

<!-- Edit/Create Modal -->
<div class="modal fade" id="modalEditTemplate" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form method="post" asp-page-handler="Save">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Create Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="templateId" name="id" value="0" />

                    <div class="mb-3">
                        <label for="templateName" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="templateName" name="name" required maxlength="200" />
                    </div>

                    <div class="mb-3">
                        <label for="templateTaskType" class="form-label">Task Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="templateTaskType" name="taskType" required>
                            <option value="story">story</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="templateDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="templateDescription" name="description" rows="2" maxlength="500"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="templateInstructions" class="form-label">Instructions (override agent)</label>
                        <textarea class="form-control font-monospace" id="templateInstructions" name="instructions" rows="6" placeholder="System prompt da usare al posto delle istruzioni dell'agente"></textarea>
                        <div class="form-text">Se valorizzato, viene usato come messaggio di sistema per tutti gli step al posto delle istruzioni dell'agente.</div>
                    </div>

                    <div class="mb-3">
                        <label for="templateStepPrompt" class="form-label">Step Prompt <span class="text-danger">*</span></label>
                        <textarea class="form-control font-monospace" id="templateStepPrompt" name="stepPrompt" rows="15" required></textarea>
                        <div class="form-text">
                            Format: numbered steps (e.g., "1. Crea trama", "2. Personaggi"). Use placeholders: {{STEP_N}}, {{STEP_N_SUMMARY}}, {{STEP_N_EXTRACT:filter}}, {{STEPS_N-M_SUMMARY}}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Template Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        window.__steptemplates_data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Templates));
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rowData = (window.__steptemplates_data || []).map(t => {
                // Count numbered steps
                const stepCount = (t.StepPrompt || '').match(/^\d+\./gm)?.length || 0;
                return { ...t, StepCount: stepCount };
            });

            const columnDefs = [
                { headerName: 'Name', field: 'Name', flex: 1 },
                { headerName: 'Task Type', field: 'TaskType', width: 120 },
                { headerName: 'Description', field: 'Description', flex: 2 },
                { headerName: 'Steps', field: 'StepCount', width: 80 },
                { headerName: 'Created', field: 'CreatedAt', width: 160, valueFormatter: p => formatDate(p.value) },
                {
                    headerName: 'Actions', colId: 'actions', width: 220, suppressColumnsToolPanel: true,
                    cellRenderer: params => {
                        const id = params.data.Id;
                        return `<button class="btn btn-sm btn-outline-secondary me-1 btn-details" data-id="${id}" title="Show details">+</button>` +
                               `<a class="btn btn-sm btn-outline-primary me-1" href="/StepTemplates/Edit?id=${id}">Edit</a>` +
                               `<button class="btn btn-sm btn-outline-secondary me-1 btn-copy" data-id="${id}" title="Copy">Copy</button>` +
                               `<button class="btn btn-sm btn-outline-danger btn-delete" data-id="${id}">Delete</button>`;
                    }
                }
            ];

            AgGridHelper.init('stepTemplatesGrid', columnDefs, rowData, {
                storageKey: 'agGrid_stepTemplates_colVis',
                pageSize: 25
            });

            // Quick filter
            document.getElementById('globalFilter')?.addEventListener('input', e => {
                window.stepTemplatesGridApi?.setQuickFilter(e.target.value);
            });

            // Grid click handlers
            document.getElementById('stepTemplatesGrid').addEventListener('click', e => {
                const detailsBtn = e.target.closest('.btn-details');
                if (detailsBtn) {
                    const id = parseInt(detailsBtn.dataset.id);
                    const item = rowData.find(r => r.Id === id);
                    if (item) showDetails(item);
                }
                
                const copyBtn = e.target.closest('.btn-copy');
                if (copyBtn) {
                    const id = copyBtn.dataset.id;
                    // Submit copy form
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.innerHTML = `<input type="hidden" name="id" value="${id}"/>`;
                    form.action = '?handler=Copy';
                    document.body.appendChild(form);
                    form.submit();
                }

                const deleteBtn = e.target.closest('.btn-delete');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    const item = rowData.find(r => r.Id == id);
                    if (confirm('Delete template ' + (item?.Name || id) + '?')) {
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.innerHTML = `<input type="hidden" name="id" value="${id}"/>`;
                        form.action = '?handler=Delete';
                        document.body.appendChild(form);
                        form.submit();
                    }
                }
            });

            function showDetails(item) {
                const stepPrompt = item.StepPrompt || '';
                const instructions = item.Instructions || '';
                
                // Parse steps (lines starting with digit followed by dot)
                const steps = stepPrompt.split('\n').filter(line => /^\d+\./.test(line.trim()));
                
                let html = '<div class="p-2">';
                if (instructions) {
                    html += '<div class="mb-3"><h6 class="mb-1">Instructions override</h6><pre class="bg-light border p-2" style="max-height:140px;overflow-y:auto;font-size:0.85rem;">' + escapeHtml(instructions) + '</pre></div>';
                }
                html += '<h6>Template Steps:</h6><ol class="list-group list-group-numbered mt-2">';
                
                if (steps.length > 0) {
                    steps.forEach(step => {
                        const stepText = step.replace(/^\d+\.\s*/, '').trim();
                        html += '<li class="list-group-item">' + escapeHtml(stepText) + '</li>';
                    });
                } else {
                    html += '<li class="list-group-item">No numbered steps found</li>';
                }
                
                html += '</ol><hr><strong>Full Step Prompt:</strong><pre class="bg-light p-2 mt-2" style="max-height:200px;overflow-y:auto;font-size:0.85rem;">' + escapeHtml(stepPrompt) + '</pre></div>';
                
                document.getElementById('detailsModalBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('detailsModal')).show();
            }

            window.openEditModal = function(item) {
                document.getElementById('modalTitle').textContent = 'Edit Template: ' + item.Name;
                document.getElementById('templateId').value = item.Id;
                document.getElementById('templateName').value = item.Name;
                document.getElementById('templateTaskType').value = item.TaskType;
                document.getElementById('templateDescription').value = item.Description || '';
                document.getElementById('templateInstructions').value = item.Instructions || '';
                document.getElementById('templateStepPrompt').value = item.StepPrompt || '';
                new bootstrap.Modal(document.getElementById('modalEditTemplate')).show();
            };

            window.openCreateModal = function() {
                document.getElementById('modalTitle').textContent = 'Create Template';
                document.getElementById('templateId').value = '0';
                document.getElementById('templateName').value = '';
                document.getElementById('templateTaskType').value = 'story';
                document.getElementById('templateDescription').value = '';
                document.getElementById('templateInstructions').value = '';
                document.getElementById('templateStepPrompt').value = '';
                new bootstrap.Modal(document.getElementById('modalEditTemplate')).show();
            };

            function escapeHtml(text) {
                if (!text) return '';
                return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"})[m]);
            }

            function formatDate(val) {
                if (!val) return '';
                try {
                    const dt = new Date(val);
                    return dt.toLocaleDateString('it-IT') + ' ' + dt.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                } catch { return val; }
            }
        });
    </script>
}
