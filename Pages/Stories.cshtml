@page
@model TinyGenerator.Pages.StoriesModel
@{
    ViewData["Title"] = "Storie salvate";
}

@* Title rendered by layout using ViewData["Title"] *@

<table id="storiesTable" class="table" style="width:100%">
    <thead>
        <tr>
            <th>Id</th>
            <th>Timestamp</th>
            <th>Prompt</th>
            <th>Model A</th>
            <th>Score A</th>
            <th>Model B</th>
            <th>Score B</th>
            <th>Approved</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
@foreach(var s in Model.Stories) {
        <tr data-story-id="@s.Id">
            <td>@s.Id</td>
            <td>@s.Timestamp</td>
            <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">@s.Prompt</td>
            <td>@s.ModelA</td>
            <td>@s.ScoreA</td>
            <td>@s.ModelB</td>
            <td>@s.ScoreB</td>
            <td>@(s.Approved ? "✅" : "❌")</td>
            <td>
                <div class="d-flex gap-1">
                    <form method="post" asp-route-id="@s.Id" onsubmit="return confirm('Eliminare la storia?');">
                        <button type="submit" class="btn btn-sm btn-danger">Elimina</button>
                    </form>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleStoryDetails(@s.Id)">Details</button>
                </div>
                <div class="details-template" style="display:none;">
                    <div>
                        <h5>Storia A (model: @s.ModelA, score: @s.ScoreA)</h5>
                        <pre style="white-space: pre-wrap">@s.StoryA</pre>
                        <div class="card mb-3">
                            <h6>Valutazioni A</h6>
                            <pre style="white-space: pre-wrap">@s.EvalA</pre>
                        </div>
                        <h5>Storia B (model: @s.ModelB, score: @s.ScoreB)</h5>
                        <pre style="white-space: pre-wrap">@s.StoryB</pre>
                        <h6>Valutazioni B</h6>
                        <pre style="white-space: pre-wrap">@s.EvalB</pre>
                    </div>
                </div>
            </td>
        </tr>
}
    </tbody>
</table>

<!-- DataTables assets and init -->
<link rel="stylesheet" href="~/lib/datatables/css/dataTables.bootstrap5.min.css" />
<link rel="stylesheet" href="~/lib/datatables/css/buttons.bootstrap5.min.css" />
<script src="~/lib/jquery/jquery.min.js"></script>
<script src="~/lib/datatables/js/jquery.dataTables.min.js"></script>
<script src="~/lib/datatables/js/dataTables.bootstrap5.min.js"></script>
<script src="~/lib/datatables/js/dataTables.colReorder.min.js"></script>
<script src="~/lib/datatables/js/dataTables.buttons.min.js"></script>
<script src="~/lib/datatables/js/buttons.bootstrap5.min.js"></script>
<script src="~/lib/datatables/js/buttons.colVis.min.js"></script>
<script src="~/lib/datatables/js/jszip.min.js"></script>
<script src="~/lib/datatables/js/pdfmake.min.js"></script>
<script src="~/lib/datatables/js/vfs_fonts.js"></script>
<script src="~/lib/datatables/js/buttons.html5.min.js"></script>
<script src="~/lib/datatables/js/buttons.print.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function(){
        try {
            if (window.jQuery && jQuery().DataTable) {
                var st = $('#storiesTable').DataTable({
                    lengthChange: true,
                    pageLength: 25,
                    stateSave: true,
                    colReorder: true,
                    ordering: true,
                    autoWidth: false,
                    columnDefs: [ { orderable: false, targets: -1 } ],
                    dom: "<'row mb-2'<'col-sm-6 d-flex align-items-center'B><'col-sm-6 d-flex justify-content-end align-items-center'f>>t<'row'<'col-sm-12'p>>",
                    buttons: [ { extend: 'colvis', text: 'Columns', columns: ':not(.noVis)', postfixButtons: ['colvisRestore'], className: 'dt-btn-white btn btn-sm me-2' } ],
                    language: { search: "_INPUT_", searchPlaceholder: "Search..." }
                });
                window.storiesTable = st;
            }
        } catch(e) { console.error('Stories DataTables init failed', e); }
    });

    function toggleStoryDetails(id) {
        try {
            var tr = document.querySelector('tr[data-story-id="' + id + '"]');
            if (!tr) return;
            var table = window.storiesTable || (window.jQuery && jQuery().DataTable ? $('#storiesTable').DataTable() : null);
            if (table) {
                var row = table.row(tr);
                if (row.child.isShown()) row.child.hide(); else { var tpl = tr.querySelector('.details-template'); if (!tpl) return; row.child(tpl.innerHTML).show(); }
            } else {
                var tpl = tr.querySelector('.details-template'); if (!tpl) return; tpl.style.display = tpl.style.display === 'none' ? '' : 'none';
            }
        } catch(e) { console.error(e); }
    }
</script>
