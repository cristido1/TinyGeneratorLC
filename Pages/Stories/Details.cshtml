@page "{id:long}"
@model TinyGenerator.Pages.Stories.DetailsModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Dettaglio storia";
}

<div class="card">
    <div class="card-body">
        <h4 class="card-title">Storia ID: @Model.Story?.Id</h4>
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <div class="small text-muted">Prompt: @Model.Story?.Prompt</div>
                <div class="small text-muted">Timestamp: @Model.Story?.Timestamp</div>
            </div>
            <div>
                <a class="btn btn-sm btn-outline-secondary me-1" asp-page="/Stories/Edit" asp-route-id="@Model.Story?.Id">Modifica</a>
                <a class="btn btn-sm btn-outline-primary me-1" id="ttsPlay">Ascolta (Browser)</a>
                <a class="btn btn-sm btn-outline-success" id="macTtsPlay">Ascolta (macOS)</a>
            </div>
        </div>
        <ul class="nav nav-tabs" id="storyTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="story-raw-tab" data-bs-toggle="tab" data-bs-target="#story-raw-pane" type="button" role="tab" aria-controls="story-raw-pane" aria-selected="false">Storia raw</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="story-revised-tab" data-bs-toggle="tab" data-bs-target="#story-revised-pane" type="button" role="tab" aria-controls="story-revised-pane" aria-selected="false">Storia revised</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="story-diff-tab" data-bs-toggle="tab" data-bs-target="#story-diff-pane" type="button" role="tab" aria-controls="story-diff-pane" aria-selected="false">Confronto</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="story-tab" data-bs-toggle="tab" data-bs-target="#story-pane" type="button" role="tab" aria-controls="story-pane" aria-selected="true">Storia</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="evaluations-tab" data-bs-toggle="tab" data-bs-target="#evaluations-pane" type="button" role="tab" aria-controls="evaluations-pane" aria-selected="false">Valutazioni</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-pane" type="button" role="tab" aria-controls="summary-pane" aria-selected="false">Sommario</button>
            </li>
        </ul>
        <div class="tab-content mt-3" id="storyTabsContent">
            <div class="tab-pane fade" id="story-raw-pane" role="tabpanel" aria-labelledby="story-raw-tab">
                @if (!string.IsNullOrWhiteSpace(Model.StoryRawText))
                {
                    <pre style="white-space: pre-wrap;">@Model.StoryRawText</pre>
                }
                else
                {
                    <div class="text-muted">Nessun testo raw disponibile.</div>
                }
            </div>
            <div class="tab-pane fade" id="story-revised-pane" role="tabpanel" aria-labelledby="story-revised-tab">
                @if (!string.IsNullOrWhiteSpace(Model.StoryRevisedText))
                {
                    <pre style="white-space: pre-wrap;">@Model.StoryRevisedText</pre>
                }
                else
                {
                    <div class="text-muted">Nessun testo revised disponibile.</div>
                }
            </div>
            <div class="tab-pane fade" id="story-diff-pane" role="tabpanel" aria-labelledby="story-diff-tab">
                @if (Model.HasRevisionDiff && !string.IsNullOrWhiteSpace(Model.RawDiffHtml) && !string.IsNullOrWhiteSpace(Model.RevisedDiffHtml))
                {
                    <div class="small text-muted mb-2">Differenze (raw in arancione, revised in verde)</div>
                    <div class="row g-3">
                        <div class="col-12 col-lg-6">
                            <div class="small text-muted mb-1">Raw (modificato/eliminato/sostituito)</div>
                            <pre class="border rounded p-2" style="white-space: pre-wrap;">@Html.Raw(Model.RawDiffHtml)</pre>
                        </div>
                        <div class="col-12 col-lg-6">
                            <div class="small text-muted mb-1">Revised (aggiunte/sostituzioni)</div>
                            <pre class="border rounded p-2" style="white-space: pre-wrap;">@Html.Raw(Model.RevisedDiffHtml)</pre>
                        </div>
                    </div>
                }
                else
                {
                    <div class="text-muted">Nessuna differenza da mostrare.</div>
                }
            </div>
            <div class="tab-pane fade show active" id="story-pane" role="tabpanel" aria-labelledby="story-tab">
                @if (!string.IsNullOrWhiteSpace(Model.StoryTaggedText))
                {
                    <pre style="white-space: pre-wrap;">@Model.StoryTaggedText</pre>
                }
                else
                {
                    <div class="text-muted">Nessun testo taggato disponibile.</div>
                }
            </div>
            <div class="tab-pane fade" id="evaluations-pane" role="tabpanel" aria-labelledby="evaluations-tab">
                <div id="evaluations" class="mt-2">
                    @if (Model.Evaluations != null && Model.Evaluations.Count > 0)
                    {
                        foreach (var e in Model.Evaluations)
                        {
                            <partial name="_StoryEvaluationCard" model="e" />
                            <div class="mt-2 text-end">
                                <form method="post" asp-page-handler="DeleteEvaluation" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@e.Id" />
                                    <input type="hidden" name="storyId" value="@Model.Story?.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Eliminare questa valutazione?');">Elimina valutazione</button>
                                </form>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-muted">Nessuna valutazione</div>
                    }
                </div>
            </div>
            <div class="tab-pane fade" id="summary-pane" role="tabpanel" aria-labelledby="summary-tab">
                @if (!string.IsNullOrWhiteSpace(Model.Story?.Summary))
                {
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Sommario</h5>
                            <p class="card-text" style="white-space: pre-wrap;">@Model.Story?.Summary</p>
                        </div>
                    </div>
                }
                else
                {
                    <div class="text-muted">Nessun sommario disponibile per questa storia.</div>
                }
            </div>
        </div>

        <audio id="ttsAudio" controls style="width:100%; display:none;" />
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            var btn = document.getElementById('ttsPlay');
            var isSpeaking = false;
            var utterance = null;

            btn?.addEventListener('click', function(){
                if (!('speechSynthesis' in window)) {
                    alert('Il tuo browser non supporta la sintesi vocale');
                    return;
                }

                if (isSpeaking) {
                    // Stop speaking
                    window.speechSynthesis.cancel();
                    btn.innerText = 'Ascolta';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-primary');
                    isSpeaking = false;
                    return;
                }

                // Get story text
                var storyText = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.StoryRevisedText ?? Model.StoryRawText ?? ""));
                
                if (!storyText || storyText.trim() === '') {
                    alert('Nessun testo da leggere');
                    return;
                }

                // Create speech utterance
                utterance = new SpeechSynthesisUtterance(storyText);
                utterance.lang = 'it-IT';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;

                utterance.onstart = function() {
                    isSpeaking = true;
                    btn.innerText = 'Stop';
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-danger');
                };

                utterance.onend = function() {
                    isSpeaking = false;
                    btn.innerText = 'Ascolta';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-primary');
                };

                utterance.onerror = function(e) {
                    console.error('Speech synthesis error:', e);
                    isSpeaking = false;
                    btn.innerText = 'Ascolta';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-primary');
                    alert('Errore durante la lettura');
                };

                // Start speaking
                window.speechSynthesis.speak(utterance);
            });

            // macOS TTS button
            var macBtn = document.getElementById('macTtsPlay');
            macBtn?.addEventListener('click', async function(){
                try {
                    macBtn.disabled = true;
                    macBtn.innerText = 'Generazione...';
                    var id = '@Model.Story?.Id';
                    var token = '@Antiforgery.GetAndStoreTokens(HttpContext).RequestToken';
                    var res = await fetch(`/Stories/Details/${id}?handler=macTts`, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': token,
                            'Accept': 'application/json'
                        }
                    });
                    if (!res.ok) { 
                        var errorText = await res.text();
                        alert('Errore TTS macOS: ' + errorText); 
                        return; 
                    }
                    var j = await res.json();
                    var audio = document.getElementById('ttsAudio');
                    if (j && j.audio_url) {
                        audio.src = j.audio_url; 
                        audio.style.display = ''; 
                        audio.play();
                    } else {
                        alert('Audio non generato');
                    }
                } catch (e) { 
                    console.error(e); 
                    alert('Errore TTS macOS: ' + e.message); 
                }
                finally { 
                    macBtn.disabled = false; 
                    macBtn.innerText = 'Ascolta (macOS)'; 
                }
            });
        })
    </script>
}
