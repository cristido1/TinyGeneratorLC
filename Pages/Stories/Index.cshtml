@page
@model TinyGenerator.Pages.Stories.IndexModel
@{
    ViewData["Title"] = "Storie";
}

<form method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>

<!-- Hidden form for TestTtsSchema handler -->
<form id="testTtsSchemaForm" method="post" asp-page-handler="TestTtsSchema" style="display:none;">
    <input type="number" id="testTtsStoryIdInput" name="storyId" value="32" min="1" />
</form>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}
@if (TempData["StatusMessage"] != null)
{
    <div class="alert alert-success">@TempData["StatusMessage"]</div>
}

<div class="page-wrapper">
    <div class="d-flex mb-2 align-items-center toolbar-row">
        <!-- Buttons moved into DataTables buttons area. External buttons container: will be moved via JS. -->
        <div class="me-auto"></div>
        <div id="externalButtons" class="d-none">
            <a class="btn btn-sm btn-success ms-2" asp-page="Create"><i class="bi bi-plus-lg"></i> Nuova storia</a>
            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="testTtsSchema()"><i class="bi bi-box"></i> Test TTS</button>
            <form method="post" asp-page-handler="BatchSummarize" onsubmit="return confirm('Avviare la generazione batch dei riassunti per tutte le storie con valutazione >= 60?')" style="display:inline-block; margin-left:8px;">
                <button type="submit" class="btn btn-sm btn-outline-info ms-2"><i class="bi bi-file-text"></i> Riassunti Batch</button>
            </form>
            <form method="post" asp-page-handler="DeleteLowRated" onsubmit="return confirm('Eliminare tutte le storie con valutazione media <50 e almeno 2 valutazioni? Questa operazione è irreversibile.')" style="display:inline-block; margin-left:8px;">
                <button type="submit" class="btn btn-sm btn-outline-danger ms-2"><i class="bi bi-trash"></i> Elimina storie scadenti</button>
            </form>
            <form method="post" asp-page-handler="DeleteAllEvaluations" onsubmit="return confirm('Cancellare TUTTE le valutazioni per TUTTE le storie (incluse coerenza e valutazioni azione/ritmo)? Questa operazione è irreversibile.')" style="display:inline-block; margin-left:8px;">
                <button type="submit" class="btn btn-sm btn-outline-danger ms-2"><i class="bi bi-eraser"></i> Cancella tutte le valutazioni</button>
            </form>
            <form method="post" asp-page-handler="EnsureTagStatusConsistency" onsubmit="return confirm('Allineare gli stati delle storie mancanti di story_tags? Le storie senza tag torneranno indietro agli step appropriati.')" style="display:inline-block; margin-left:8px;">
                <button type="submit" class="btn btn-sm btn-outline-warning ms-2"><i class="bi bi-arrow-counterclockwise"></i> Verifica story_tags</button>
            </form>
            <form method="post" asp-page-handler="RealignCreatorModelIds" onsubmit="return confirm('Allineare model_id delle storie al model_id configurato dell\'agente (agent_id)? Non modifica agent_id. Operazione consigliata solo se hai storie con agent/modello incoerenti.')" style="display:inline-block; margin-left:8px;">
                <button type="submit" class="btn btn-sm btn-outline-warning ms-2"><i class="bi bi-wrench-adjustable"></i> Allinea model_id</button>
            </form>
            <div class="dropdown ms-2 d-inline-block">
                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-check2-all"></i> Valuta tutti
                </button>
                <ul class="dropdown-menu" id="bulkEvaluateMenu">
                    @if (Model.Evaluators != null && Model.Evaluators.Any())
                    {
                        foreach (var ev in Model.Evaluators)
                        {
                            <li><button class="dropdown-item" type="button" onclick="bulkEvaluate(@ev.Id)">@ev.Name (@ev.Role)</button></li>
                        }
                    }
                    else
                    {
                        <li><span class="dropdown-item text-muted">Nessun evaluator attivo</span></li>
                    }
                </ul>
            </div>
            <button class="btn btn-sm btn-outline-secondary ms-2" id="refreshBtn">Refresh</button>
        </div>
    </div>

        <div style="height: calc(100vh - 200px); width:100%; overflow-x:auto; overflow-y:auto;">
        <style>
            /* Grigietto pager styles */
            #pager { padding: 8px 12px; text-align: right; }
            #pager .pagination { margin: 0; display: inline-flex; gap: 4px; }
            #pager .page-link {
                background: #f3f4f6; /* very light gray */
                color: #333;
                border: 1px solid #d7d7d7;
                min-width: 38px;
                text-align: center;
            }
            #pager .page-item.active .page-link {
                background: #e9ecef; /* slightly darker */
                color: #222;
                border-color: #cfcfcf;
            }
            #pager .page-item.disabled .page-link { opacity: 0.6; }
        </style>
        <table class="table table-striped table-hover" id="storiesTable">
            <thead class="table-light">
                <tr>
                    <th data-col="id">Id</th>
                    <th data-col="timestamp">Timestamp</th>
                    <th data-col="serie">Serie</th>
                    <th data-col="title">Titolo</th>
                    <th data-col="episode">Episodio</th>
                    <th data-col="prompt">Prompt</th>
                    <th data-col="status">Status</th>
                    <th data-col="agent">Agente</th>
                    <th data-col="model">Modello</th>
                    <th data-col="folder">Cartella</th>
                    <th data-col="assets">Assets</th>
                    <th data-col="chars">Caratteri</th>
                    <th data-col="test">Test</th>
                    <th data-col="score">Score</th>
                    <th data-col="eval">Valutazione</th>
                    <th data-col="approved">Approved</th>
                    <th data-col="details">Dettagli</th>
                    <th data-col="actions">Azioni</th>
                </tr>
            </thead>
            <tbody>
                @foreach(var s in Model.Stories)
                {
                    <tr>
                        <td data-col="id">@s.Id</td>
                        <td data-col="timestamp">@((DateTime.TryParse(s.Timestamp, out var _dt)) ? _dt.ToString("dd/MM/yyyy HH:mm") : s.Timestamp)</td>
                        <td data-col="serie">@(!string.IsNullOrWhiteSpace(s.SerieName) ? s.SerieName : "-")</td>
                        <td data-col="title">@(!string.IsNullOrWhiteSpace(s.Title) ? s.Title : "<span class='text-muted'>-</span>")</td>
                        <td data-col="episode">@((s.SerieEpisode.HasValue && s.SerieEpisode.Value > 0) ? s.SerieEpisode.Value.ToString() : "-")</td>
                        @{
                            var promptSafe = s.Prompt ?? string.Empty;
                        }
                        <td data-col="prompt" title="@promptSafe">@((promptSafe.Length > 120) ? (promptSafe.Substring(0, 120) + "...") : promptSafe)</td>
                        <td data-col="status">@(!string.IsNullOrWhiteSpace(s.Status) ? s.Status : "-")</td>
                        <td data-col="agent">@s.Agent</td>
                        <td data-col="model">@s.Model</td>
                        <td data-col="folder">@s.Folder</td>
                        <td data-col="assets">
                            @if (!string.IsNullOrWhiteSpace(s.StoryTagged)) { <span title="Story tagged" class="text-dark me-1"><i class="bi bi-tags-fill"></i></span>; }
                            @if (s.GeneratedTtsJson) { <span title="TTS JSON" class="text-primary me-1"><i class="bi bi-file-earmark-text-fill"></i></span>; }
                            @if (s.GeneratedTts) { <span title="TTS audio" class="text-success me-1"><i class="bi bi-volume-up-fill"></i></span>; }
                            @if (s.GeneratedAmbient) { <span title="Ambience" class="text-info me-1"><i class="bi bi-cloud-fill"></i></span>; }
                            @if (s.GeneratedEffects) { <span title="FX" class="text-warning me-1"><i class="bi bi-lightning-charge-fill"></i></span>; }
                            @if (s.GeneratedMusic) { <span title="Music" class="text-muted me-1"><i class="bi bi-music-note-beamed"></i></span>; }
                            @if (s.GeneratedMixedAudio) {
                                <button type="button" class="btn btn-sm btn-link p-0 me-2 play-final-mix-btn" data-story-id="@s.Id" title="Play final mix"><i class="bi bi-play-circle-fill" style="color:#0d6efd;font-size:1.25rem;"></i></button>
                            }
                        </td>
                        <td data-col="chars" class="text-end">@s.CharCount</td>
                        <td data-col="test">@((s.TestRunId>0) ? $"Run {s.TestRunId}" : "-")</td>
                        <td data-col="score">@s.Score</td>
                        <td data-col="eval">@((s.Evaluations!=null && s.Evaluations.Any()) ? (s.Evaluations.Average(e=>e.TotalScore)*100.0/40.0).ToString("F1") + "/100" : "-")</td>
                        <td data-col="approved">@(s.Approved ? "✅" : "❌")</td>
                        <td data-col="details">
                            <button type="button" class="btn btn-sm btn-outline-secondary toggle-evals" data-story-id="@s.Id">Valutazioni</button>
                        </td>
                        <td data-col="actions">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Azioni</button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    @{
                                        // Build action lists, remove listen commands, and pin detail/edit/delete first
                                        var rawActions = Model.GetActionsForStory(s)?.ToList() ?? new List<object>();
                                        // Filter out listen commands by id or title
                                        rawActions = rawActions.Where(a => {
                                            var id = a.GetType().GetProperty("id")?.GetValue(a)?.ToString() ?? "";
                                            var title = a.GetType().GetProperty("title")?.GetValue(a)?.ToString() ?? "";
                                            if (id == "final_mix_play" || id == "tts_playlist") return false;
                                            if (!string.IsNullOrWhiteSpace(title) && (title.Equals("Ascolta mix finale", StringComparison.OrdinalIgnoreCase) || title.Equals("Ascolta sequenza tts", StringComparison.OrdinalIgnoreCase))) return false;
                                            return true;
                                        }).ToList();

                                        // Extract pinned actions
                                        object? detailsAction = rawActions.FirstOrDefault(a => (a.GetType().GetProperty("id")?.GetValue(a)?.ToString() ?? "") == "details");
                                        if (detailsAction != null) rawActions.Remove(detailsAction);
                                        object? editAction = rawActions.FirstOrDefault(a => (a.GetType().GetProperty("id")?.GetValue(a)?.ToString() ?? "") == "edit");
                                        if (editAction != null) rawActions.Remove(editAction);
                                        object? deleteAction = rawActions.FirstOrDefault(a => (a.GetType().GetProperty("id")?.GetValue(a)?.ToString() ?? "") == "delete");
                                        if (deleteAction != null) rawActions.Remove(deleteAction);

                                        // Render pinned actions first: Details, Edit, Delete
                                        foreach (var pinned in new[] { detailsAction, editAction, deleteAction })
                                        {
                                            if (pinned == null) continue;
                                            var a = pinned;
                                            var id = a.GetType().GetProperty("id")?.GetValue(a)?.ToString() ?? "";
                                            var title = a.GetType().GetProperty("title")?.GetValue(a)?.ToString() ?? "";
                                            var method = a.GetType().GetProperty("method")?.GetValue(a)?.ToString() ?? "GET";
                                            var url = a.GetType().GetProperty("url")?.GetValue(a)?.ToString() ?? "";
                                            var confirm = a.GetType().GetProperty("confirm")?.GetValue(a);

                                            var iconClass = id switch
                                            {
                                                "details" => "bi bi-eye",
                                                "edit" => "bi bi-pencil",
                                                "delete" => "bi bi-trash-fill",
                                                _ => "bi bi-gear"
                                            };

                                            var isDelete = id == "delete";
                                            var itemClass = isDelete ? "dropdown-item text-danger" : "dropdown-item";
                                            var iconExtraClass = isDelete ? " text-danger" : "";

                                            if (method == "GET")
                                            {
                                                var targetAttr = id == "edit" ? string.Empty : " target=\"_blank\"";
                                                <li><a class="@itemClass" href="@url"@Html.Raw(targetAttr)><i class="@iconClass me-3@iconExtraClass"></i>&nbsp;@title</a></li>
                                            }
                                            else
                                            {
                                                <li>
                                                    <form method="post" action="@url" class="m-0" onsubmit="return @((confirm!=null && confirm.ToString()=="True")?"confirm('Confermi?')":"true")">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="@itemClass"><i class="@iconClass me-3@iconExtraClass"></i>&nbsp;@title</button>
                                                    </form>
                                                </li>
                                            }
                                        }

                                        if (detailsAction != null || editAction != null || deleteAction != null)
                                        {
                                            <li><hr class="dropdown-divider" /></li>
                                        }

                                        // Render remaining actions
                                        foreach(var a in rawActions)
                                        {
                                            var id = a.GetType().GetProperty("id")?.GetValue(a)?.ToString() ?? "";
                                            var title = a.GetType().GetProperty("title")?.GetValue(a)?.ToString() ?? "";
                                            var method = a.GetType().GetProperty("method")?.GetValue(a)?.ToString() ?? "GET";
                                            var url = a.GetType().GetProperty("url")?.GetValue(a)?.ToString() ?? "";
                                            var confirm = a.GetType().GetProperty("confirm")?.GetValue(a);
                                            var iconClass = id switch
                                            {
                                                "revise" => "bi bi-spellcheck",
                                                "clone_revised" => "bi bi-stars",
                                                "prepare_tts_schema" => "bi bi-magic",
                                                "add_tags" => "bi bi-tags",
                                                "regen_ambient_tags" => "bi bi-cloud-haze2",
                                                "regen_fx_tags" => "bi bi-lightning-charge-fill",
                                                "regen_music_tags" => "bi bi-music-note-beamed",
                                                "gen_tts" => "bi bi-volume-up-fill",
                                                "gen_ambience" => "bi bi-cloud-fill",
                                                "gen_fx" => "bi bi-lightning-charge-fill",
                                                "gen_music" => "bi bi-music-note-beamed",
                                                "mix_final" => "bi bi-play-circle-fill",
                                                "final_mix_play" => "bi bi-play-btn",
                                                "tts_playlist" => "bi bi-list-music",
                                                "details" => "bi bi-eye",
                                                "edit" => "bi bi-pencil",
                                                "advance" => "bi bi-arrow-right-circle",
                                                "delete" => "bi bi-trash-fill",
                                                _ => "bi bi-gear"
                                            };
                                            if (method == "GET")
                                            {
                                                var targetAttr = id == "edit" ? string.Empty : " target=\"_blank\"";
                                                <li><a class="dropdown-item" href="@url"@Html.Raw(targetAttr)><i class="@iconClass me-2"></i>@title</a></li>
                                            }
                                            else
                                            {
                                                <li>
                                                    <form method="post" action="@url" class="m-0" onsubmit="return @((confirm!=null && confirm.ToString()=="True")?"confirm('Confermi?')":"true")">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="dropdown-item"><i class="@iconClass me-2"></i>@title</button>
                                                    </form>
                                                </li>
                                            }
                                        }
                                    }
                                </ul>
                            </div>
                        </td>
                    </tr>
                    <tr class="story-evals-row d-none" data-story-id="@s.Id" data-detail-row>
                        <td class="detail-cell">
                            <div class="p-3 bg-light border rounded">
                                @if (s.Evaluations != null && s.Evaluations.Any())
                                {
                                    foreach (var e in s.Evaluations)
                                    {
                                        <partial name="_StoryEvaluationCard" model="e" />
                                    }
                                }
                                else
                                {
                                    <div class="text-muted">Nessuna valutazione</div>
                                }
                            </div>
                        </td>
                        @for (int _i = 1; _i < 18; _i++) {
                            <td></td>
                        }
                    </tr>
                }
            </tbody>
        </table>
        

        <style>
            /* Ensure detail rows visually span the table while keeping correct TD count for DataTables */
            tr[data-detail-row] td { padding: 0; border: none; }
            tr[data-detail-row] td.detail-cell { display: block; width: 100%; padding: .75rem; }
            tr[data-detail-row] td:not(.detail-cell) { display: none; }
            /* Remove outer border wrapper previously used */
            .stories-table-wrapper { border: none; }
        </style>

        <div id="pager" data-page-index="@Model.PageIndex" data-page-size="@Model.PageSize" data-total-count="@Model.TotalCount" data-search="@Model.Search" data-order-by="@Model.OrderBy" style="display:none;"></div>
    </div>
</div>

<form id="bulkEvaluateForm" method="post" asp-page-handler="EvaluateAll">
    @Html.AntiForgeryToken()
    <input type="hidden" name="agentId" id="bulkEvaluateAgentId" />
</form>
<audio id="ttsPlaylistAudio" class="d-none"></audio>

<!-- Modal per riprodurre final mix dalla pagina Stories -->
<div class="modal fade" id="finalMixModal" tabindex="-1" aria-labelledby="finalMixModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="finalMixModalLabel">Riproduci Final Mix</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <audio id="homeFinalMixAudio" controls preload="none" style="width:100%;">
                    Il tuo browser non supporta l'audio.
                </audio>
                <div id="finalMixInfo" class="mt-2 text-muted small"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function(){
        document.addEventListener('click', function(e){
            var btn = e.target.closest && e.target.closest('.play-final-mix-btn');
            if (!btn) return;
            var storyId = btn.getAttribute('data-story-id');
            if (!storyId) return;
            e.preventDefault();
            var audio = document.getElementById('homeFinalMixAudio');
            var info = document.getElementById('finalMixInfo');
            audio.pause();
            audio.src = '/Stories/Index?handler=FinalMixAudio&id=' + encodeURIComponent(storyId);
            audio.load();
            info.textContent = 'Caricamento...';
            var modalEl = document.getElementById('finalMixModal');
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
            audio.onloadedmetadata = function(){
                info.textContent = 'Durata: ' + Math.floor((audio.duration||0)/60) + 'm ' + Math.round((audio.duration||0)%60) + 's';
                audio.play().catch(()=>{});
            };
            audio.onerror = function(){ info.textContent = 'Impossibile caricare l\'audio.'; };
            modalEl.addEventListener('hidden.bs.modal', function(){ audio.pause(); audio.removeAttribute('src'); audio.load(); info.textContent=''; }, { once: true });
        });
    })();
</script>

<!-- Coherence details modal -->
<div class="modal fade" id="coherenceModal" tabindex="-1" aria-labelledby="coherenceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="coherenceModalLabel">Dettagli valutazione coerenza</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="coherenceModalBody">
                <div class="text-center text-muted">Caricamento...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="/js/shared/list-ui.js"></script>
    <script>
        function bulkEvaluate(agentId) {
            const form = document.getElementById('bulkEvaluateForm');
            const input = document.getElementById('bulkEvaluateAgentId');
            if (!form || !input) return;
            input.value = agentId || '';
            form.submit();
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.toggle-evals').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-story-id');
                    const row = document.querySelector(`tr.story-evals-row[data-story-id="${id}"]`);
                    if (!row) return;
                    const isHidden = row.classList.contains('d-none');
                    row.classList.toggle('d-none', !isHidden);
                    btn.textContent = isHidden ? 'Nascondi' : 'Valutazioni';
                });
            });
        });
    </script>
    
    <script>
        (function initStoriesTable(){
            if (typeof jQuery === 'undefined') { document.addEventListener('DOMContentLoaded', initStoriesTable); return; }
            var scripts = ['/lib/datatables/js/jquery.dataTables.min.js','/lib/datatables/js/dataTables.bootstrap5.min.js','/lib/datatables/js/dataTables.buttons.min.js','/lib/datatables/js/buttons.bootstrap5.min.js','/lib/datatables/js/buttons.colVis.min.js'];
            var i=0; function load(u,cb){var s=document.createElement('script');s.src=u;s.onload=cb;s.onerror=cb;document.head.appendChild(s);} function next(){ if(i<scripts.length) load(scripts[i++], next); else init(); } next();
            function init(){ jQuery(document).ready(function($){ if(typeof $.fn.DataTable==='undefined'){ console.error('DataTables not loaded'); return; }
                var pageLen = @Model.PageSize;
                var table = $('#storiesTable').DataTable({
                    dom: "<'row mb-2'<'col-sm-6'B><'col-sm-6 text-end'f>>rt<'row mt-2'<'col-sm-6'il><'col-sm-6 text-end'p>>",
                    stateSave: true,
                    paging: true,
                    pageLength: pageLen || 10,
                    lengthChange: true,
                    lengthMenu: [[10,25,50,100],[10,25,50,100]],
                    order: [[1,'desc']],
                    columnDefs: [
                        { orderable: false, targets: [10,16,17] },
                        { targets: 0, width: '6rem', className: 'text-nowrap' }
                    ],
                    buttons: [
                        {
                            text: '<i class="bi bi-arrow-clockwise"></i> Refresh',
                            className: 'btn btn-sm btn-secondary',
                            action: function(e, dt, node, config) { location.reload(); }
                        }
                    ]
                });

                // wire column visibility menu to ListUI if present
                try { window.ListUI && window.ListUI.init && window.ListUI.init({ tableSelector: '#storiesTable', colsMenuId: 'colVisMenu' }); } catch(e){}

                // move external top buttons into DataTables Buttons container
                try {
                    var external = $('#externalButtons');
                    if (external.length) {
                        external.removeClass('d-none');
                        var dtBtns = $('#storiesTable_wrapper .dt-buttons');
                        if (dtBtns.length) dtBtns.append(external);
                        else $('.dt-buttons').append(external);
                        // rebind refresh
                        $('#refreshBtn').off('click').on('click', function(){ location.reload(); });
                    }
                } catch(e) {}

                // Preserve existing detail toggle behaviour (already bound by list-ui)
            }); }
        })();
    </script>
}
