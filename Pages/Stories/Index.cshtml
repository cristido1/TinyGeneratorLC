@page
@model TinyGenerator.Pages.Stories.IndexModel
@using TinyGenerator.Models
@{
    ViewData["Title"] = "Storie";
}

@functions {
    private string GetStatusCaption(StoryStatus status)
        => status == null ? string.Empty
            : !string.IsNullOrWhiteSpace(status.CaptionToExecute) ? status.CaptionToExecute
            : !string.IsNullOrWhiteSpace(status.Description) ? status.Description
            : status.Code ?? $"Status {status.Id}";

    private string? GetActionConfirmPrompt(string actionId)
        => actionId switch
        {
            "delete" => "Eliminare la storia?",
            "clone_revised" => "Creare una versione migliorata da story_revised?",
            "regen_ambient_tags" => "Rigenerare i tag RUMORI?",
            "regen_fx_tags" => "Rigenerare i tag FX?",
            "regen_music_tags" => "Rigenerare i tag MUSICA?",
            _ => "Confermi l'esecuzione di questa azione?"
        };
}

<form method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>

<!-- Hidden form for TestTtsSchema handler -->
<form id="testTtsSchemaForm" method="post" asp-page-handler="TestTtsSchema" style="display:none;">
    <input type="number" id="testTtsStoryIdInput" name="storyId" value="32" min="1" />
</form>

<form id="batchSummarizeForm" method="post" asp-page-handler="BatchSummarize" style="display:none;">
    @Html.AntiForgeryToken()
</form>
<form id="deleteLowRatedForm" method="post" asp-page-handler="DeleteLowRated" style="display:none;">
    @Html.AntiForgeryToken()
</form>
<form id="deleteAllEvaluationsForm" method="post" asp-page-handler="DeleteAllEvaluations" style="display:none;">
    @Html.AntiForgeryToken()
</form>
<form id="ensureTagStatusForm" method="post" asp-page-handler="EnsureTagStatusConsistency" style="display:none;">
    @Html.AntiForgeryToken()
</form>
<form id="realignCreatorModelIdsForm" method="post" asp-page-handler="RealignCreatorModelIds" style="display:none;">
    @Html.AntiForgeryToken()
</form>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}
@if (TempData["StatusMessage"] != null)
{
    <div class="alert alert-success">@TempData["StatusMessage"]</div>
}

<div class="page-wrapper">

    <div class="container-fluid">
        <style>
            /* Grigietto pager styles */
            #pager { padding: 8px 12px; text-align: right; }
            #pager .pagination { margin: 0; display: inline-flex; gap: 4px; }
            #pager .page-link {
                background: #f3f4f6; /* very light gray */
                color: #333;
                border: 1px solid #d7d7d7;
                min-width: 38px;
                text-align: center;
            }
            #pager .page-item.active .page-link {
                background: #e9ecef; /* slightly darker */
                color: #222;
                border-color: #cfcfcf;
            }
            #pager .page-item.disabled .page-link { opacity: 0.6; }
        </style>
        @{
            var orderedStatuses = (Model.Statuses ?? new List<StoryStatus>())
                .OrderBy(st => st.Step)
                .ThenBy(st => st.Id)
                .ToList();
        }
        <table class="table table-striped table-hover" id="storiesTable">
            <thead class="table-light">
                <tr>
                    <th data-col="rowdetail"></th>
                    <th data-col="id">Id</th>
                    <th data-col="timestamp">Timestamp</th>
                    <th data-col="serie">Serie</th>
                    <th data-col="title">Titolo</th>
                    <th data-col="episode">Episodio</th>
                    <th data-col="prompt">Prompt</th>
                    <th data-col="status">Status</th>
                    <th data-col="agent">Agente</th>
                    <th data-col="model">Modello</th>
                    <th data-col="folder">Cartella</th>
                    <th data-col="assets">Assets</th>
                    <th data-col="chars">Caratteri</th>
                    <th data-col="test">Test</th>
                    <th data-col="score">Score</th>
                    <th data-col="eval">Valutazione</th>
                    <th data-col="approved">Approved</th>
                    <th data-col="actions">Azioni</th>
                </tr>
            </thead>
            <tbody>
                @foreach(var s in Model.Stories)
                {
                    <tr data-story-id="@s.Id">
                        <td class="dt-control text-center align-middle" data-col="rowdetail"></td>
                        <td data-col="id">@s.Id</td>
                        <td data-col="timestamp">@((DateTime.TryParse(s.Timestamp, out var _dt)) ? _dt.ToString("dd/MM/yyyy HH:mm") : s.Timestamp)</td>
                        <td data-col="serie">@(!string.IsNullOrWhiteSpace(s.SerieName) ? s.SerieName : "-")</td>
                        <td data-col="title">@(!string.IsNullOrWhiteSpace(s.Title) ? s.Title : "<span class='text-muted'>-</span>")</td>
                        <td data-col="episode">@((s.SerieEpisode.HasValue && s.SerieEpisode.Value > 0) ? s.SerieEpisode.Value.ToString() : "-")</td>
                        @{
                            var promptSafe = s.Prompt ?? string.Empty;
                        }
                        <td data-col="prompt" title="@promptSafe">@((promptSafe.Length > 120) ? (promptSafe.Substring(0, 120) + "...") : promptSafe)</td>
                        <td data-col="status">@(!string.IsNullOrWhiteSpace(s.Status) ? s.Status : "-")</td>
                        <td data-col="agent">@s.Agent</td>
                        <td data-col="model">@s.Model</td>
                        <td data-col="folder">@s.Folder</td>
                        <td data-col="assets">
                            @if (!string.IsNullOrWhiteSpace(s.StoryTagged)) { <span title="Story tagged" class="text-dark me-1"><i class="bi bi-tags-fill"></i></span>; }
                            @if (s.GeneratedTtsJson) { <span title="TTS JSON" class="text-primary me-1"><i class="bi bi-file-earmark-text-fill"></i></span>; }
                            @if (s.GeneratedTts) { <span title="TTS audio" class="text-success me-1"><i class="bi bi-volume-up-fill"></i></span>; }
                            @if (s.GeneratedAmbient) { <span title="Ambience" class="text-info me-1"><i class="bi bi-cloud-fill"></i></span>; }
                            @if (s.GeneratedEffects) { <span title="FX" class="text-warning me-1"><i class="bi bi-lightning-charge-fill"></i></span>; }
                            @if (s.GeneratedMusic) { <span title="Music" class="text-muted me-1"><i class="bi bi-music-note-beamed"></i></span>; }
                            @if (s.GeneratedMixedAudio) {
                                <button type="button" class="btn btn-sm btn-link p-0 me-2 play-final-mix-btn" data-story-id="@s.Id" title="Play final mix"><i class="bi bi-play-circle-fill" style="color:#0d6efd;font-size:1.25rem;"></i></button>
                            }
                        </td>
                        <td data-col="chars" class="text-end">@s.CharCount</td>
                        <td data-col="test">@((s.TestRunId>0) ? $"Run {s.TestRunId}" : "-")</td>
                        <td data-col="score">@s.Score</td>
                        <td data-col="eval">@((s.Evaluations!=null && s.Evaluations.Any()) ? (s.Evaluations.Average(e=>e.TotalScore)*100.0/40.0).ToString("F1") + "/100" : "-")</td>
                        <td data-col="approved">@(s.Approved ? "✅" : "❌")</td>
                        <td data-col="actions">
                            @{
                                var currentStep = s.StatusStep ?? 0;
                                var completedStatuses = orderedStatuses.Where(st => st.Step <= currentStep).ToList();
                                var nextStatus = orderedStatuses.FirstOrDefault(st => st.Step > currentStep);
                                var rawActions = Model.GetActionsForStory(s)?.ToList() ?? new List<object>();
                                rawActions = rawActions.Where(a =>
                                {
                                    var id = a.GetType().GetProperty("id")?.GetValue(a)?.ToString() ?? string.Empty;
                                    var title = a.GetType().GetProperty("title")?.GetValue(a)?.ToString() ?? string.Empty;
                                    if (id == "start_chain" || id == "clone_revised") return false;
                                    if (id == "final_mix_play" || id == "tts_playlist") return false;
                                    if (!string.IsNullOrWhiteSpace(title) &&
                                        (title.Equals("Ascolta mix finale", StringComparison.OrdinalIgnoreCase) ||
                                         title.Equals("Ascolta sequenza tts", StringComparison.OrdinalIgnoreCase)))
                                    {
                                        return false;
                                    }
                                    return true;
                                }).ToList();

                                var orderedActions = new List<object>();
                                object? detailsAction = rawActions.FirstOrDefault(a => string.Equals(a.GetType().GetProperty("id")?.GetValue(a)?.ToString(), "details", StringComparison.OrdinalIgnoreCase));
                                object? editAction = rawActions.FirstOrDefault(a => string.Equals(a.GetType().GetProperty("id")?.GetValue(a)?.ToString(), "edit", StringComparison.OrdinalIgnoreCase));
                                object? deleteAction = rawActions.FirstOrDefault(a => string.Equals(a.GetType().GetProperty("id")?.GetValue(a)?.ToString(), "delete", StringComparison.OrdinalIgnoreCase));
                                void TryAddPriority(ref object? action)
                                {
                                    if (action != null)
                                    {
                                        orderedActions.Add(action);
                                        rawActions.Remove(action);
                                        action = null;
                                    }
                                }
                                TryAddPriority(ref detailsAction);
                                TryAddPriority(ref editAction);
                                TryAddPriority(ref deleteAction);
                                orderedActions.AddRange(rawActions);
                            }
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Azioni</button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    @foreach (var action in orderedActions)
                                    {
                                        var actionId = action.GetType().GetProperty("id")?.GetValue(action)?.ToString() ?? string.Empty;
                                        var title = action.GetType().GetProperty("title")?.GetValue(action)?.ToString() ?? string.Empty;
                                        var method = action.GetType().GetProperty("method")?.GetValue(action)?.ToString() ?? "GET";
                                        var url = action.GetType().GetProperty("url")?.GetValue(action)?.ToString() ?? "#";
                                        var confirm = action.GetType().GetProperty("confirm")?.GetValue(action) as bool? ?? false;
                                        var confirmMessage = confirm ? GetActionConfirmPrompt(actionId) ?? "Confermi?" : null;
                                        if (method.Equals("POST", StringComparison.OrdinalIgnoreCase))
                                        {
                                            <li>
                                                <form method="post" action="@url" class="m-0">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="dropdown-item" @(confirmMessage != null ? $"onclick=\"return confirm('{confirmMessage}')\"" : string.Empty)>
                                                        @title
                                                    </button>
                                                </form>
                                            </li>
                                        }
                                        else
                                        {
                                            <li><a class="dropdown-item" href="@url">@title</a></li>
                                        }
                                    }

                                    <li><hr class="dropdown-divider" /></li>
                                    <li>
                                        <form method="post" asp-page-handler="CompleteStory" class="m-0">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@s.Id" />
                                            <button type="submit" class="dropdown-item text-success" @(nextStatus == null ? "disabled" : string.Empty)>Completa storia</button>
                                        </form>
                                    </li>
                                    @if (!string.IsNullOrWhiteSpace(s.StoryRevised) && (s.Evaluations?.Count ?? 0) >= 2)
                                    {
                                        <li>
                                            <form method="post" asp-page-handler="CloneFromRevised" class="m-0" onsubmit="return confirm('Creare una versione migliorata da story_revised?');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@s.Id" />
                                                <button type="submit" class="dropdown-item">Crea versione migliorata</button>
                                            </form>
                                        </li>
                                    }
                                </ul>
                            </div>

                            <template id="evalsTpl-@s.Id">
                                @if (s.Evaluations != null && s.Evaluations.Any())
                                {
                                    foreach (var e in s.Evaluations)
                                    {
                                        <partial name="_StoryEvaluationCard" model="e" />
                                    }
                                }
                                else
                                {
                                    <div class="text-muted">Nessuna valutazione</div>
                                }
                            </template>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        

        <style>
            /* Child row container for DataTables row.child() */
            .story-evals-child { padding: .75rem; }
            .story-evals-child > .inner {
                padding: 1rem;
                background: #f8f9fa;
                border: 1px solid rgba(0,0,0,.125);
                border-radius: .5rem;
                max-width: 100%;
                overflow-x: auto;
                white-space: normal;
                word-break: break-word;
            }

            /* DataTables details-control column: let DataTables Bootstrap CSS render the arrow via :before */
            td.dt-control {
                width: 34px;
                min-width: 34px;
                max-width: 34px;
                padding: 0.25rem 0.25rem;
                user-select: none;
            }
        </style>

        <div id="pager" data-page-index="@Model.PageIndex" data-page-size="@Model.PageSize" data-total-count="@Model.TotalCount" data-search="@Model.Search" data-order-by="@Model.OrderBy" style="display:none;"></div>
    </div>
</div>

<form id="bulkEvaluateForm" method="post" asp-page-handler="EvaluateAll">
    @Html.AntiForgeryToken()
    <input type="hidden" name="agentId" id="bulkEvaluateAgentId" />
</form>
<audio id="ttsPlaylistAudio" class="d-none"></audio>

<!-- Modal per riprodurre final mix dalla pagina Stories -->
<div class="modal fade" id="finalMixModal" tabindex="-1" aria-labelledby="finalMixModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="finalMixModalLabel">Riproduci Final Mix</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <audio id="homeFinalMixAudio" controls preload="none" style="width:100%;">
                    Il tuo browser non supporta l'audio.
                </audio>
                <div id="finalMixInfo" class="mt-2 text-muted small"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function(){
        document.addEventListener('click', function(e){
            var btn = e.target.closest && e.target.closest('.play-final-mix-btn');
            if (!btn) return;
            var storyId = btn.getAttribute('data-story-id');
            if (!storyId) return;
            e.preventDefault();
            var audio = document.getElementById('homeFinalMixAudio');
            var info = document.getElementById('finalMixInfo');
            audio.pause();
            audio.src = '/Stories/Index?handler=FinalMixAudio&id=' + encodeURIComponent(storyId);
            audio.load();
            info.textContent = 'Caricamento...';
            var modalEl = document.getElementById('finalMixModal');
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
            audio.onloadedmetadata = function(){
                info.textContent = 'Durata: ' + Math.floor((audio.duration||0)/60) + 'm ' + Math.round((audio.duration||0)%60) + 's';
                audio.play().catch(()=>{});
            };
            audio.onerror = function(){ info.textContent = 'Impossibile caricare l\'audio.'; };
            modalEl.addEventListener('hidden.bs.modal', function(){ audio.pause(); audio.removeAttribute('src'); audio.load(); info.textContent=''; }, { once: true });
        });
    })();
</script>

<!-- Coherence details modal -->
<div class="modal fade" id="coherenceModal" tabindex="-1" aria-labelledby="coherenceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="coherenceModalLabel">Dettagli valutazione coerenza</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="coherenceModalBody">
                <div class="text-center text-muted">Caricamento...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="/js/shared/list-ui.js"></script>
    <script>
        const evaluatorAgents = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.Evaluators.Select(ev => new
            {
                id = ev.Id,
                name = ev.Name ?? string.Empty,
                role = ev.Role ?? string.Empty
            })
        ));

        function bulkEvaluate(agentId) {
            const form = document.getElementById('bulkEvaluateForm');
            const input = document.getElementById('bulkEvaluateAgentId');
            if (!form || !input) return;
            input.value = agentId || '';
            form.submit();
        }

        function testTtsSchema() {
            const form = document.getElementById('testTtsSchemaForm');
            form?.submit();
        }

        function submitHiddenForm(formId, confirmMessage) {
            const form = document.getElementById(formId);
            if (!form) return;
            if (confirmMessage && !window.confirm(confirmMessage)) return;
            form.submit();
        }

        // handled via DataTables row.child() toggle (see initStoriesTable)
    </script>
    
    <script>
        (function initStoriesTable(){
            if (typeof jQuery === 'undefined') { document.addEventListener('DOMContentLoaded', initStoriesTable); return; }
            var scripts = ['/lib/datatables/js/jquery.dataTables.min.js','/lib/datatables/js/dataTables.bootstrap5.min.js','/lib/datatables/js/dataTables.buttons.min.js','/lib/datatables/js/buttons.bootstrap5.min.js','/lib/datatables/js/buttons.colVis.min.js'];
            var i=0;
            function load(url, cb) {
                var script = document.createElement('script');
                script.src = url;
                script.onload = cb;
                script.onerror = cb;
                document.head.appendChild(script);
            }
            function nextScript() {
                if (i < scripts.length) {
                    load(scripts[i++], nextScript);
                } else {
                    init();
                }
            }
            nextScript();

            function init(){ jQuery(document).ready(function($){
                if (typeof $.fn.DataTable === 'undefined') {
                    console.error('DataTables non caricato');
                    return;
                }

                const pageLen = @Model.PageSize;
                const evaluatorCollection = evaluatorAgents && evaluatorAgents.length
                    ? evaluatorAgents.map(ev => ({
                        text: `${ev.name} (${ev.role})`,
                        action: function() { bulkEvaluate(ev.id); }
                    }))
                    : [{
                        text: 'Nessun evaluator attivo',
                        enabled: false
                    }];

                const table = $('#storiesTable').DataTable({
                    dom: "<'row mb-2'<'col-sm-6'B><'col-sm-6 text-end'f>>rt<'row mt-2'<'col-sm-6'il><'col-sm-6 text-end'p>>",
                    stateSave: true,
                    stateDuration: -1,
                    stateSaveCallback: function (settings, data) {
                        try {
                            localStorage.setItem('storiesTableState', JSON.stringify(data));
                        } catch (e) {
                            console.warn('Impossibile salvare lo stato della tabella', e);
                        }
                    },
                    stateLoadCallback: function () {
                        try {
                            const data = localStorage.getItem('storiesTableState');
                            return data ? JSON.parse(data) : null;
                        } catch (e) {
                            console.warn('Impossibile caricare lo stato della tabella', e);
                            return null;
                        }
                    },
                    paging: true,
                    pageLength: pageLen || 10,
                    lengthChange: true,
                    lengthMenu: [[10,25,50,100],[10,25,50,100]],
                    order: [[2,'desc']],
                    columnDefs: [
                        { orderable: false, targets: [0,11,17] }
                    ],
                    buttons: [
                        {
                            text: '<i class="bi bi-plus-lg me-1"></i> Nuova storia',
                            className: 'btn btn-sm btn-light border text-primary',
                            action: function() { window.location.href = '/Stories/Create'; },
                            attr: { style: 'width: auto; flex: 0 0 auto;' }
                        },
                        {
                            extend: 'colvis',
                            text: '<i class="bi bi-justify me-1"></i> Colonne',
                            className: 'btn btn-sm btn-light border',
                            attr: { style: 'width: auto; flex: 0 0 auto;' }
                        },
                        {
                            text: '<i class="bi bi-box me-1"></i> Test TTS',
                            className: 'btn btn-sm btn-light border',
                            action: function() { testTtsSchema(); },
                            attr: { style: 'width: auto; flex: 0 0 auto;' }
                        },
                        {
                            text: '<i class="bi bi-file-text me-1"></i> Riassunti Batch',
                            className: 'btn btn-sm btn-light border text-info',
                            action: function() { submitHiddenForm('batchSummarizeForm', 'Avviare la generazione batch dei riassunti per tutte le storie con valutazione >= 60?'); },
                            attr: { style: 'width: auto; flex: 0 0 auto;' }
                        },
                        {
                            text: '<i class="bi bi-trash me-1"></i> Elimina storie scadenti',
                            className: 'btn btn-sm btn-light border text-danger',
                            action: function() { submitHiddenForm('deleteLowRatedForm', 'Eliminare tutte le storie con valutazione media <50 e almeno 2 valutazioni? Questa operazione è irreversibile.'); },
                            attr: { style: 'width: auto; flex: 0 0 auto;' }
                        },
                        {
                            text: '<i class="bi bi-eraser me-1"></i> Cancella tutte le valutazioni',
                            className: 'btn btn-sm btn-light border text-danger',
                            action: function() { submitHiddenForm('deleteAllEvaluationsForm', 'Cancellare TUTTE le valutazioni per TUTTE le storie (incluse coerenza e valutazioni azione/ritmo)? Questa operazione è irreversibile.'); },
                            attr: { style: 'width: auto; flex: 0 0 auto;' }
                        },
                        {
                            text: '<i class="bi bi-arrow-counterclockwise me-1"></i> Verifica story_tags',
                            className: 'btn btn-sm btn-light border text-warning',
                            action: function() { submitHiddenForm('ensureTagStatusForm', 'Allineare gli stati delle storie mancanti di story_tags? Le storie senza tag torneranno indietro agli step appropriati.'); },
                            attr: { style: 'width: auto; flex: 0 0 auto;' }
                        },
                        {
                            text: '<i class="bi bi-wrench-adjustable me-1"></i> Allinea model_id',
                            className: 'btn btn-sm btn-light border text-warning',
                            action: function() { submitHiddenForm('realignCreatorModelIdsForm', 'Allineare model_id delle storie al model_id configurato dell\'agente (agent_id)? Non modifica agent_id. Operazione consigliata solo se hai storie con agent/modello incoerenti.'); },
                            attr: { style: 'width: auto; flex: 0 0 auto;' }
                        },
                        {
                            extend: 'collection',
                            text: '<i class="bi bi-check2-all me-1"></i> Valuta tutti',
                            className: 'btn btn-sm btn-light border',
                            collectionLayout: 'fixed two-column',
                            buttons: evaluatorCollection,
                            attr: { style: 'width: auto; flex: 0 0 auto;' }
                        },
                        {
                            text: '<i class="bi bi-arrow-clockwise me-1"></i> Refresh',
                            className: 'btn btn-sm btn-light border',
                            action: function() { location.reload(); },
                            attr: { style: 'width: auto; flex: 0 0 auto;' }
                        }
                    ]
                });

                // Expandable row details (DataTables official row.child() pattern)
                // Using child rows avoids distorting column widths when details expand.
                $('#storiesTable tbody').on('click', 'td.dt-control', function(e){
                    e.preventDefault();
                    e.stopPropagation();

                    const $td = $(this);
                    const $tr = $td.closest('tr');
                    const row = table.row($tr);
                    if (!row) return;

                    const storyId = $tr.data('story-id');

                    if (row.child.isShown()) {
                        row.child.hide();
                        return;
                    }

                    const tpl = document.getElementById('evalsTpl-' + storyId);
                    const bodyHtml = (tpl && tpl.innerHTML) ? tpl.innerHTML : '<div class=\"text-muted\">Nessuna valutazione</div>';
                    const childHtml = '<div class=\"story-evals-child\"><div class=\"inner\">' + bodyHtml + '</div></div>';
                    row.child(childHtml, 'story-child-row').show();
                });

                try { window.ListUI && window.ListUI.init && window.ListUI.init({ tableSelector: '#storiesTable', colsMenuId: 'colVisMenu' }); } catch(e){}
            }); }
        })();
    </script>
}
