@page
@model TinyGenerator.Pages.TaskTypes.IndexModel
@{
    ViewData["Title"] = "Task Types";
}

<div class="page-wrapper">
    <div class="d-flex mb-2 align-items-center toolbar-row">
        <input id="globalFilter" class="form-control form-control-sm" style="max-width:220px;" placeholder="Cerca..." />
        <div class="ms-auto d-flex gap-1">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Colonne visibili">
                    <i class="bi bi-layout-three-columns"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="taskTypesGridColVisMenu" style="min-width: 180px;"></ul>
            </div>
            <button id="refreshBtn" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">Refresh</button>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalEdit" onclick="openCreateModal()">Nuovo</button>
        </div>
    </div>

    <div id="taskTypesGrid" class="ag-theme-alpine" style="height: calc(100vh - 180px); width: 100%;"></div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalEdit" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-page-handler="Save">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Create Task Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="codeInput" class="form-label">Code <span class="text-danger">*</span></label>
                        <input type="text" id="codeInput" name="Code" class="form-control" required maxlength="100" />
                    </div>
                    <div class="mb-3">
                        <label for="descInput" class="form-label">Description</label>
                        <textarea id="descInput" name="Description" class="form-control" rows="2" maxlength="500"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="execRole" class="form-label">Default Executor Role</label>
                            <input id="execRole" name="DefaultExecutorRole" class="form-control" maxlength="100" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="checkRole" class="form-label">Default Checker Role</label>
                            <input id="checkRole" name="DefaultCheckerRole" class="form-control" maxlength="100" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="mergeStrategy" class="form-label">Output Merge Strategy</label>
                        <input id="mergeStrategy" name="OutputMergeStrategy" class="form-control" maxlength="100" />
                        <div class="form-text">Examples: <code>accumulate_chapters</code>, <code>last_only</code></div>
                    </div>
                    <div class="mb-3">
                        <label for="validationCriteria" class="form-label">Validation Criteria (JSON)</label>
                        <textarea id="validationCriteria" name="ValidationCriteria" class="form-control font-monospace" rows="6" placeholder='{"min_length_check":true}'></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Task Type Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        window.__tasktypes_data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TaskTypes));
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rowData = window.__tasktypes_data || [];

            const columnDefs = [
                { headerName: 'Code', field: 'Code', flex: 1 },
                { headerName: 'Description', field: 'Description', flex: 2 },
                { headerName: 'Executor Role', field: 'DefaultExecutorRole', width: 150 },
                { headerName: 'Checker Role', field: 'DefaultCheckerRole', width: 150 },
                { headerName: 'Merge Strategy', field: 'OutputMergeStrategy', width: 160 },
                {
                    headerName: 'Actions', colId: 'actions', width: 200, suppressColumnsToolPanel: true,
                    cellRenderer: params => {
                        const code = params.data.Code;
                        return `<button class="btn btn-sm btn-outline-secondary me-1 btn-details" data-code="${escapeAttr(code)}">+</button>` +
                               `<button class="btn btn-sm btn-outline-primary me-1 btn-edit" data-code="${escapeAttr(code)}">Edit</button>` +
                               `<button class="btn btn-sm btn-outline-danger btn-delete" data-code="${escapeAttr(code)}">Delete</button>`;
                    }
                }
            ];

            AgGridHelper.init('taskTypesGrid', columnDefs, rowData, {
                storageKey: 'agGrid_taskTypes_colVis',
                pageSize: 25
            });

            // Quick filter
            document.getElementById('globalFilter')?.addEventListener('input', e => {
                window.taskTypesGridApi?.setQuickFilter(e.target.value);
            });

            // Grid click handlers
            document.getElementById('taskTypesGrid').addEventListener('click', e => {
                const detailsBtn = e.target.closest('.btn-details');
                if (detailsBtn) {
                    const code = detailsBtn.dataset.code;
                    const item = rowData.find(r => r.Code === code);
                    if (item) showDetails(item);
                }
                
                const editBtn = e.target.closest('.btn-edit');
                if (editBtn) {
                    const code = editBtn.dataset.code;
                    const item = rowData.find(r => r.Code === code);
                    if (item) openEditModal(item);
                }

                const deleteBtn = e.target.closest('.btn-delete');
                if (deleteBtn) {
                    const code = deleteBtn.dataset.code;
                    if (confirm('Delete task type ' + code + '?')) {
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.innerHTML = `<input type="hidden" name="code" value="${escapeAttr(code)}"/>`;
                        form.action = '?handler=Delete';
                        document.body.appendChild(form);
                        form.submit();
                    }
                }
            });

            function showDetails(item) {
                const body = document.getElementById('detailsModalBody');
                body.innerHTML = `
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Code</dt><dd class="col-sm-8">${escapeHtml(item.Code)}</dd>
                        <dt class="col-sm-4">Description</dt><dd class="col-sm-8">${escapeHtml(item.Description || '')}</dd>
                        <dt class="col-sm-4">Executor Role</dt><dd class="col-sm-8">${escapeHtml(item.DefaultExecutorRole || '')}</dd>
                        <dt class="col-sm-4">Checker Role</dt><dd class="col-sm-8">${escapeHtml(item.DefaultCheckerRole || '')}</dd>
                        <dt class="col-sm-4">Merge Strategy</dt><dd class="col-sm-8">${escapeHtml(item.OutputMergeStrategy || '')}</dd>
                    </dl>
                    ${item.ValidationCriteria ? `<hr/><strong>Validation Criteria:</strong><pre class="bg-light p-2 mt-2" style="max-height:200px;overflow:auto;">${escapeHtml(item.ValidationCriteria)}</pre>` : ''}
                `;
                new bootstrap.Modal(document.getElementById('detailsModal')).show();
            }

            window.openEditModal = function(item) {
                document.getElementById('modalTitle').textContent = 'Edit Task Type: ' + item.Code;
                document.getElementById('codeInput').value = item.Code;
                document.getElementById('descInput').value = item.Description || '';
                document.getElementById('execRole').value = item.DefaultExecutorRole || '';
                document.getElementById('checkRole').value = item.DefaultCheckerRole || '';
                document.getElementById('mergeStrategy').value = item.OutputMergeStrategy || '';
                document.getElementById('validationCriteria').value = item.ValidationCriteria || '';
                new bootstrap.Modal(document.getElementById('modalEdit')).show();
            };

            window.openCreateModal = function() {
                document.getElementById('modalTitle').textContent = 'Create Task Type';
                document.getElementById('codeInput').value = '';
                document.getElementById('descInput').value = '';
                document.getElementById('execRole').value = '';
                document.getElementById('checkRole').value = '';
                document.getElementById('mergeStrategy').value = '';
                document.getElementById('validationCriteria').value = '';
            };

            function escapeHtml(text) {
                if (!text) return '';
                return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"})[m]);
            }
            function escapeAttr(text) {
                return escapeHtml(text).replace(/'/g, '&#39;');
            }
        });
    </script>
}
