@page
@model TinyGenerator.Pages.TestDefinitions.IndexModel
@{
    ViewData["Title"] = "Test Definitions";
    ViewData["PageDescription"] = "Crea e gestisci le definizioni dei test";
}

<div class="page-wrapper">
    <div class="d-flex mb-2 align-items-center toolbar-row">
        <input id="globalFilter" class="form-control form-control-sm" style="max-width:220px;" placeholder="Cerca..." />
        <div class="ms-auto d-flex gap-1 align-items-center">
            <div class="form-check me-2">
                <input class="form-check-input" type="checkbox" id="chkShowDisabled" checked="@Model.ShowDisabled" onchange="window.location.href='?ShowDisabled=' + (this.checked ? 'true' : 'false');" />
                <label class="form-check-label" for="chkShowDisabled">Show Disabled</label>
            </div>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Colonne visibili">
                    <i class="bi bi-layout-three-columns"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="testDefsGridColVisMenu" style="min-width: 180px;"></ul>
            </div>
            <button id="refreshBtn" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">Refresh</button>
            <a class="btn btn-sm btn-primary" asp-page="./Edit">Nuovo</a>
        </div>
    </div>

    <div id="testDefsGrid" class="ag-theme-alpine" style="height: calc(100vh - 180px); width: 100%;"></div>
</div>

<!-- Details Modal for Prompt -->
<div class="modal fade" id="promptModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prompt Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="promptModalBody">
                <pre class="bg-light p-3" style="white-space:pre-wrap;word-break:break-word;font-size:0.9rem;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        window.__testdefs_data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Definitions));
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rowData = window.__testdefs_data || [];

            const columnDefs = [
                { headerName: 'Group', field: 'GroupName', width: 120 },
                { headerName: 'Library', field: 'Library', width: 100 },
                { headerName: 'Function', field: 'FunctionName', flex: 1 },
                { headerName: 'Priority', field: 'Priority', width: 90 },
                { headerName: 'Timeout (s)', field: 'TimeoutSecs', width: 100, valueFormatter: p => p.value > 0 ? p.value : '' },
                { headerName: 'Test Type', field: 'TestType', width: 100 },
                { headerName: 'Allowed Plugins', field: 'AllowedPlugins', width: 130 },
                { headerName: 'Response Format', field: 'JsonResponseFormat', width: 130 },
                { headerName: 'Execution Plan', field: 'ExecutionPlan', width: 130 },
                { headerName: 'Active', field: 'Active', width: 80, valueFormatter: p => p.value ? 'Yes' : 'No' },
                {
                    headerName: 'Actions', colId: 'actions', width: 180, suppressColumnsToolPanel: true,
                    cellRenderer: params => {
                        const id = params.data.Id;
                        const hasPrompt = params.data.Prompt && params.data.Prompt.trim().length > 0;
                        return `<button class="btn btn-sm btn-outline-secondary me-1 btn-details" data-id="${id}" ${!hasPrompt ? 'disabled' : ''} title="Show prompt">+</button>` +
                               `<a class="btn btn-sm btn-outline-primary me-1" href="/TestDefinitions/Edit?id=${id}">Edit</a>` +
                               `<a class="btn btn-sm btn-outline-danger" href="/TestDefinitions/Delete?id=${id}">Delete</a>`;
                    }
                }
            ];

            AgGridHelper.init('testDefsGrid', columnDefs, rowData, {
                storageKey: 'agGrid_testDefs_colVis',
                pageSize: 25
            });

            // Quick filter
            document.getElementById('globalFilter')?.addEventListener('input', e => {
                window.testDefsGridApi?.setQuickFilter(e.target.value);
            });

            // Grid click handlers
            document.getElementById('testDefsGrid').addEventListener('click', e => {
                const detailsBtn = e.target.closest('.btn-details');
                if (detailsBtn && !detailsBtn.disabled) {
                    const id = parseInt(detailsBtn.dataset.id);
                    const item = rowData.find(r => r.Id === id);
                    if (item && item.Prompt) {
                        document.querySelector('#promptModalBody pre').textContent = item.Prompt;
                        new bootstrap.Modal(document.getElementById('promptModal')).show();
                    }
                }
            });
        });
    </script>
}
