@page
@model TinyGenerator.Pages.TtsVoices.IndexModel
@{
    ViewData["Title"] = "TTS Voices";
}

<form id="ttsRefreshForm" method="post" class="d-none">
    @Html.AntiForgeryToken()
</form>

<!-- Toast for update feedback -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
    <div id="ttsToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">TTS voices</strong>
            <small class="text-muted" id="ttsToastTime"></small>
            <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="ttsToastBody">Aggiornamento completato</div>
    </div>
</div>

@if (TempData["TtsVoiceMessage"] != null)
{
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            try {
                var msg = '@TempData["TtsVoiceMessage"]'.replace(/\r?\n/g, ' ');
                var t = new bootstrap.Toast(document.getElementById('ttsToast'));
                document.getElementById('ttsToastBody').innerText = msg;
                document.getElementById('ttsToastTime').innerText = new Date().toLocaleTimeString();
                t.show();
            } catch(e) { /* ignore */ }
        });
    </script>
}

<div class="page-wrapper">
    <div class="d-flex mb-2 align-items-center toolbar-row">
        <input id="globalFilter" class="form-control form-control-sm" style="max-width:220px;" placeholder="Cerca..." />
        <div class="ms-auto d-flex gap-1">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Colonne visibili">
                    <i class="bi bi-layout-three-columns"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="ttsVoicesGridColVisMenu" style="min-width: 180px;"></ul>
            </div>
            <button id="refreshVoicesBtn" class="btn btn-sm btn-outline-secondary">Sync Voices</button>
            <a class="btn btn-sm btn-primary" href="/TtsVoices/Edit">Nuovo</a>
        </div>
    </div>

    <div id="ttsVoicesGrid" class="ag-theme-alpine" style="height: calc(100vh - 180px); width: 100%;"></div>
</div>

@section Scripts {
    <script>
        window.__ttsvoices_data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Voices));
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let rowData = window.__ttsvoices_data || [];
            const refreshForm = document.getElementById('ttsRefreshForm');
            const toastEl = document.getElementById('ttsToast');
            const bsToast = toastEl ? new bootstrap.Toast(toastEl) : null;

            function showToast(message) {
                if (bsToast) {
                    document.getElementById('ttsToastBody').innerText = message;
                    document.getElementById('ttsToastTime').innerText = new Date().toLocaleTimeString();
                    bsToast.show();
                } else {
                    alert(message);
                }
            }

            const columnDefs = [
                {
                    headerName: 'Actions', colId: 'actions', width: 140, suppressColumnsToolPanel: true,
                    cellRenderer: params => {
                        const id = params.data.Id;
                        const voiceId = params.data.VoiceId || '';
                        return `<div class="d-flex align-items-center gap-1">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">☰</button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/TtsVoices/Edit?id=${id}">Edit</a></li>
                                    <li><a class="dropdown-item action-regenerate" href="#" data-id="${id}" data-voiceid="${escapeAttr(voiceId)}">Rigenera esempio</a></li>
                                    <li><a class="dropdown-item action-delete text-danger" href="#" data-id="${id}">Delete</a></li>
                                </ul>
                            </div>
                            <button class="btn btn-sm btn-outline-primary play-sample" data-voiceid="${escapeAttr(voiceId)}" title="Play sample">▶️</button>
                        </div>`;
                    }
                },
                { headerName: 'Name', field: 'Name', flex: 1 },
                { headerName: 'VoiceId', field: 'VoiceId', width: 150 },
                { headerName: 'Model', field: 'Model', width: 120 },
                { headerName: 'Language', field: 'Language', width: 100 },
                { headerName: 'Gender', field: 'Gender', width: 90 },
                { headerName: 'Age', field: 'Age', width: 80 },
                { headerName: 'Confidence', field: 'Confidence', width: 100, valueFormatter: p => p.value != null ? p.value.toFixed(2) : '-' },
                {
                    headerName: 'Score', field: 'Score', width: 120,
                    cellRenderer: params => {
                        const id = params.data.Id;
                        const val = params.value != null ? params.value : '-';
                        return `<div class="d-flex align-items-center gap-1">
                            <button class="btn btn-sm btn-outline-success score-inc" data-id="${id}" title="Increase">+</button>
                            <span class="fw-semibold score-value" data-id="${id}">${val}</span>
                            <button class="btn btn-sm btn-outline-danger score-dec" data-id="${id}" title="Decrease">-</button>
                        </div>`;
                    }
                },
                { headerName: 'Tags', field: 'Tags', width: 150 },
                { headerName: 'Template', field: 'TemplateWav', width: 120 },
                { headerName: 'Archetype', field: 'Archetype', width: 120 },
                { headerName: 'Notes', field: 'Notes', flex: 1 },
                { headerName: 'Created', field: 'CreatedAt', width: 160, hide: true },
                { headerName: 'Updated', field: 'UpdatedAt', width: 160, hide: true }
            ];

            AgGridHelper.init('ttsVoicesGrid', columnDefs, rowData, {
                storageKey: 'agGrid_ttsVoices_colVis',
                pageSize: 25
            });

            // Quick filter
            document.getElementById('globalFilter')?.addEventListener('input', e => {
                window.ttsVoicesGridApi?.setQuickFilter(e.target.value);
            });

            // Refresh/sync voices
            document.getElementById('refreshVoicesBtn').addEventListener('click', async function() {
                const btn = this;
                if (!refreshForm) return;
                btn.disabled = true;
                const oldText = btn.textContent;
                btn.textContent = 'Syncing...';
                try {
                    const body = new FormData(refreshForm);
                    const r = await fetch('?handler=Refresh', { method: 'POST', body, credentials: 'same-origin' });
                    if (!r.ok) throw new Error('Server returned ' + r.status);
                    const json = await r.json();
                    if (json && json.voices) {
                        rowData = json.voices;
                        window.ttsVoicesGridApi?.setGridOption('rowData', rowData);
                        const addedCount = json.added || 0;
                        const updatedCount = json.updated || 0;
                        let msg = addedCount > 0 ? `Aggiunte ${addedCount} voci` : 'Aggiornamento completato';
                        if (updatedCount > 0) msg += ` (${updatedCount} aggiornate)`;
                        showToast(msg);
                    } else {
                        throw new Error(json?.error || 'Invalid response');
                    }
                } catch (ex) {
                    showToast('Aggiornamento fallito: ' + ex.message);
                } finally {
                    btn.disabled = false;
                    btn.textContent = oldText;
                }
            });

            // Grid click handlers
            document.getElementById('ttsVoicesGrid').addEventListener('click', async e => {
                // Play sample
                const playBtn = e.target.closest('.play-sample');
                if (playBtn) {
                    const voiceId = playBtn.dataset.voiceid;
                    if (!voiceId) return;
                    try {
                        const resp = await fetch('?handler=Sample&voiceId=' + encodeURIComponent(voiceId));
                        if (!resp.ok) throw new Error('Sample not available');
                        const arr = await resp.arrayBuffer();
                        const blob = new Blob([arr], { type: resp.headers.get('content-type') || 'audio/*' });
                        const url = URL.createObjectURL(blob);
                        const audio = new Audio(url);
                        audio.play().catch(e => console.warn('play failed', e));
                        audio.onended = () => URL.revokeObjectURL(url);
                    } catch (ex) {
                        showToast('Play failed: ' + ex.message);
                    }
                }

                // Score increment/decrement
                const scoreBtn = e.target.closest('.score-inc, .score-dec');
                if (scoreBtn) {
                    const id = scoreBtn.dataset.id;
                    if (!id) return;
                    const delta = scoreBtn.classList.contains('score-inc') ? 1 : -1;
                    scoreBtn.disabled = true;
                    try {
                        const body = new FormData(refreshForm);
                        body.append('id', id);
                        body.append('delta', delta);
                        const res = await fetch('?handler=AdjustScore', { method: 'POST', body, credentials: 'same-origin' });
                        if (!res.ok) throw new Error('Server returned ' + res.status);
                        const json = await res.json();
                        if (json?.success) {
                            document.querySelectorAll(`.score-value[data-id="${id}"]`).forEach(el => el.textContent = json.score);
                            // Update rowData
                            const item = rowData.find(r => r.Id == id);
                            if (item) item.Score = json.score;
                        } else {
                            throw new Error(json?.error || 'Unknown error');
                        }
                    } catch (ex) {
                        showToast('Score update failed: ' + ex.message);
                    } finally {
                        scoreBtn.disabled = false;
                    }
                }

                // Delete
                const deleteBtn = e.target.closest('.action-delete');
                if (deleteBtn) {
                    e.preventDefault();
                    const id = deleteBtn.dataset.id;
                    if (!id || !confirm('Eliminare questa voce?')) return;
                    try {
                        const body = new FormData(refreshForm);
                        body.append('id', id);
                        const res = await fetch('?handler=Delete', { method: 'POST', body, credentials: 'same-origin' });
                        if (!res.ok) throw new Error('Server returned ' + res.status);
                        const json = await res.json();
                        if (json?.success) {
                            rowData = rowData.filter(r => r.Id != id);
                            window.ttsVoicesGridApi?.setGridOption('rowData', rowData);
                            showToast('Voce eliminata');
                        } else {
                            throw new Error(json?.error || 'Unknown error');
                        }
                    } catch (ex) {
                        showToast('Delete failed: ' + ex.message);
                    }
                }

                // Regenerate sample
                const regenBtn = e.target.closest('.action-regenerate');
                if (regenBtn) {
                    e.preventDefault();
                    const id = regenBtn.dataset.id;
                    const voiceId = regenBtn.dataset.voiceid;
                    if (!id || !confirm('Rigenerare il sample per questa voce?')) return;
                    try {
                        const body = new FormData(refreshForm);
                        body.append('id', id);
                        const res = await fetch('?handler=Regenerate', { method: 'POST', body, credentials: 'same-origin' });
                        if (!res.ok) throw new Error('Server returned ' + res.status);
                        const json = await res.json();
                        if (json?.success) {
                            showToast('Sample rigenerato');
                            // Auto-play regenerated sample
                            if (voiceId) {
                                const resp = await fetch('?handler=Sample&voiceId=' + encodeURIComponent(voiceId));
                                if (resp.ok) {
                                    const arr = await resp.arrayBuffer();
                                    const blob = new Blob([arr], { type: resp.headers.get('content-type') || 'audio/*' });
                                    const url = URL.createObjectURL(blob);
                                    const audio = new Audio(url);
                                    audio.play().catch(() => {});
                                    audio.onended = () => URL.revokeObjectURL(url);
                                }
                            }
                        } else {
                            throw new Error(json?.error || 'Unknown error');
                        }
                    } catch (ex) {
                        showToast('Regenerate failed: ' + ex.message);
                    }
                }
            });

            function escapeAttr(text) {
                if (!text) return '';
                return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"})[m]);
            }
        });
    </script>
}
