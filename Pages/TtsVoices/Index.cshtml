@page
@model TinyGenerator.Pages.TtsVoices.IndexModel
@{
    ViewData["Title"] = "TTS Voices";
}

@{
    ViewData["PageDescription"] = "Voices per TTS e impostazioni";
}

@section Styles {
    <link rel="stylesheet" href="~/lib/datatables/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="~/lib/datatables/css/buttons.bootstrap5.min.css" />
}

<form id="ttsRefreshForm" method="post" class="d-none">
    @Html.AntiForgeryToken()
</form>

<!-- Toast for update feedback -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
    <div id="ttsToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">TTS voices</strong>
            <small class="text-muted" id="ttsToastTime"></small>
            <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="ttsToastBody">Aggiornamento completato</div>
    </div>
</div>

<div class="page-wrapper">
    <div class="d-flex mb-2 align-items-center toolbar-row">
        <form method="get" class="d-flex align-items-center" style="gap:8px;">
            <input name="search" value="@Model.Search" class="form-control form-control-sm" style="max-width:260px;" placeholder="Cerca..." />
            <button class="btn btn-sm btn-outline-secondary" type="submit">Cerca</button>
            <div class="form-check ms-2">
                <input class="form-check-input" type="checkbox" id="showDisabledChk" name="showDisabled" value="1" @(Model.ShowDisabled ? "checked" : "") />
                <label class="form-check-label" for="showDisabledChk">Mostra disabilitate</label>
            </div>
        </form>

            <div class="ms-auto d-flex gap-1">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Colonne visibili">
                    <i class="bi bi-layout-three-columns"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="ttsVoicesColsMenu" style="min-width: 220px;"></ul>
            </div>
            <button id="fixDuplicateNamesBtn" class="btn btn-sm btn-warning" type="button">Fix Duplicate Names</button>
            <form id="ttsRefreshForm2" method="post" asp-page-handler="Refresh" class="d-inline">
                @Html.AntiForgeryToken()
                <button id="refreshVoicesBtn" class="btn btn-sm btn-outline-secondary" type="submit">Sync Voices</button>
            </form>
            <a class="btn btn-sm btn-primary" href="/TtsVoices/Create">Nuovo</a>
        </div>
    </div>

    <div class="card" style="border:2px solid #ddd; border-radius:8px; padding:12px;">
        <table id="ttsVoicesTable" class="table table-sm table-striped mb-0">
            <thead>
                <tr>
                    <th data-col="actions">Azioni</th>
                    <th data-col="name"><a href="?orderBy=name&search=@Model.Search&showDisabled=@(Model.ShowDisabled ? "1" : "")">Nome</a></th>
                    <th data-col="voiceId"><a href="?orderBy=voiceId&search=@Model.Search&showDisabled=@(Model.ShowDisabled ? "1" : "")">VoiceId</a></th>
                    <th data-col="model">Model</th>
                    <th data-col="language">Language</th>
                    <th data-col="gender"><a href="?orderBy=gender&search=@Model.Search&showDisabled=@(Model.ShowDisabled ? "1" : "")">Gender</a></th>
                    <th data-col="age"><a href="?orderBy=age&search=@Model.Search&showDisabled=@(Model.ShowDisabled ? "1" : "")">Age</a></th>
                    <th data-col="confidence">Confidence</th>
                    <th data-col="score"><a href="?orderBy=score&search=@Model.Search&showDisabled=@(Model.ShowDisabled ? "1" : "")">Score</a></th>
                    <th data-col="tags">Tags</th>
                    <th data-col="template">Template</th>
                    <th data-col="archetype"><a href="?orderBy=archetype&search=@Model.Search&showDisabled=@(Model.ShowDisabled ? "1" : "")">Archetype</a></th>
                    <th data-col="notes">Notes</th>
                    <th data-col="disabled">Disabled</th>
                    <th data-col="created">Created</th>
                    <th data-col="updated">Updated</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var v in Model.Items)
                {
                    <tr>
                        <td data-col="actions">
                            <div class="d-flex align-items-center" style="gap:6px;">
                                <button type="button" class="btn btn-sm btn-outline-secondary play-voice-btn" data-voiceid="@(v.VoiceId ?? v.Name ?? string.Empty)" title="Play sample">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Azioni</button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="/TtsVoices/Edit?id=@v.Id">Edit</a></li>
                                        <li>
                                            <form method="post" asp-page-handler="Regenerate" class="m-0 px-3 py-1">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@v.Id" />
                                                <button type="submit" class="dropdown-item">Rigenera esempio</button>
                                            </form>
                                        </li>
                                        <li>
                                            <form method="post" asp-page-handler="Delete" class="m-0 px-3 py-1" onsubmit="return confirm('Eliminare questa voce?');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@v.Id" />
                                                <button type="submit" class="dropdown-item text-danger">Delete</button>
                                            </form>
                                        </li>
                                        <li><a class="dropdown-item" href="?handler=Sample&voiceId=@(Uri.EscapeDataString(v.VoiceId ?? v.Name ?? string.Empty))">Play sample (nuova scheda)</a></li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                        <td data-col="name">@v.Name</td>
                        <td data-col="voiceId">@v.VoiceId</td>
                        <td data-col="model">@v.Model</td>
                        <td data-col="language">@v.Language</td>
                        <td data-col="gender">@v.Gender</td>
                        <td data-col="age">@v.Age</td>
                        <td data-col="confidence">@v.Confidence?.ToString("0.##")</td>
                        <td data-col="score">
                            <div class="d-flex align-items-center score-control" data-id="@v.Id">
                                <button type="button" class="btn btn-sm btn-outline-secondary score-decr" title="Decrementa score">-</button>
                                <span class="mx-2 score-value">@v.Score?.ToString("0.##")</span>
                                <button type="button" class="btn btn-sm btn-outline-secondary score-incr" title="Incrementa score">+</button>
                            </div>
                        </td>
                        <td data-col="tags">@v.Tags</td>
                        <td data-col="template">@v.TemplateWav</td>
                        <td data-col="archetype">@v.Archetype</td>
                        <td data-col="notes">@v.Notes</td>
                        <td data-col="disabled">
                            <input type="checkbox" class="form-check-input toggle-disabled" data-id="@v.Id" @(v.Disabled ? "checked" : "") title="Abilita/Disabilita voce" />
                        </td>
                        <td data-col="created">@v.CreatedAt</td>
                        <td data-col="updated">@v.UpdatedAt</td>
                    </tr>
                }
            </tbody>
        </table>

        <div id="pager" class="mt-3" data-page-index="@Model.PageIndex" data-page-size="@Model.PageSize" data-total-count="@Model.TotalCount" data-search="@Model.Search" data-order-by="@Model.OrderBy" data-show-disabled="@(Model.ShowDisabled ? "1" : "")"></div>
    </div>
</div>

<script>
    (function initTtsVoicesTable(){
        if (typeof jQuery === 'undefined') { document.addEventListener('DOMContentLoaded', initTtsVoicesTable); return; }
        var scripts = ['/lib/datatables/js/jquery.dataTables.min.js','/lib/datatables/js/dataTables.bootstrap5.min.js','/lib/datatables/js/dataTables.buttons.min.js','/lib/datatables/js/buttons.bootstrap5.min.js','/lib/datatables/js/buttons.colVis.min.js'];
        var i=0; function load(u,cb){var s=document.createElement('script');s.src=u;s.onload=cb;s.onerror=cb;document.head.appendChild(s);} function next(){ if(i<scripts.length) load(scripts[i++], next); else init(); } next();
        function init(){ jQuery(document).ready(function($){ if(typeof $.fn.DataTable==='undefined'){ console.error('DataTables not loaded'); return; }
            var table = $('#ttsVoicesTable').DataTable({ dom:"<'row mb-2'<'col-sm-6'B><'col-sm-6 text-end'f>>rt<'row mt-2'<'col-sm-6'il><'col-sm-6 text-end'p>>", stateSave:true, paging:true, pageLength:25, lengthChange:true, lengthMenu:[[10,25,50,100],[10,25,50,100]], order:[[1,'asc']], columnDefs:[{ orderable:false, targets:0 }], buttons:[{ text:'<i class="bi bi-plus-circle me-1"></i>Nuovo', className:'btn btn-sm btn-primary', attr:{style:'width:auto;flex:0 0 auto;'}, action:function(){ window.location.href='/TtsVoices/Create'; } },{ extend:'colvis', text:'Colonne', className:'btn btn-sm btn-secondary' } ] });

            // Show TempData toast if present
            try {
                var message = '@(TempData["TtsVoiceMessage"] ?? string.Empty)';
                if (message && message.length > 0) {
                    var toastEl = document.getElementById('ttsToast');
                    if (toastEl) {
                        document.getElementById('ttsToastBody').innerText = message;
                        document.getElementById('ttsToastTime').innerText = new Date().toLocaleTimeString();
                        var bsToast = new bootstrap.Toast(toastEl);
                        bsToast.show();
                    }
                }
            } catch(e) { /* ignore */ }
        }); }
    })();
</script>
<script>
    // Toggle disabled via AJAX; uses antiforgery token present in hidden form
    (function(){
        const tokenEl = document.querySelector('#ttsRefreshForm input[name="__RequestVerificationToken"]');
        const token = tokenEl ? tokenEl.value : null;

        document.addEventListener('change', function(e){
            const cb = e.target.closest && e.target.closest('.toggle-disabled');
            if (!cb) return;
            const id = cb.getAttribute('data-id');
            const disabled = cb.checked;
            if (!id) return;
            cb.disabled = true;
            fetch(window.location.pathname + '?handler=ToggleDisabled', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token || ''
                },
                body: new URLSearchParams({ id: id, disabled: disabled ? 'true' : 'false' })
            }).then(r => r.json()).then(j => {
                if (j && j.success) {
                    // optionally show a small feedback
                } else {
                    alert('Errore durante aggiornamento: ' + (j && j.error ? j.error : 'unknown'));
                    // revert checkbox
                    cb.checked = !disabled;
                }
            }).catch(err => {
                console.error('Toggle error', err);
                alert('Errore durante aggiornamento');
                cb.checked = !disabled;
            }).finally(()=> cb.disabled = false);
        });

        // Also ensure the 'Mostra disabilitate' checkbox submits the form properly
        const showChk = document.getElementById('showDisabledChk');
        if (showChk){
            showChk.addEventListener('change', function(){
                // submit the parent GET form preserving search
                const form = showChk.closest('form');
                if (form && form.method && form.method.toLowerCase() === 'get'){
                    // ensure checked value is present as 1 or removed
                    if (showChk.checked) {
                        // append hidden input to ensure parameter is present
                        // set name already present; form will submit value=1
                    } else {
                        // remove value so server sees absence -> default false
                    }
                    form.submit();
                } else {
                    // fallback: reload with param
                    const url = new URL(window.location.href);
                    if (showChk.checked) url.searchParams.set('showDisabled','1'); else url.searchParams.delete('showDisabled');
                    url.searchParams.set('page','1');
                    window.location.href = url.toString();
                }
            });
        }
    })();
</script>
<script>
    // Inline score +/- handlers
    (function(){
        const tokenEl = document.querySelector('#ttsRefreshForm input[name="__RequestVerificationToken"]');
        const token = tokenEl ? tokenEl.value : null;

        document.addEventListener('click', function(e){
            const inc = e.target.closest && e.target.closest('.score-incr');
            const dec = e.target.closest && e.target.closest('.score-decr');
            const btn = inc || dec;
            if (!btn) return;
            const control = btn.closest && btn.closest('.score-control');
            if (!control) return;
            const id = control.getAttribute('data-id');
            if (!id) return;
            const delta = inc ? 1 : -1;

            // disable buttons while request in flight
            const buttons = control.querySelectorAll('button');
            buttons.forEach(b => b.disabled = true);

            fetch(window.location.pathname + '?handler=AdjustScore', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token || ''
                },
                body: new URLSearchParams({ id: id, delta: delta.toString() })
            }).then(r => r.json()).then(j => {
                if (j && j.success) {
                    // update displayed score
                    const span = control.querySelector('.score-value');
                    if (span) span.innerText = (j.score !== undefined ? j.score : (parseFloat(span.innerText || '0') + delta)).toString();
                } else {
                    alert('Errore aggiornando score: ' + (j && j.error ? j.error : 'unknown'));
                }
            }).catch(err => {
                console.error('Adjust score error', err);
                alert('Errore durante aggiornamento score');
            }).finally(()=> buttons.forEach(b => b.disabled = false));
        });
    })();
</script>
<script>
    // Global audio player reused for inline playback
    (function(){
        let currentUrl = null;
        let audio = document.createElement('audio');
        audio.id = 'ttsInlinePlayer';
        audio.style.display = 'none';
        document.body.appendChild(audio);

        async function playVoice(voiceId, btn) {
            if (!voiceId) return;
            try {
                btn.disabled = true;
                const resp = await fetch(`/TtsVoices?handler=Sample&voiceId=${encodeURIComponent(voiceId)}`);
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                if (currentUrl) URL.revokeObjectURL(currentUrl);
                currentUrl = url;
                audio.src = url;
                audio.style.display = 'block';
                await audio.play();
            } catch (err) {
                console.error('Playback error', err);
                alert('Errore durante la riproduzione: ' + (err?.message || err));
            } finally {
                btn.disabled = false;
            }
        }

        document.addEventListener('click', (e) => {
            const btn = e.target.closest && e.target.closest('.play-voice-btn');
            if (!btn) return;
            const voiceId = btn.getAttribute('data-voiceid');
            playVoice(voiceId, btn);
        });
    })();
</script>
<script>
    // Fix Duplicate Names button handler
    (function() {
        const fixBtn = document.getElementById('fixDuplicateNamesBtn');
        const tokenEl = document.querySelector('#ttsRefreshForm input[name="__RequestVerificationToken"]');
        const token = tokenEl ? tokenEl.value : null;

        if (!fixBtn) return;

        fixBtn.addEventListener('click', async function() {
            if (!confirm('Fix duplicate names by copying voice_id to name field?')) return;
            
            fixBtn.disabled = true;
            const originalText = fixBtn.textContent;
            fixBtn.textContent = 'Fixing...';

            try {
                const response = await fetch(window.location.pathname + '?handler=FixDuplicateNames', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token || ''
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('HTTP ' + response.status);
                const result = await response.json();

                if (result.success) {
                    alert('Fixed ' + (result.fixed || 0) + ' records');
                    window.location.reload();
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (err) {
                console.error('Fix error', err);
                alert('Error: ' + (err.message || String(err)));
                fixBtn.disabled = false;
                fixBtn.textContent = originalText;
            }
        });
    })();
</script>
<script>
    // Sync Voices button handler
    (function() {
        const refreshForm = document.getElementById('ttsRefreshForm2');
        const refreshBtn = document.getElementById('refreshVoicesBtn');
        const toastEl = document.getElementById('ttsToast');
        const toastBody = document.getElementById('ttsToastBody');
        const toastTime = document.getElementById('ttsToastTime');
        
        if (!refreshForm || !refreshBtn) return;
        
        refreshForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Form submit intercepted');
            
            // Disable button during request
            refreshBtn.disabled = true;
            const originalText = refreshBtn.textContent;
            refreshBtn.textContent = 'Sincronizzazione...';
            
            try {
                const formData = new FormData(refreshForm);
                const url = window.location.pathname + '?handler=Refresh';
                
                console.log('Calling:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                
                console.log('Status:', response.status);
                
                if (!response.ok) throw new Error('HTTP ' + response.status);
                
                const result = await response.json();
                console.log('Result:', result);
                
                // Show success toast
                if (toastBody && toastTime && toastEl) {
                    const now = new Date();
                    toastTime.textContent = now.toLocaleTimeString();
                    
                    let message = 'Sincronizzazione completata:\n';
                    message += 'Aggiunte: ' + (result.added || 0) + ' voci\n';
                    message += 'Aggiornate: ' + (result.updated || 0) + ' voci';
                    
                    if (result.errors && result.errors.length > 0) {
                        message += '\nErrori: ' + result.errors.length;
                    }
                    
                    toastBody.textContent = message;
                    
                    const toast = new bootstrap.Toast(toastEl);
                    toast.show();
                }
                
                // Reload page to show updated data
                setTimeout(function() {
                    window.location.reload();
                }, 2000);
                
            } catch (err) {
                console.error('Sync error', err);
                alert('Errore durante la sincronizzazione: ' + (err && err.message ? err.message : String(err)));
                refreshBtn.disabled = false;
                refreshBtn.textContent = originalText;
            }
        });
    })();
</script>